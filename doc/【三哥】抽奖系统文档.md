# ã€ä¸‰å“¥ã€‘æŠ½å¥–ç³»ç»Ÿæ–‡æ¡£

é¡¹ç›®ï¼šlucky-draw-v1

![](img/æŠ½å¥–ç³»ç»Ÿ.png)

è”ç³»ä½œè€…åŠ å…¥å¾®ä¿¡ã€QQäº¤æµç¾¤ï¼šğŸ“[è”ç³»ä»–](https://www.j3code.cn)

é¡¹ç›®è§†é¢‘åœ°å€ï¼šğŸ‘‰[æŠ½å¥–ç³»ç»Ÿï¼ˆåˆ›ä½œä¸æ˜“ï¼Œæ¬¢è¿ä¸‰è¿è½¬å‘æ”¯æŒ ğŸ˜ï¼‰](https://www.bilibili.com/video/BV1284y1r7en/?vd_source=4562ef51231a6d65b7f829e8adbfe30b)

é¡¹ç›®ä»£ç ï¼šğŸ‘‰[æŠ½å¥–ç³»ç»Ÿ](https://gitee.com/j3_baiqi/lucky-draw-v1)

é¡¹ç›®ä½“éªŒåœ°å€ï¼šğŸ‘‰[åœ¨çº¿ä½“éªŒï¼ˆ12-9è¿‡æœŸï¼‰](http://116.205.174.77/bld_app/index.html)

æ–‡æ¡£åœ¨çº¿åœ°å€ï¼šğŸ‘‰[åœ¨çº¿é˜…è¯»](https://www.j3code.cn/myFile/static/resources/document/bld/bld_sys.html)





![](img/Snipaste_2022-11-21_18-37-41.png)

# ä¸€ã€æŠ½å¥–éœ€æ±‚

ä¸€ä¸ªæŠ½å¥–é¡¹ç›®ï¼Œå®ƒå¯ä»¥åˆ†ä¸ºå‚ä¸æŠ½å¥–çš„ç”¨æˆ·å’ŒæŠ½å¥–æ´»åŠ¨çš„å‘å¸ƒè€…ã€‚æœ€ç®€å•çš„ä¸šåŠ¡é€»è¾‘å°±æ˜¯å‘å¸ƒè€…å‘å¸ƒæŠ½å¥–æ´»åŠ¨ï¼Œç”¨æˆ·å‚ä¸æ´»åŠ¨è¿›è¡ŒæŠ½å¥–ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ ¹æ®è¿™ä¸€æ¡ä¸šåŠ¡çº¿å‘æ•£æ”¹é¡¹ç›®è¯¥æœ‰é‚£äº›åŠŸèƒ½ã€‚

å…ˆæ¥åˆ†ææŠ½å¥–ç”¨æˆ·åº”è¯¥å…·æœ‰ä»€ä¹ˆåŠŸèƒ½ï¼š

1. ç™»å½• / æ³¨å†Œè´¦å·
2. ä¿®æ”¹ä¸ªäººä¿¡æ¯åŠåˆ é™¤è´¦å·
3. æŠ½å¥–æ´»åŠ¨æœç´¢
4. æŠ½å¥–æ´»åŠ¨æŸ¥çœ‹
5. å‚ä¸æŠ½å¥–
6. æŸ¥çœ‹æŠ½å¥–è®°å½•ï¼ˆä¸­å¥–å’Œæœªä¸­å¥–ï¼‰
7. é¢†å¥–
8. æ¥æ”¶å¥–å“
8. ç­‰ç­‰â€¦

æ¥ä¸‹æ¥çœ‹çœ‹å‘å¸ƒæŠ½å¥–æ´»åŠ¨çš„å‘å¸ƒè€…å…·æœ‰é‚£äº›åŠŸèƒ½

1. ç¼–å†™æŠ½å¥–æ´»åŠ¨
2. å‘å¸ƒæŠ½å¥–æ´»åŠ¨
3. ç®¡ç†å·²ç»å‘å¸ƒçš„æŠ½å¥–æ´»åŠ¨
4. åŠ¨æ€ä¿®æ”¹æ´»åŠ¨å±æ€§
5. æŸ¥çœ‹å‚ä¸æŠ½å¥–çš„ç”¨æˆ·
6. æŸ¥çœ‹ä¸­å¥–ç”¨æˆ·
7. å‘é€å¥–å“
8. ç”¨æˆ·ç®¡ç†
8. ç­‰ç­‰â€¦

ä¸‹é¢å†æ¥åˆ†æåˆ†æç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒæŠ½å¥–ã€‚

æŠ½å¥–è¿‡ç¨‹

1ã€æŠ½å¥–å‡†å¤‡ï¼ˆæ£€æŸ¥æ´»åŠ¨å¼€å§‹æ—¶é—´ã€æ£€æŸ¥æ´»åŠ¨é™åˆ¶ï¼‰

2ã€å¼€å§‹æŠ½å¥–ï¼ˆæ’é™¤æ²¡æœ‰åº“å­˜å¥–é¡¹ï¼Œå¼€å§‹æŠ½å¥–ï¼‰

3ã€å…ˆæ‰£å‡å¥–å“åº“å­˜å†æ’å…¥æŠ½å¥–è®°å½•ï¼Œæœ€åè¿”å›æŠ½å¥–ç»“æœ

å¼€å§‹æŠ½å¥–ç®—æ³•ï¼šæ ¹æ®å¥–é¡¹ä¸­çš„`æ¦‚ç‡æƒé‡`

# äºŒã€åŠŸèƒ½åˆ†æå›¾

ç”¨æˆ·ï¼š

![](img/Snipaste_2022-10-29_15-24-36.png)

å‘å¸ƒè€…ï¼š

![](img/Snipaste_2022-10-29_15-25-05.png)



# ä¸‰ã€å®ä½“

1ã€ç”¨æˆ·ï¼ˆbld_userï¼‰

id

name

phone

password

creat_time

creator

update_time

updater

```sql
CREATE TABLE `bld_user` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `username` varchar(50) COLLATE utf8mb4_german2_ci NOT NULL COMMENT 'è´¦å·',
  `password` varchar(100) COLLATE utf8mb4_german2_ci NOT NULL COMMENT 'å¯†ç ',
  `name` varchar(10) COLLATE utf8mb4_german2_ci NOT NULL COMMENT 'å§“å',
  `phone` varchar(15) COLLATE utf8mb4_german2_ci NOT NULL COMMENT 'ç”µè¯',
  `create_time` datetime DEFAULT NULL,
  `creator` varchar(10) COLLATE utf8mb4_german2_ci DEFAULT NULL,
  `update_time` datetime DEFAULT NULL,
  `updater` varchar(10) COLLATE utf8mb4_german2_ci DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_german2_ci
```

2ã€æ´»åŠ¨ï¼ˆld_activityï¼‰

id

activity_name

introduce

start_time

end_time

creat_time

creator

update_time

updater

```sql
CREATE TABLE `bld_activity` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `activity_name` varchar(100) COLLATE utf8mb4_german2_ci NOT NULL COMMENT 'æ´»åŠ¨åç§°',
  `start_time` datetime NOT NULL COMMENT 'å¼€å§‹æ—¶é—´',
  `end_time` datetime NOT NULL COMMENT 'ç»“æŸæ—¶é—´',
  `describe` varchar(500) COLLATE utf8mb4_german2_ci NOT NULL COMMENT 'æè¿°',
  `create_time` datetime DEFAULT NULL,
  `creator` varchar(10) COLLATE utf8mb4_german2_ci DEFAULT NULL,
  `update_time` datetime DEFAULT NULL,
  `updater` varchar(10) COLLATE utf8mb4_german2_ci DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_german2_ci
```

3ã€å¥–å“ï¼ˆbld_prizeï¼‰

id

prize_name

inventory

creat_time

creator

update_time

updater

```sql
CREATE TABLE `bld_prize` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `prize_name` varchar(20) COLLATE utf8mb4_german2_ci NOT NULL COMMENT 'å¥–å“åç§°',
  `inventory` int(11) NOT NULL COMMENT 'åº“å­˜',
  `money` decimal(10,0) DEFAULT NULL COMMENT 'é‡‘é¢',
  `type` int(1) DEFAULT NULL COMMENT 'ç±»å‹ï¼ˆ1ï¼šå•†å“ï¼Œ2ï¼šé‡‘é’±ï¼‰',
  `create_time` datetime DEFAULT NULL,
  `cretor` varchar(10) COLLATE utf8mb4_german2_ci DEFAULT NULL,
  `update_time` datetime DEFAULT NULL,
  `updater` varchar(10) COLLATE utf8mb4_german2_ci DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_german2_ci
```

4ã€å¥–é¡¹ï¼ˆbld_awardï¼‰

id

level

activity_id

prize_id

number

probability

creat_time

creator

update_time

updater

```sql
CREATE TABLE `bld_award` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `prize_id` bigint(20) NOT NULL COMMENT 'å¥–å“åç§°',
  `number` int(11) NOT NULL COMMENT 'æ•°é‡',
  `award_name` varchar(40) COLLATE utf8mb4_german2_ci NOT NULL COMMENT 'å¥–é¡¹åç§°',
  `probability` double NOT NULL COMMENT 'æ¦‚ç‡',
  `create_time` datetime DEFAULT NULL,
  `creator` varchar(10) COLLATE utf8mb4_german2_ci DEFAULT NULL,
  `update_time` datetime DEFAULT NULL,
  `updater` varchar(10) COLLATE utf8mb4_german2_ci DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_german2_ci
```

5ã€è§„åˆ™ï¼ˆbld_ruleï¼‰

id

activity_id

activity_join_number

max_winning_number

creat_time

creator

update_time

updater

```sql
CREATE TABLE `bld_rule` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `rule_name` varchar(50) COLLATE utf8mb4_german2_ci NOT NULL COMMENT 'è§„åˆ™åç§°',
  `max_join_number` int(11) NOT NULL COMMENT 'æœ€å¤§å¯å‚ä¸æ¬¡æ•°',
  `max_winning_number` int(11) NOT NULL COMMENT 'æœ€å¤§å¯ä¸­å¥–æ¬¡æ•°',
  `create_time` datetime DEFAULT NULL,
  `creator` varchar(10) COLLATE utf8mb4_german2_ci DEFAULT NULL,
  `update_time` datetime DEFAULT NULL,
  `updater` varchar(10) COLLATE utf8mb4_german2_ci DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_german2_ci
```

6ã€æŠ½å¥–è®°å½•ï¼ˆbld_recordï¼‰

id

activity_id

user_id

results

creat_time

creator

update_time

updater

```sql
CREATE TABLE `bld_record` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `user_id` bigint(20) NOT NULL COMMENT 'ç”¨æˆ·id',
  `activity_id` bigint(20) NOT NULL COMMENT 'æ´»åŠ¨id',
  `award_id` bigint(20) NOT NULL COMMENT 'å¥–é¡¹id',
  `is_winning` tinyint(1) DEFAULT '0' COMMENT 'æ˜¯å¦ä¸­å¥–ï¼š0æœªä¸­å¥–ï¼Œ1ä¸­å¥–',
  `state` int(11) DEFAULT NULL COMMENT 'çŠ¶æ€ï¼ˆ0ï¼Œ1ï¼Œ2ï¼Œ3ï¼‰',
  `create_time` datetime DEFAULT NULL,
  `creator` varchar(10) COLLATE utf8mb4_german2_ci DEFAULT NULL,
  `update_time` datetime DEFAULT NULL,
  `updater` varchar(10) COLLATE utf8mb4_german2_ci DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_german2_ci
```

7ã€é¢†å¥–è®°å½•ï¼ˆbld_accept_prizeï¼‰

id

draw_record_id

address

phone

state

creat_time

creator

update_time

updater

```sql
CREATE TABLE `bld_accept_prize` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `record_id` bigint(20) NOT NULL COMMENT 'æŠ½å¥–è®°å½•id',
  `phone` varchar(15) COLLATE utf8mb4_german2_ci NOT NULL COMMENT 'ç”µè¯',
  `address` varchar(500) COLLATE utf8mb4_german2_ci NOT NULL COMMENT 'åœ°å€',
  `create_time` datetime DEFAULT NULL,
  `creator` varchar(10) COLLATE utf8mb4_german2_ci DEFAULT NULL,
  `update_time` datetime DEFAULT NULL,
  `updater` varchar(10) COLLATE utf8mb4_german2_ci DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_german2_ci
```

# å››ã€COLAæ¶æ„

è¯¦ç»†å†…å®¹åœ¨èµ„æ–™ä¸­æ‰¾ã€‚

è¿™é‡Œæˆ‘ä»…ä»…ä»‹ç»ä¸€ä¸‹æœ¬é¡¹ç›®ä¸­å¯¹åº”çš„æ¨¡å—åŠå‘½å

æ¨¡å—

![](img/Snipaste_2022-11-07_10-34-11.png)

1ï¼‰é€‚é…å±‚ï¼ˆadapterï¼‰ï¼šè´Ÿè´£å¯¹å‰ç«¯å±•ç¤ºï¼ˆwebï¼Œwirelessï¼Œwapï¼‰çš„è·¯ç”±å’Œé€‚é…ï¼Œå¯¹äºä¼ ç»ŸB/Sç³»ç»Ÿè€Œè¨€ï¼Œadapterå°±ç›¸å½“äºMVCä¸­çš„controllerï¼›

2ï¼‰åº”ç”¨å±‚ï¼ˆappï¼‰ï¼šä¸»è¦è´Ÿè´£è·å–è¾“å…¥ï¼Œç»„è£…ä¸Šä¸‹æ–‡ï¼Œå‚æ•°æ ¡éªŒï¼Œè°ƒç”¨é¢†åŸŸå±‚åšä¸šåŠ¡å¤„ç†ï¼Œå¦‚æœéœ€è¦çš„è¯ï¼Œå‘é€æ¶ˆæ¯é€šçŸ¥ç­‰ã€‚å±‚æ¬¡æ˜¯å¼€æ”¾çš„ï¼Œåº”ç”¨å±‚ä¹Ÿå¯ä»¥ç»•è¿‡é¢†åŸŸå±‚ï¼Œç›´æ¥è®¿é—®åŸºç¡€å®æ–½å±‚ï¼›

3ï¼‰é¢†åŸŸå±‚ï¼ˆdomainï¼‰ï¼šä¸»è¦æ˜¯å°è£…äº†æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œå¹¶é€šè¿‡é¢†åŸŸæœåŠ¡ï¼ˆDomain Serviceï¼‰å’Œé¢†åŸŸå¯¹è±¡ï¼ˆDomain Entityï¼‰çš„æ–¹æ³•å¯¹Appå±‚æä¾›ä¸šåŠ¡å®ä½“å’Œä¸šåŠ¡é€»è¾‘è®¡ç®—ã€‚é¢†åŸŸæ˜¯åº”ç”¨çš„æ ¸å¿ƒï¼Œä¸ä¾èµ–ä»»ä½•å…¶ä»–å±‚æ¬¡ï¼›

4ï¼‰åŸºç¡€å®æ–½å±‚ï¼ˆInfrastructureï¼‰ï¼šä¸»è¦è´Ÿè´£æŠ€æœ¯ç»†èŠ‚é—®é¢˜çš„å¤„ç†ï¼Œæ¯”å¦‚æ•°æ®åº“çš„CRUDã€æœç´¢å¼•æ“ã€æ–‡ä»¶ç³»ç»Ÿã€åˆ†å¸ƒå¼æœåŠ¡çš„RPCç­‰ã€‚æ­¤å¤–ï¼Œé¢†åŸŸé˜²è…çš„é‡ä»»ä¹Ÿè½åœ¨è¿™é‡Œï¼Œå¤–éƒ¨ä¾èµ–éœ€è¦é€šè¿‡gatewayçš„è½¬ä¹‰å¤„ç†ï¼Œæ‰èƒ½è¢«ä¸Šé¢çš„Appå±‚å’ŒDomainå±‚ä½¿ç”¨ã€‚

5ï¼‰å¤–éƒ¨æ¥å£å±‚ï¼ˆclientï¼‰ï¼šå¯¹å¤–æä¾›çš„åŠŸèƒ½APIï¼Œå¦‚æœå¤–éƒ¨æ¨¡å—éœ€è¦ä½¿ç”¨æœ¬é¡¹ç›®åŠŸèƒ½åªéœ€å¼•ç”¨ client ä¸­çš„ API æ¥å£å³å¯å®ç°åŠŸèƒ½ã€‚

åŒ…

| å±‚             | åŒ…                           | è¯´æ˜                                       |
| -------------- | ---------------------------- | ------------------------------------------ |
| adapter        | web                          | å¤„ç†é¡µé¢è¯·æ±‚çš„Controller                   |
| app            | ä¸šåŠ¡åŠŸèƒ½åŒ…ï¼ˆuserã€orderï¼‰    | ä¸šåŠ¡å                                     |
| app            | assembler                    | å°† entity è½¬ä¸º vo                          |
| app            | command                      | ä¿®æ”¹ç›¸å…³çš„æ‰§è¡Œé€»è¾‘                         |
| app            | query                        | æŸ¥è¯¢ç›¸å…³çš„æ‰§è¡Œé€»è¾‘                         |
| client         | api                          | å­˜æ”¾å¯¹å¤–åŠŸèƒ½çš„api                          |
| client         | dtoï¼ˆdataã€queryï¼‰           | å¯¹å¤–è¿”å›çš„å¯¹è±¡åŠè°ƒç”¨æ–¹ä¼ å…¥çš„å‚æ•°å¯¹è±¡       |
| domain         | gateway                      | é˜²è…å±‚ï¼Œè®© Infrastructure å±‚å®ç°é€»è¾‘       |
| domain         | ä¸šåŠ¡åŠŸèƒ½åŒ…ï¼ˆentityã€å€¼å¯¹è±¡ï¼‰ | æ ¹æ®ä¸šåŠ¡åŠŸèƒ½åˆ†åŒ…ï¼ŒåŒ…ä¸­å­˜æ”¾ä¸šåŠ¡å®ä½“åŠå€¼å¯¹è±¡ |
| infrastructure | convertor                    | å­˜æ”¾å°† DO è½¬åŒ–ä¸º entityçš„ç±»                |
| infrastructure | config                       | å­˜æ”¾é…ç½®ç›¸å…³                               |
| infrastructure | gateway.impl                 | å®ç° domain å±‚çš„ gateway æ¥å£çš„å®ç°ç±»      |
| infrastructure | dataobject                   | å­˜æ”¾æ•°æ®åº“å¯¹è±¡çš„DO                         |
| infrastructure | mapper                       | mapperæ–‡ä»¶                                 |

æœ¬é¡¹ç›®ä¾èµ–åŠCOLAæ¶æ„å®è·µå›¾ï¼š

![](img/Snipaste_2022-11-07_10-55-48.png)

![](img/Snipaste_2022-11-07_10-57-04.png)

å› ä¸ºæœ¬é¡¹ç›®æ¶‰åŠåˆ°éå¸¸å¤šçš„å®ä½“é—´è½¬æ¢ï¼Œæ‰€ä»¥æ¨èä¸€ä¸ªå®ä½“é—´è½¬åŒ–æ’ä»¶ï¼š

https://www.j3code.cn/clip_web/index.html?name=j3&showLookModalOpen=true&clipContentId=186

# äº”ã€åç«¯é¡¹ç›®æ­å»º

## 5.1 åˆ›å»ºæ ¹é¡¹ç›®

åç§°ï¼šbot-lucky-draw

ç¯å¢ƒï¼šJDK11ã€Maven3.5+

åˆ é™¤ src æ–‡ä»¶ï¼Œæ ¹é¡¹ç›®ä¸éœ€è¦è¿™ä¸ª

pomé…ç½®

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.5.0</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>cn.j3code</groupId>
    <artifactId>bot-lucky-draw</artifactId>
    <version>BLD.2022.10.25.RELEASE</version>
    <packaging>pom</packaging>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>2020.0.4</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>

            <dependency>
                <groupId>com.alibaba.cloud</groupId>
                <artifactId>spring-cloud-alibaba-dependencies</artifactId>
                <version>2021.1</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <properties>
        <bld.version>BLD.2022.10.15.RELEASE</bld.version>
        <org.mapstruct.version>1.4.2.Final</org.mapstruct.version>
        <lombok.version>1.18.10</lombok.version>
        <java.version>11</java.version>
        <simbot.version>2.3.0</simbot.version>
        <maven.compiler.source>11</maven.compiler.source>
        <maven.compiler.target>${maven.compiler.source}</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
        <maven.deploy.skip>true</maven.deploy.skip>
        <cola.components.version>4.3.1</cola.components.version>
    </properties>


    <modules>
        
    </modules>


    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-surefire-plugin</artifactId>
                <version>2.19.1</version>
                <configuration>
                    <skipTests>true</skipTests>    <!--é»˜è®¤å…³æ‰å•å…ƒæµ‹è¯• -->
                </configuration>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.8.1</version>
                <configuration>
                    <source>11</source> <!-- depending on your project -->
                    <target>11</target> <!-- depending on your project -->
                    <annotationProcessorPaths>
                        <path>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                            <version>${lombok.version}</version>
                        </path>
                        <path>
                            <groupId>org.mapstruct</groupId>
                            <artifactId>mapstruct-processor</artifactId>
                            <version>${org.mapstruct.version}</version>
                        </path>
                        <!-- other annotation processors -->
                    </annotationProcessorPaths>
                </configuration>
            </plugin>
        </plugins>

        <resources>
            <!--ç¼–è¯‘é…ç½®æ–‡ä»¶-->
            <resource>
                <directory>src/main/resources</directory>
                <includes>
                    <include>**/*.*</include>
                </includes>
            </resource>
        </resources>
    </build>

</project>
```

## 5.2 åˆ›å»ºä¾èµ–æ¨¡å—

åç§°ï¼šbld-pom

åˆ é™¤ src æ–‡ä»¶ï¼Œæ ¹ä¾èµ–æ¨¡å—ä¸éœ€è¦è¿™ä¸ª

è¯¥æ¨¡å—åªæœ‰ä¸€ä¸ª pom.xml æ–‡ä»¶ï¼Œå› ä¸ºå®ƒä»…ä»…ä½œä¸ºé¡¹ç›®éœ€è¦å¼•å…¥çš„å…¬å…±ä¾èµ–æ”¯æŒã€‚

å°†é¡¹ç›®ä¸­çš„æ‰€æœ‰å…¬å…±ä¾èµ–éƒ½æ”¾åœ¨ç»Ÿä¸€çš„æ¨¡å—ä¸­ä¾¿äºç®¡ç†ï¼Œå¦‚æœå…·ä½“æœåŠ¡éœ€è¦ä¸€äº›ç‰¹å®šçš„åŠŸèƒ½ä¾èµ–åªéœ€è¦åœ¨è‡ªå·±æ¨¡å—ä¸­çš„ pom æ–‡ä»¶ä¸­æ·»åŠ å³å¯ï¼Œåä¹‹å¦‚æœä¸€ä¸ªä¾èµ–è¢«å¤šä¸ªæ¨¡å—ä½¿ç”¨ï¼Œé‚£ä¹ˆå»ºè®®æ”¾åœ¨è¿™ä¸ªå…¬å…±ä¾èµ–æ¨¡å—ã€‚

pom.xml ä¾èµ–é…ç½®

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <artifactId>bot-lucky-draw</artifactId>
        <groupId>cn.j3code</groupId>
        <version>BLD.2022.10.25.RELEASE</version>
    </parent>
    <packaging>jar</packaging>
    <artifactId>bld-pom</artifactId>

    <dependencies>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter</artifactId>
            <exclusions>
                <exclusion>
                    <artifactId>log4j-api</artifactId>
                    <groupId>org.apache.logging.log4j</groupId>
                </exclusion>
            </exclusions>
        </dependency>


        <!--web å¯åŠ¨å™¨-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <!--bootstrapé…ç½®ç”Ÿæ•ˆ-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-bootstrap</artifactId>
        </dependency>
        <!--feign-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-openfeign</artifactId>
        </dependency>
        <!--nacos-->
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
            <exclusions>
                <exclusion>
                    <groupId>com.netflix.ribbon</groupId>
                    <artifactId>ribbon</artifactId>
                </exclusion>
            </exclusions>
        </dependency>
        <!--æ’é™¤nacosä¸­çš„è´Ÿè½½å‡è¡¡ç»„ä»¶ï¼Œè‡ªå·±æ·»åŠ é…åˆfeignä½¿ç”¨-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-loadbalancer</artifactId>
        </dependency>
        <!--mysql-->
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>8.0.25</version>
        </dependency>
        <!--redis-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
        </dependency>
        <!--mybatis-plus-->
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
            <version>3.4.3.4</version>
        </dependency>
        <!--rocketmq-->
        <dependency>
            <groupId>org.apache.rocketmq</groupId>
            <artifactId>rocketmq-spring-boot-starter</artifactId>
            <version>2.2.1</version>
        </dependency>
        <!--é˜¿é‡Œè¿æ¥æ± -->
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>druid</artifactId>
            <version>1.2.8</version>
        </dependency>
        <!-- fastjsonä¾èµ– -->
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>fastjson</artifactId>
            <version>1.2.78</version>
        </dependency>
        <!--hutoolå·¥å…·åŒ…-->
        <dependency>
            <groupId>cn.hutool</groupId>
            <artifactId>hutool-all</artifactId>
            <version>5.2.0</version>
        </dependency>
        <dependency>
            <groupId>com.squareup.okhttp3</groupId>
            <artifactId>okhttp</artifactId>
        </dependency>
        <!--é‚®ä»¶-->
        <dependency>
            <groupId>com.sun.mail</groupId>
            <artifactId>javax.mail</artifactId>
            <version>1.6.2</version>
        </dependency>
        <dependency>
            <groupId>com.github.ulisesbocchio</groupId>
            <artifactId>jasypt-spring-boot-starter</artifactId>
            <version>3.0.3</version>
        </dependency>
        <!--lombok-->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <version>${lombok.version}</version>
        </dependency>
        <!--OSSæ–‡ä»¶æœåŠ¡-->
        <dependency>
            <groupId>com.aliyun.oss</groupId>
            <artifactId>aliyun-sdk-oss</artifactId>
            <version>3.10.2</version>
        </dependency>
        <!--æ ¡éªŒ-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>
        <!--è½¬æ¢-->
        <dependency>
            <groupId>org.mapstruct</groupId>
            <artifactId>mapstruct</artifactId>
            <version>${org.mapstruct.version}</version>
        </dependency>
        <!--test-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <scope>test</scope>
        </dependency>
        <!-- JWT-->
        <dependency>
            <groupId>com.auth0</groupId>
            <artifactId>java-jwt</artifactId>
            <version>4.2.1</version>
        </dependency>
    </dependencies>

</project>
```

è¿™é‡Œè¯´ä¸€ä¸‹å¼•å…¥çš„ä¾èµ–ä½œç”¨

- spring-boot-starterï¼šåŸºç¡€é¡¹ç›®æ¡†æ¶
- spring-boot-starter-webï¼šwebç›¸å…³
- spring-cloud-starter-bootstrapï¼šbootstrap.yml é…ç½®ç”Ÿæ•ˆ
- spring-cloud-starter-openfeignï¼šFeign è°ƒç”¨æ”¯æŒ
- spring-cloud-starter-alibaba-nacos-discoveryï¼šæœåŠ¡æ³¨å†Œä¸­å¿ƒ
- mysql-connector-javaï¼šæ•°æ®åº“é©±åŠ¨
- spring-boot-starter-data-redisï¼šRedis ä¾èµ–
- mybatis-plus-boot-starterï¼šæŒä¹…å±‚ä¾èµ–
- druidï¼šæ•°æ®åº“è¿æ¥æ± 
- fastjsonï¼šåºåˆ—åŒ–ä¾èµ–
- hutool-allï¼šå·¥å…·ç±»
- okhttpï¼šè¿œç¨‹httpè°ƒç”¨ä¾èµ–
- javax.mailï¼šé‚®ä»¶ä¾èµ–
- jasypt-spring-boot-starterï¼šæ•æ„Ÿå†…å®¹åŠ å¯†ä¾èµ–
- lombokï¼šæ–¹ä¾¿ç”Ÿæˆå¯¹åº”çš„getã€set
- aliyun-sdk-ossï¼šOSSæœåŠ¡
- spring-boot-starter-validationï¼šæ ¡éªŒç›¸å…³
- mapstructï¼šå¯¹è±¡è½¬æ¢
- java-jwtï¼šJWTä¾èµ–



## 5.3 åˆ›å»ºå…¬å…±æ¨¡å—

åœ¨åŠŸèƒ½æ¨¡å—ä¸­ï¼Œæˆ‘åˆåˆ†ä¸ºäº†ï¼š

- å…¬å…±é…ç½®
- åŠŸèƒ½ç»„ä»¶

è‡³äºï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆåˆ†ï¼Œè¿˜æ˜¯é‚£å¥è¯ï¼Œä¾¿äºç®¡ç†ã€‚

å…ˆåˆ›å»ºä¸€ä¸ªå…¬å…±é…ç½®æ¨¡å—

åç§°ï¼šbld-base

åˆ é™¤ src æ–‡ä»¶ï¼Œæ ¹æ¨¡å—ä¸éœ€è¦è¿™ä¸ª

pomæ–‡ä»¶é…ç½®

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <artifactId>bot-lucky-draw</artifactId>
        <groupId>cn.j3code</groupId>
        <version>BLD.2022.10.25.RELEASE</version>
    </parent>

    <packaging>pom</packaging>
    <artifactId>bld-base</artifactId>

    <modules>
        <module>bld-base-config</module>
        <module>bld-base-common</module>
    </modules>

    <dependencies>
        <dependency>
            <groupId>cn.j3code</groupId>
            <artifactId>bld-pom</artifactId>
            <version>${project.version}</version>
        </dependency>
    </dependencies>

</project>
```

æ¥ä¸‹æ¥åˆ›å»ºå…¶å­æ¨¡å—

### 5.3.1 åˆ›å»ºå…¬å…±ç»„ä»¶æ¨¡å—

åç§°ï¼šbld-base-common

ç»„ä»¶ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯éœ€è¦è¢«å½’çº³åˆ°å…·ä½“æœåŠ¡ä¸­å®Œæˆå¯¹åº”åŠŸèƒ½çš„ï¼Œæ‰€ä»¥ç±»ä¼¼è‡ªåŠ¨è£…é…ï¼Œè®©å®¹å™¨ç®¡ç†ã€‚

pom.xml æ–‡ä»¶é…ç½®

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <artifactId>bld-base</artifactId>
        <groupId>cn.j3code</groupId>
        <version>BLD.2022.10.25.RELEASE</version>
    </parent>
    <packaging>jar</packaging>
    <artifactId>bld-base-common</artifactId>

    <dependencies>
        <dependency>
            <groupId>cn.j3code</groupId>
            <artifactId>bld-base-config</artifactId>
            <version>${project.version}</version>
        </dependency>
    </dependencies>


</project>
```

### 5.3.2 åˆ›å»ºå…¬å…±é…ç½®æ¨¡å—

åç§°ï¼šbld-base-config

é…ç½®ï¼Œè¯¥æ¨¡å—æ˜¯åšåŠŸèƒ½é…ç½®ç®¡ç†æœ‰ymlã€utilsã€enumç­‰ï¼Œå¯ä»¥ä¸è¢«å®¹å™¨ç®¡ç†ä½†åˆèƒ½åŠ è½½åˆ°classpathä¸­æ‰€å¼•ç”¨åˆ°ã€‚

pom.xml æ–‡ä»¶é…ç½®

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <artifactId>bld-base</artifactId>
        <groupId>cn.j3code</groupId>
        <version>BLD.2022.10.25.RELEASE</version>
    </parent>
    <packaging>jar</packaging>
    <artifactId>bld-base-config</artifactId>

    <dependencies>

    </dependencies>
</project>
```

## 5.4 åˆ›å»ºç½‘å…³æ¨¡å—

åç§°ï¼šbld-gateway

åç»­é¡¹ç›®çš„æ‰€æœ‰è¯·æ±‚å…¥å£éƒ½è¦èµ°ç½‘å…³ã€‚

pom.xmlæ–‡ä»¶é…ç½®

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <artifactId>bot-lucky-draw</artifactId>
        <groupId>cn.j3code</groupId>
        <version>BLD.2022.10.25.RELEASE</version>
    </parent>
    <packaging>jar</packaging>
    <artifactId>bld-gateway</artifactId>

    <dependencies>
        <dependency>
            <groupId>cn.j3code</groupId>
            <artifactId>bld-pom</artifactId>
            <version>${project.version}</version>
            <exclusions>
                <exclusion>
                    <groupId>org.springframework.boot</groupId>
                    <artifactId>spring-boot-starter-web</artifactId>
                </exclusion>
                <exclusion>
                    <groupId>mysql</groupId>
                    <artifactId>mysql-connector-java</artifactId>
                </exclusion>
                <!--mybatis-plus-->
                <exclusion>
                    <groupId>com.baomidou</groupId>
                    <artifactId>mybatis-plus-boot-starter</artifactId>
                </exclusion>
                <!--é˜¿é‡Œè¿æ¥æ± -->
                <exclusion>
                    <groupId>com.alibaba</groupId>
                    <artifactId>druid</artifactId>
                </exclusion>
            </exclusions>
        </dependency>

        <!--ç½‘å…³-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-gateway</artifactId>
        </dependency>

        <dependency>
            <groupId>cn.j3code</groupId>
            <artifactId>bld-base-config</artifactId>
            <version>${project.version}</version>
        </dependency>
    </dependencies>


    <build>
        <plugins>
            <!-- Springbootæ‰“åŒ…æ’ä»¶ã€‚ä½¿ç”¨ mvn package è¿›è¡Œæ‰“åŒ…ã€‚ -->
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <version>2.5.3</version>
                <configuration>
                    <!-- mainæ–¹æ³•æ‰€åœ¨ç±»ã€‚ -->
                    <mainClass>cn.j3code.bldgateway.BldGatewayApplication</mainClass>
                </configuration>
                <executions>
                    <execution>
                        <goals>
                            <goal>repackage</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
        </plugins>
        <resources>
            <!--ç¼–è¯‘é…ç½®æ–‡ä»¶-->
            <resource>
                <directory>src/main/resources</directory>
                <includes>
                    <include>**/*.*</include>
                </includes>
            </resource>
        </resources>
    </build>
</project>
```

## 5.5 åˆ›å»ºä¸šåŠ¡æœåŠ¡è·Ÿæ¨¡å—

åç§°ï¼šbld-service

åç»­é¡¹ç›®ä¸­æ‰€æœ‰å’Œä¸šåŠ¡ç›¸å…³çš„æ¨¡å—ï¼Œéƒ½æ”¾åœ¨è¿™é‡Œï¼Œæ ¹æ®åŠŸèƒ½ä¸åŒåˆ›å»ºå¯¹åº”çš„å­æ¨¡å—ã€‚

pom.xml æ–‡ä»¶é…ç½®

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <artifactId>bot-lucky-draw</artifactId>
        <groupId>cn.j3code</groupId>
        <version>BLD.2022.10.25.RELEASE</version>
    </parent>
    <packaging>pom</packaging>
    <artifactId>bld-service</artifactId>

    <modules>

    </modules>

    <dependencies>
        <dependency>
            <groupId>cn.j3code</groupId>
            <artifactId>bld-base-common</artifactId>
            <version>${project.version}</version>
        </dependency>
    </dependencies>

</project>
```

## 5.6 å„ä¸ªæ¨¡å—é—´çš„ä¾èµ–å…³ç³»å›¾

![](img/Snipaste_2022-11-08_14-51-25.png)

# å…­ã€ç»Ÿä¸€è¿”å›ç»“æœå°è£…

ä¸ºä»€ä¹ˆè¦åšè¿™ä¸ªï¼Œæ–¹ä¾¿å‰åç«¯æ•°æ®è”è°ƒã€‚

åç«¯è¿”å›ç»Ÿä¸€çš„æ•°æ®æ ¼å¼ï¼Œå‰ç«¯åˆ™æ–¹ä¾¿æ¥æ”¶æ•°æ®å’Œå›æ˜¾æ•°æ®ï¼Œæå‡å¿«å‘é€Ÿåº¦ã€‚

ç»Ÿä¸€è¿”å›æ ¼å¼ä¸€èˆ¬åŒ…æ‹¬ä¸‹é¢å‡ ä¸ªå­—æ®µ

- ç»“æœ
- è¿”å›ç 
- æ¶ˆæ¯ï¼ˆå¯é€‰ï¼‰
- æ•°æ®

æ ¼å¼

```json
{
    "result": true,
    "code": 200,
    "message": "æ“ä½œæˆåŠŸï¼"
    "data": Object
}
```

ä»£ç ä½“ç°

1ã€ç¼–å†™ç»“æœä¿¡æ¯å¯¹è±¡

```java
@Getter
public abstract class ResultInfo implements Serializable {

    protected Boolean result;
    protected Integer code;
    @JsonInclude(JsonInclude.Include.NON_NULL)
    protected String message;

    protected ResultInfo(Boolean result, Integer code, String message) {
        this.result = result;
        this.code = code;
        this.message = message;
    }

}
```

2ã€ç¼–å†™æˆåŠŸç»“æœé›†å¯¹è±¡

```java
@Builder
@Getter
@ToString
public class SuccessInfo extends ResultInfo {

    protected static final Integer DEFAULT_CODE = 20000;
    protected static final String DEFAULT_MESSAGE = "æ“ä½œæˆåŠŸ";

    @JsonInclude(JsonInclude.Include.NON_NULL)
    protected Object data;


    protected SuccessInfo(Object data) {
        super(true, DEFAULT_CODE, DEFAULT_MESSAGE);
        this.data = data;
    }
}
```

3ã€ç¼–å†™å¤±è´¥ç»“æœé›†å¯¹è±¡

```java
@Builder
@Getter
@ToString
public class FailInfo extends ResultInfo {

    protected static final Integer DEFAULT_CODE = 50000;
    protected static final String DEFAULT_MESSAGE = "æ“ä½œå¤±è´¥";

    @JsonInclude(JsonInclude.Include.NON_NULL)
    private final String exception;

    protected FailInfo(String exception) {
        super(false, DEFAULT_CODE, DEFAULT_MESSAGE);
        this.exception = exception;
    }
    public FailInfo(Integer code, String exception) {
        super(false, code, DEFAULT_MESSAGE);
        this.exception = exception;
    }

}
```

4ã€ç¼–å†™éœ€è¦å¤„ç†ç»“æœé›†çš„æ³¨è§£

```java
@Retention(RetentionPolicy.RUNTIME)
@Target({ElementType.TYPE, ElementType.METHOD})
@Documented
@RestController
public @interface ResponseResult {
    boolean ignore() default false;
}
```

ä»¥åï¼Œå¦‚æœéœ€è¦å°† controller ä¸­çš„æ•°æ®é€šè¿‡ç»Ÿä¸€ç»“æœè¿”å›å‡ºå»ï¼Œå°±éœ€è¦åœ¨ç±»æˆ–æ–¹æ³•ä¸Šæ ‡æ³¨è¯¥æ³¨è§£æ‰ä¼šç”Ÿæ•ˆã€‚

4ã€ç¼–å†™è¿”å›ç»“æœå¤„ç†å™¨

```java
@Slf4j
@ControllerAdvice
@AllArgsConstructor
public class ResponseResultHandler implements ResponseBodyAdvice<Object> {
    @Override
    public boolean supports(MethodParameter methodParameter, Class<? extends HttpMessageConverter<?>> aClass) {

        final var method = methodParameter.getMethod();
        final var clazz = Objects.requireNonNull(method, "method is null").getDeclaringClass();

        // åªå¤„ç† ResponseResult æ ‡æ³¨çš„ç±»æˆ–æ–¹æ³•
        var annotation = clazz.getAnnotation(ResponseResult.class);
        if (Objects.isNull(annotation)) {
            annotation = method.getAnnotation(ResponseResult.class);
        }

        //å¦‚æœæ˜¯FileSystemResource åˆ™ä¸æ‹¦æˆª
        if (method.getAnnotatedReturnType().getType().getTypeName()
                .equals(FileSystemResource.class.getTypeName())) {
            return false;
        }
        return annotation != null && !annotation.ignore();
    }

    @SneakyThrows
    @Override
    public Object beforeBodyWrite(Object data, MethodParameter methodParameter, MediaType mediaType, Class<? extends HttpMessageConverter<?>> aClass, ServerHttpRequest serverHttpRequest, ServerHttpResponse serverHttpResponse) {
        var successInfo = SuccessInfo.builder()
                .data(data)
                .build();
        if ((data instanceof String) && !MediaType.APPLICATION_XML_VALUE.equals(mediaType.toString())) {
            ObjectMapper om = new ObjectMapper();
            serverHttpResponse.getHeaders().set("Content-Type", "application/json");
            return om.writeValueAsString(successInfo);
        }

        if (Objects.isNull(data) && MediaType.TEXT_HTML_VALUE.equals(mediaType.toString())) {
            ObjectMapper om = new ObjectMapper();
            serverHttpResponse.getHeaders().set("Content-Type", "application/json");
            return om.writeValueAsString(successInfo);
        }

        return successInfo;
    }
}
```

è¯¥ç»“æœå¤„ç†ç±»å®ç°äº† ResponseBodyAdvice æ¥å£å¹¶ä¸”æ ‡æ³¨äº† @ControllerAdvice æ³¨è§£ï¼Œç›¸å½“äºä¸€ä¸ªè¿”å›ç»“æœé›†çš„åˆ‡é¢ï¼Œsupports æ–¹æ³•è¡¨ç¤ºæ˜¯å¦éœ€è¦å¢å¼ºï¼ŒbeforeBodyWrite è¡¨ç¤ºå¢å¼ºæ–¹æ³•ã€‚

æ–¹æ³•å®ç°é€»è¾‘ï¼š

1. å…ˆ supports  æ–¹æ³•åˆ¤æ–­ Controller ä¸­çš„ç±»æˆ–æ–¹æ³•ä¸Šæ˜¯å¦æ ‡æ³¨ @ResponseResult æ³¨è§£ï¼Œæœ‰åˆ™è¿”å› trueï¼ˆå¢å¼ºï¼‰ åä¹‹ falseï¼ˆä¸å¢å¼ºï¼‰
2. è¿”å›å¢å¼ºçš„åˆ™ä¼šæ¥åˆ° beforeBodyWrite æ–¹æ³•å¤„ç†ç»“æœé›†ï¼Œåœ¨æ­¤æˆ‘ä»¬å°±å¯ä»¥åˆ›å»ºä¸€ä¸ªæˆåŠŸçš„ç»“æœé›†å°†è¿”å›ç»“æœè®¾ç½®åˆ°æˆåŠŸå¯¹è±¡çš„ data ä¸­ï¼Œæœ€åé€šè¿‡ JSON åºåˆ—åŒ–è¿”å›å‡ºå»ã€‚

# ä¸ƒã€ç»Ÿä¸€å¼‚å¸¸å¤„ç†

å½“ç³»ç»Ÿå‡ºç°é”™è¯¯æ—¶ï¼Œç»™å‰ç«¯è¿”å›ä¸€ä¸ªç»Ÿä¸€çš„é”™è¯¯æ ¼å¼éå¸¸é‡è¦ï¼Œè¿™é‡Œçš„é“ºå«æ˜¯å…ˆæŠŠç»Ÿä¸€ç»“æœé›†çš„å¤„ç†å®Œæˆå¥½ã€‚

å½“åç«¯å‡ºé”™æ˜¯ï¼Œç¨‹åºå°±è¦è¿”å›å‰ç«¯ä¸€ä¸ªé”™è¯¯çš„ç»“æœé›†å¯¹è±¡äº† FailInfo ï¼Œé‚£è°æ¥ç”Ÿæˆ FailInfo å¯¹è±¡å¹¶è¿”å›å‘¢ï¼

@ControllerAdvice æ³¨è§£åˆå‡ºç°äº†ã€‚

ç¼–å†™ä¸€ä¸ªé”™è¯¯å¤„ç†ç±»ï¼Œå¦‚ä¸‹ï¼š

```java
@Slf4j
@ControllerAdvice
public class SysExceptionHandler {

    /**
     * æœ€å¤§çš„å…œåº•é”™è¯¯å¤„ç†
     *
     * @param ex
     * @return
     */
    @ResponseBody
    @ExceptionHandler(value = Exception.class)
    public FailInfo exception(Exception ex) {
        log.error("Exception_info:{}", ex.getMessage());
        log.error("Exception_info:", ex);
        var failInfo = FailInfo.builder().exception(ex.getMessage()).build();
        return failInfo;
    }

    /**
     * å‚æ•°ç»‘å®šé”™è¯¯
     *
     * @param ex
     * @return
     */
    @ResponseBody
    @ExceptionHandler(value = BindException.class)
    public FailInfo exception(BindException ex) {
        String defaultMessage = Objects.requireNonNull(ex.getBindingResult().getFieldError()).getDefaultMessage();
        log.error("Exception_info:{}", defaultMessage);
        log.error("Exception_info:", ex);
        var failInfo = FailInfo.builder().exception(defaultMessage).build();
        return failInfo;
    }


    @ResponseBody
    @ExceptionHandler(value = BldException.class)
    public FailInfo sysException(Exception ex) {
        log.error("Exception_info:{}", ex.getMessage());
        log.error("Exception_info:", ex);
        var failInfo = FailInfo.builder().exception(ex.getMessage()).build();
        return failInfo;
    }

    @ResponseBody
    @ExceptionHandler(value = NotAuthException.class)
    public FailInfo notAuthException(Exception ex) {
        log.error("Exception_info:{}", ex.getMessage());
        log.error("Exception_info:", ex);
        return new FailInfo(401, ex.getMessage());
    }

    @ResponseBody
    @ExceptionHandler(value = MysqlDataTruncation.class)
    public FailInfo mysqlDataTruncation(Exception ex) {
        log.error("Exception_info:{}", ex.getMessage());
        log.error("Exception_info:", ex);
        return new FailInfo(500, ex.getMessage());
    }

    @ResponseBody
    @ExceptionHandler(value = DataIntegrityViolationException.class)
    public FailInfo dataIntegrityViolationException(Exception ex) {
        log.error("Exception_info:{}", ex.getMessage());
        log.error("Exception_info:", ex);
        String message = ex.getMessage();
        String[] split = message.split("\r\n###");
        for (String str : split) {
            if (str.trim().isBlank() || str.trim().contains("Error")){
                continue;
            }
            String[] split1 = str.split(":");
            if (split1.length > 0) {
                message = split1[split1.length - 1].trim();
            }
        }
        return new FailInfo(500, message);
    }

}
```

è¿™é‡Œå¾ˆç®€å•ï¼Œå°±æ˜¯å†™ä¸€ä¸ªç±»ï¼Œç„¶åæ ‡æ³¨ @ControllerAdvice æ³¨è§£ï¼Œå½“ç³»ç»Ÿéœ€è¦å¤„ç†é‚£ç§ç±»å‹çš„é”™è¯¯ï¼Œå°±ç¼–å†™ä¸€ä¸ªæ–¹æ³•ï¼Œæ–¹æ³•ä¸Šæ ‡æ³¨ä¸¤ä¸ªæ³¨è§£  @ExceptionHandler(value =å¼‚å¸¸ç±»å‹) å’Œ @ResponseBody ï¼Œè¿™æ ·ï¼Œå½“å‡ºç°å¯¹åº”ç±»å‹çš„é”™è¯¯æ—¶ï¼Œç³»ç»Ÿä¼šè°ƒç”¨è¯¥æ–¹æ³•å¹¶æ‰§è¡Œç›¸å…³é€»è¾‘ï¼Œæœ€ç»ˆé€šè¿‡ @ResponseBody æ³¨è§£è¿”å› JSON æ•°æ®å‡ºå»ã€‚

# å…«ã€å…¶å®ƒé…ç½®å¤„ç†

## 8.1 yml é…ç½®

å¯¹äºå¤šä¸ªæ¨¡å—ï¼Œå¦‚æœæ¯ä¸ªæ¨¡å—éƒ½ç»´æŠ¤ä¸€ä»½ç›¸åŒçš„é…ç½®ï¼Œé‚£å°±éå¸¸ä¸åˆ©äºç®¡ç†ã€‚å½“æˆ‘ä»¬éœ€è¦ä¿®æ”¹é…ç½®æ—¶ï¼Œåˆ™éœ€è¦åŒæ—¶ä¿®æ”¹å¤šä»½é…ç½®æ–‡ä»¶ï¼Œéå¸¸ç¹çã€‚

æ‰€ä»¥ï¼Œç»Ÿä¸€çš„é…ç½®æ¨¡å—å°±å‡ºç°äº†ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥ç”¨Nacosçš„é…ç½®ä¸­å¿ƒï¼‰bld-base-config ã€‚

åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å°†ç¯å¢ƒåˆ†ä¸º dev å’Œ prod ã€‚åœ¨ä¸åŒçš„ç¯å¢ƒä¸­ï¼Œåªæœ‰ IP å’Œç«¯å£ä¸ä¸€æ ·ï¼Œæ‰€ä»¥æˆ‘åšäº†ä¸‹é¢çš„é…ç½®æ–‡ä»¶å…³ç³»ã€‚

1ã€application-dev.yml

ä¸»è¦å°±æ˜¯é…ç½® dev ç¯å¢ƒä¸‹çš„ IP å’Œç«¯å£

```yaml
bld:
  host: 127.0.0.1
  mysql-port: 3306
  nacos-port: 8848
  redis-port:
  rocketmq-port:
#nacos
nacos:
  #dev
  namespace: 79622650-2ad0-4651-945e-82929157836f
#database
DB_HOST: ${bld.host}:${bld.mysql-port}
DB_NAME: bld
DB_USERNAME: root
DB_PASSWORD: root
```

2ã€application-prod.yml

ä¸»è¦å°±æ˜¯é…ç½® prod ç¯å¢ƒä¸‹çš„ IP å’Œç«¯å£

```yaml
bld:
  host: çº¿ä¸Šé…ç½®
  mysql-port: çº¿ä¸Šé…ç½®
  nacos-port: çº¿ä¸Šé…ç½®
  redis-port: çº¿ä¸Šé…ç½®
  rocketmq-port: çº¿ä¸Šé…ç½®
#nacos
nacos:
  namespace: çº¿ä¸Šé…ç½®
#database
DB_HOST: çº¿ä¸Šé…ç½®
DB_NAME: çº¿ä¸Šé…ç½®
DB_USERNAME: çº¿ä¸Šé…ç½®
DB_PASSWORD: çº¿ä¸Šé…ç½®
```

3ã€application-mybatisplus.yml

ç»Ÿä¸€æŒä¹…å±‚é…ç½®

```yaml
#datasource
spring.datasource:
  type: com.alibaba.druid.pool.DruidDataSource
  driverClassName: com.mysql.cj.jdbc.Driver
  url: jdbc:mysql://${DB_HOST}/${DB_NAME}?useUnicode=true&useSSL=false&characterEncoding=utf8&allowMultiQueries=true&serverTimezone=Asia/Shanghai
  username: ${DB_USERNAME}
  password: ${DB_PASSWORD}
  #   æ•°æ®æºå…¶ä»–é…ç½®
  druid:
    #     é…ç½®åˆå§‹åŒ–å¤§å°ã€æœ€å°ã€æœ€å¤§çº¿ç¨‹æ•°
    initialSize: 5
    minIdle: 5
    #     CPUæ ¸æ•°+1ï¼Œä¹Ÿå¯ä»¥å¤§äº›ä½†ä¸è¦è¶…è¿‡20ï¼Œæ•°æ®åº“åŠ é”æ—¶è¿æ¥è¿‡å¤šæ€§èƒ½ä¸‹é™
    maxActive: 20
    #     æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œå†…ç½‘ï¼š800ï¼Œå¤–ç½‘ï¼š1200ï¼ˆä¸‰æ¬¡æ¡æ‰‹1sï¼‰
    maxWait: 60000
    timeBetweenEvictionRunsMillis: 60000
    #     é…ç½®ä¸€ä¸ªè¿æ¥åœ¨æ± ä¸­æœ€å¤§ç©ºé—´æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’
    minEvictableIdleTimeMillis: 300000
    validationQuery: SELECT 1
    testWhileIdle: true
    #     è®¾ç½®ä»è¿æ¥æ± è·å–è¿æ¥æ—¶æ˜¯å¦æ£€æŸ¥è¿æ¥æœ‰æ•ˆæ€§ï¼Œtrueæ£€æŸ¥ï¼Œfalseä¸æ£€æŸ¥
    testOnBorrow: true
    #     è®¾ç½®ä»è¿æ¥æ± å½’è¿˜è¿æ¥æ—¶æ˜¯å¦æ£€æŸ¥è¿æ¥æœ‰æ•ˆæ€§ï¼Œtrueæ£€æŸ¥ï¼Œfalseä¸æ£€æŸ¥
    testOnReturn: true
    #     å¯ä»¥æ”¯æŒPSCacheï¼ˆæå‡å†™å…¥ã€æŸ¥è¯¢æ•ˆç‡ï¼‰
    poolPreparedStatements: true
    #   é…ç½®ç›‘æ§ç»Ÿè®¡æ‹¦æˆªçš„filtersï¼Œå»æ‰åç›‘æ§ç•Œé¢sqlæ— æ³•ç»Ÿè®¡ï¼Œ'wall'ç”¨äºé˜²ç«å¢™
    filters: stat,wall,log4j
    #     ä¿æŒé•¿è¿æ¥
    keepAlive: true
    maxPoolPreparedStatementPerConnectionSize: 20
    useGlobalDataSourceStat: true
    connectionProperties: druid.stat.mergeSql=true;druid.stat.slowSqlMillis=500

mybatis-plus:
  map-underscore-to-camel-case: true
  type-enums-package: cn.j3code.bldbase.enums,cn.j3code.botqq.enums,cn.j3code.lucky.enums

mybatis-plus.configuration.log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
```

4ã€application-nacos.yml

ç»Ÿä¸€æ³¨å†Œä¸­å¿ƒé…ç½®

```yaml
#nacos
spring:
  cloud:
    nacos:
      server-addr: ${bld.host}:${bld.nacos-port}
      discovery:
        username: nacos
        password: nacos
        # loc
        namespace: ${nacos.namespace}
```

5ã€application-redis.yml

ç»Ÿä¸€redisé…ç½®

```yaml
spring:
  redis:
    host: ${bld.host}
    port: ${bld.redis-port}
    password: ENC(juMGYjB+nMtHUZqjoVS+OeL77HdLS4NTLnLxHEPei2dJ6phF50LfniO8ksf4FT+y)
```

6ã€application-rocketmq.yml

ç»Ÿä¸€MQé…ç½®

```yaml
#rocketmqé…ç½®ä¿¡æ¯
rocketmq:
  #nameserviceæœåŠ¡å™¨åœ°å€ï¼ˆå¤šä¸ªä»¥è‹±æ–‡é€—å·éš”å¼€ï¼‰
  name-server: ${bld.host}:${bld.rocketmq-port}
  #ç”Ÿäº§è€…é…ç½®
  producer:
    group: clip-producer-group
  #æ¶ˆè´¹è€…é…ç½®
  consumer:
    #ç»„å
    group: clip-consumer-group
    #ç›‘å¬ä¸»é¢˜
    topic: clip-loc
```

7ã€application-dev-gateway.yml

ç»Ÿä¸€ dev ç½‘å…³é…ç½®

```yaml
spring:
  cloud:
    # cn.baiqi.gateway ç½‘å…³
    gateway:
      globalcors:
        corsConfigurations:
          '[/**]':
            allowedOrigins: "*"
            allowedMethods: "*"
            allowedHeaders: "*"
      routes:
        - id: bld-bot-qq
          uri: http://127.0.0.1:7212/
          predicates:
            - Path=/bld-bot-qq/**
          filters:
            # 1è¡¨ç¤ºè¿‡æ»¤ä¸€ä¸ªè·¯å¾„
            - StripPrefix=1
        - id: bld-lucky
          uri: http://127.0.0.1:7214/
          predicates:
            - Path=/bld-lucky/**
          filters:
            # 1è¡¨ç¤ºè¿‡æ»¤ä¸€ä¸ªè·¯å¾„
            - StripPrefix=1

# å¿½ç•¥ url æ‹¦æˆª
bld.gateway:
    ignoreUrlSet:
      - /user/login
      - /user/register
    authorization: Authorization
```

8ã€application-prod-gateway.yml

```yaml
spring:
  cloud:
    # cn.baiqi.gateway ç½‘å…³
    gateway:
      globalcors:
        corsConfigurations:
          '[/**]':
            allowedOrigins: "*"
            allowedMethods: "*"
            allowedHeaders: "*"
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true
```

å¦‚æœæŸä¸ªå…·ä½“æœåŠ¡éœ€è¦é…ç½®å¯¹åº”çš„åŠŸèƒ½åˆ™åªéœ€å¦‚ä¸‹é…ç½®å³å¯ï¼š

ä¸šåŠ¡æœåŠ¡é…ç½®æ–‡ä»¶

application.yml

```yaml
spring:
  profiles:
    active: dev,mybatisplus,nacos
```

å¦‚æœä¸ç”Ÿæ•ˆåˆ™åœ¨æ¨¡å— pom æ–‡ä»¶ä¸­åŠ å…¥è¿™ä¸ªé…ç½®

```xml
<build>
    <resources>
        <!--ç¼–è¯‘é…ç½®æ–‡ä»¶-->
        <resource>
            <directory>src/main/resources</directory>
            <includes>
                <include>**/*.*</include>
            </includes>
        </resource>
    </resources>
</build>
```

## 8.2 MyBatisPlusåˆ†é¡µæ’ä»¶

æŒ‰ç…§å®˜ç½‘é…ç½®çš„

```java
@Configuration
public class MyBatisPlusConfig {

    // æœ€æ–°ç‰ˆ
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        return interceptor;
    }

}
```

## 8.3 MyBatisPluså­—æ®µå¡«å……é…ç½®

```java
@Slf4j
@Component
public class MyMetaObjectHandler implements MetaObjectHandler {

    @Override
    public void insertFill(MetaObject metaObject) {
        // èµ·å§‹ç‰ˆæœ¬ 3.3.3(æ¨è)
        this.strictInsertFill(metaObject, "createTime", LocalDateTime::now, LocalDateTime.class);
        // èµ·å§‹ç‰ˆæœ¬ 3.3.3(æ¨è)
        this.strictInsertFill(metaObject, "updateTime", LocalDateTime::now, LocalDateTime.class);
    }

    @Override
    public void updateFill(MetaObject metaObject) {
        // èµ·å§‹ç‰ˆæœ¬ 3.3.3(æ¨è)
        this.strictUpdateFill(metaObject, "updateTime", LocalDateTime::now, LocalDateTime.class);
    }

}
```

## 8.4 mapperæ‰«æé…ç½®

```java
@Slf4j
@Configuration
@MapperScan("cn.j3code.*.mapper")
public class MapperScanConfig {
}
```

è¿™ä¸ªé…ç½®å› é¡¹ç›®è€Œå¼‚ï¼Œå¦‚æœé¡¹ç›®æ¨¡å—éå¸¸å¤šï¼Œè€Œæ¯ä¸ªæ¨¡å—çš„ mapper åŒ…è·¯å¾„éƒ½åªæœ‰ä¸€å±‚ä¸åŒåˆ™å¯ä»¥åšç»Ÿä¸€çš„æ‰«æé…ç½®ã€‚

## 8.5 localDateTime åºåˆ—åŒ–å™¨

```java
@Configuration
public class LocalDateTimeSerializerConfig {

    // localDateTime åºåˆ—åŒ–å™¨
    @Bean
    public LocalDateTimeSerializer localDateTimeSerializer() {
        return new LocalDateTimeSerializer(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"));
    }

    @Bean
    public Jackson2ObjectMapperBuilderCustomizer jackson2ObjectMapperBuilderCustomizer() {
        return builder -> builder.serializerByType(LocalDateTime.class, localDateTimeSerializer());
    }

}
```

## 8.6 redisåºåˆ—åŒ–é…ç½®

```java
@Slf4j
@Configuration
@EnableCaching
public class RedisConfig extends CachingConfigurerSupport {

    // è¿™æ˜¯ç¼“å­˜æœ‰æ•ˆæœŸ ä¸€å¤©
    private Duration timeToLive = Duration.ofDays(1);

    /**
     * é…ç½®Jackson2JsonRedisSerializeråºåˆ—åŒ–ç­–ç•¥
     * */
    private Jackson2JsonRedisSerializer<Object> serializer() {
        // ä½¿ç”¨Jackson2JsonRedisSerializeræ¥åºåˆ—åŒ–å’Œååºåˆ—åŒ–redisçš„valueå€¼
        Jackson2JsonRedisSerializer<Object> jackson2JsonRedisSerializer = new Jackson2JsonRedisSerializer<>(Object.class);
        ObjectMapper objectMapper = new ObjectMapper();

        objectMapper.registerModule(new JavaTimeModule());
        objectMapper.registerModule(new Jdk8Module());

        // æŒ‡å®šè¦åºåˆ—åŒ–çš„åŸŸï¼Œfield,getå’Œset,ä»¥åŠä¿®é¥°ç¬¦èŒƒå›´ï¼ŒANYæ˜¯éƒ½æœ‰åŒ…æ‹¬privateå’Œpublic
        objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);

        objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);

        // æŒ‡å®šåºåˆ—åŒ–è¾“å…¥çš„ç±»å‹ï¼Œç±»å¿…é¡»æ˜¯éfinalä¿®é¥°çš„ï¼Œfinalä¿®é¥°çš„ç±»ï¼Œæ¯”å¦‚String,Integerç­‰ä¼šè·‘å‡ºå¼‚å¸¸
        objectMapper.activateDefaultTyping(LaissezFaireSubTypeValidator.instance, ObjectMapper.DefaultTyping.NON_FINAL);

        jackson2JsonRedisSerializer.setObjectMapper(objectMapper);
        return jackson2JsonRedisSerializer;
    }


    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory redisConnectionFactory) {
        RedisTemplate<String, Object> redisTemplate = new RedisTemplate<>();
        redisTemplate.setConnectionFactory(redisConnectionFactory);
        // ç”¨Jackson2JsonRedisSerializeræ¥åºåˆ—åŒ–å’Œååºåˆ—åŒ–redisçš„valueå€¼
        redisTemplate.setValueSerializer(serializer());

        StringRedisSerializer stringRedisSerializer = new StringRedisSerializer();
        // ä½¿ç”¨StringRedisSerializeræ¥åºåˆ—åŒ–å’Œååºåˆ—åŒ–redisçš„keyå€¼
        redisTemplate.setKeySerializer(stringRedisSerializer);

        // hashçš„keyä¹Ÿé‡‡ç”¨Stringçš„åºåˆ—åŒ–æ–¹å¼
        redisTemplate.setHashKeySerializer(stringRedisSerializer);
        // hashçš„valueåºåˆ—åŒ–æ–¹å¼é‡‡ç”¨jackson
        redisTemplate.setHashValueSerializer(serializer());
        redisTemplate.afterPropertiesSet();
        return redisTemplate;
    }




    @Bean
    public CacheManager cacheManager(RedisConnectionFactory factory) {
        RedisSerializer<String> redisSerializer = new StringRedisSerializer();
        // é…ç½®åºåˆ—åŒ–ï¼ˆè§£å†³ä¹±ç çš„é—®é¢˜ï¼‰
        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()
                // ç¼“å­˜æœ‰æ•ˆæœŸ
                .entryTtl(timeToLive)
                // ä½¿ç”¨StringRedisSerializeræ¥åºåˆ—åŒ–å’Œååºåˆ—åŒ–redisçš„keyå€¼
                .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(redisSerializer))
                // ä½¿ç”¨Jackson2JsonRedisSerializeræ¥åºåˆ—åŒ–å’Œååºåˆ—åŒ–redisçš„valueå€¼
                .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(serializer()))
                // ç¦ç”¨ç©ºå€¼
                .disableCachingNullValues();

        return RedisCacheManager.builder(factory)
                .cacheDefaults(config)
                .build();
    }
```

## 8.7 druid è¿æ¥æ± é…ç½®åŠç›‘æ§é…ç½®

ä¾èµ–æˆ‘ä»¬å·²ç»å¼•å…¥äº†ï¼Œåœ¨ pom æ¨¡å—ä¸­ã€‚

è§£ææ¥å°±åªè¦è¿›è¡Œé…ç½®äº†ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š

1ã€é…ç½® yml

æ¨¡å—ï¼šld-base-config

æ–‡ä»¶ï¼šapplication-mybatisplus.yml

```yml
#datasource
spring.datasource:
  type: com.alibaba.druid.pool.DruidDataSource
  #   æ•°æ®æºå…¶ä»–é…ç½®
  druid:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: url
    username: è´¦å·
    password: å¯†ç 
    #     é…ç½®åˆå§‹åŒ–å¤§å°ã€æœ€å°ã€æœ€å¤§çº¿ç¨‹æ•°
    initialSize: 5
    minIdle: 5
    #     CPUæ ¸æ•°+1ï¼Œä¹Ÿå¯ä»¥å¤§äº›ä½†ä¸è¦è¶…è¿‡20ï¼Œæ•°æ®åº“åŠ é”æ—¶è¿æ¥è¿‡å¤šæ€§èƒ½ä¸‹é™
    maxActive: 20
    #     æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œå†…ç½‘ï¼š800ï¼Œå¤–ç½‘ï¼š1200ï¼ˆä¸‰æ¬¡æ¡æ‰‹1sï¼‰
    maxWait: 60000
    timeBetweenEvictionRunsMillis: 60000
    #     é…ç½®ä¸€ä¸ªè¿æ¥åœ¨æ± ä¸­æœ€å¤§ç©ºé—´æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’
    minEvictableIdleTimeMillis: 300000
    validationQuery: SELECT 1
    testWhileIdle: true
    #     è®¾ç½®ä»è¿æ¥æ± è·å–è¿æ¥æ—¶æ˜¯å¦æ£€æŸ¥è¿æ¥æœ‰æ•ˆæ€§ï¼Œtrueæ£€æŸ¥ï¼Œfalseä¸æ£€æŸ¥
    testOnBorrow: true
    #     è®¾ç½®ä»è¿æ¥æ± å½’è¿˜è¿æ¥æ—¶æ˜¯å¦æ£€æŸ¥è¿æ¥æœ‰æ•ˆæ€§ï¼Œtrueæ£€æŸ¥ï¼Œfalseä¸æ£€æŸ¥
    testOnReturn: true
    #     å¯ä»¥æ”¯æŒPSCacheï¼ˆæå‡å†™å…¥ã€æŸ¥è¯¢æ•ˆç‡ï¼‰
    poolPreparedStatements: true
    #   é…ç½®ç›‘æ§ç»Ÿè®¡æ‹¦æˆªçš„filtersï¼Œå»æ‰åç›‘æ§ç•Œé¢sqlæ— æ³•ç»Ÿè®¡ï¼Œ'wall'ç”¨äºé˜²ç«å¢™
#    filters: stat,wall,log4j
    filters: stat,wall
    #     ä¿æŒé•¿è¿æ¥
    keepAlive: true
    maxPoolPreparedStatementPerConnectionSize: 20
    useGlobalDataSourceStat: true
    connectionProperties: druid.stat.mergeSql=true;druid.stat.slowSqlMillis=500

mybatis-plus:
  map-underscore-to-camel-case: true
  type-enums-package: cn.j3code.bldbase.enums,cn.j3code.botqq.enums,cn.j3code.lucky.enums

mybatis-plus.configuration.log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
```

æ¨¡å—ï¼šld-base-config

æ–‡ä»¶ï¼šapplication-dev.yml

```yml
ld:
  # é…ç½® druid ç™»å½•å¯†ç 
  druid_password: ENC(dt7eo1i+3pVrhVI+cJicCa0AsP1mhq9wbwRJ7vOAt+TQtbLZr1Sq+oSLHmmLosz3)
```

æ¨¡å—ï¼šld-base-config

æ–‡ä»¶ï¼šapplication-dev-gateway.yml

ä¸‹é¢ä¼šåœ¨ç½‘å…³å¤„è¿›è¡Œæ‹¦æˆªè®¤è¯ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è¦é…ç½®å¿½ç•¥æ‹¦æˆªè·¯å¾„ï¼Œé…ç½®å¦‚ä¸‹

```yml
# å¿½ç•¥ url æ‹¦æˆª
ld.global-filter:
  ignoreUrlSet:
    - /user/login
    - /user/register
    - /ld-druid/
  authorization: Authorization
```



2ã€ç¼–å†™é…ç½®æ–‡ä»¶

æ¨¡å—ï¼šld-base-common

åŒ…ï¼šcn.j3code.common.config

```java
@Data
@ConfigurationProperties(prefix = "ld")
@Configuration
public class DruidConfig {

    private String druidPassword;

    @ConfigurationProperties(prefix = "spring.datasource.druid")
    @Bean
    public DataSource druidDataSource(){
        return new DruidDataSource();
    }

    /**
     * druid æ•°æ®æºçŠ¶æ€ç›‘æ§
     * http://Ip + ç«¯å£/é¡¹ç›®åç§°/ld-druid/login.html
     * æœ¬äººï¼šhttp://localhost:7210/ld-lucky/ld-druid/login.html
     * @return
     */
    @Bean
    public ServletRegistrationBean statViewServlet(){
        //åˆ›å»ºservletæ³¨å†Œå®ä½“
        ServletRegistrationBean servletRegistrationBean = new ServletRegistrationBean(new StatViewServlet(),"/ld-druid/*");
        //è®¾ç½®ipç™½åå•(ä¸é…ç½®åˆ™å…è®¸æ‰€æœ‰)
        // servletRegistrationBean.addInitParameter("allow","127.0.0.1");
        //è®¾ç½®ipé»‘åå•ï¼Œå¦‚æœallowä¸denyå…±åŒå­˜åœ¨æ—¶,denyä¼˜å…ˆäºallow
        // servletRegistrationBean.addInitParameter("deny","192.168.0.19");
        //è®¾ç½®æ§åˆ¶å°ç®¡ç†ç”¨æˆ·
        servletRegistrationBean.addInitParameter("loginUsername","druid");
        servletRegistrationBean.addInitParameter("loginPassword",druidPassword);
        //æ˜¯å¦å¯ä»¥é‡ç½®æ•°æ®
        servletRegistrationBean.addInitParameter("resetEnable","false");
        return servletRegistrationBean;
    }

    /**
     * druid è¿‡æ»¤å™¨
     * @return
     */
    @Bean
    public FilterRegistrationBean statFilter(){
        //åˆ›å»ºè¿‡æ»¤å™¨
        FilterRegistrationBean filterRegistrationBean = new FilterRegistrationBean(new WebStatFilter());
        //è®¾ç½®è¿‡æ»¤å™¨è¿‡æ»¤è·¯å¾„
        filterRegistrationBean.addUrlPatterns("/*");
        //å¿½ç•¥è¿‡æ»¤çš„å½¢å¼
        filterRegistrationBean.addInitParameter("exclusions","*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*");
        return filterRegistrationBean;
    }
}
```



# ä¹ã€ç½‘å…³æ¨¡å—æ­å»º

ç½‘å…³æ•…åæ€æ„å°±æ˜¯è®©å‰ç«¯å‘é€çš„æ‰€æœ‰è¯·æ±‚æœ€å…ˆæŠµè¾¾çš„æ˜¯ç½‘å…³ï¼Œç„¶åé€šè¿‡ç½‘å…³å†åˆ†å‘åˆ°åç«¯å…·ä½“çš„å¾®æœåŠ¡ä¸­ï¼Œé‚£å‰é¢æˆ‘ä»¬å·²ç»æŠŠç½‘å…³æœåŠ¡æ­å»ºå‡ºæ¥äº†ï¼Œç°åœ¨åªæ˜¯æ²¡æœ‰å‘é‡Œé¢é…ç½®ä¸šåŠ¡åŠŸèƒ½ã€‚

ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬è¦é…ç½®ç½‘å…³çš„é…ç½®æ–‡ä»¶

bootstrap.yml

```yaml
spring:
  application:
    name: bld-gateway

#é»˜è®¤ä½¿ç”¨7210ç«¯å£
server:
  port: 7210
```

application.yml

```yaml
spring:
  profiles:
    active: dev,nacos,dev-gateway
```

application-dev-gateway.yml

```yaml
spring:
  cloud:
    # cn.baiqi.gateway ç½‘å…³
    gateway:
      globalcors:
        corsConfigurations:
          '[/**]':
            allowedOrigins: "*"
            allowedMethods: "*"
            allowedHeaders: "*"
      routes:
        - id: bld-bot-qq
          uri: http://127.0.0.1:7212/
          predicates:
            - Path=/bld-bot-qq/**
          filters:
            # 1è¡¨ç¤ºè¿‡æ»¤ä¸€ä¸ªè·¯å¾„
            - StripPrefix=1
        - id: bld-lucky
          uri: http://127.0.0.1:7214/
          predicates:
            - Path=/bld-lucky/**
          filters:
            # 1è¡¨ç¤ºè¿‡æ»¤ä¸€ä¸ªè·¯å¾„
            - StripPrefix=1

# å¿½ç•¥ url æ‹¦æˆª
bld.gateway:
    ignoreUrlSet:
      - /user/login
      - /user/register
      - /ld-druid/
    authorization: Authorization
```

application-prod-gateway.yml

```yaml
spring:
  cloud:
    # cn.baiqi.gateway ç½‘å…³
    gateway:
      globalcors:
        corsConfigurations:
          '[/**]':
            allowedOrigins: "*"
            allowedMethods: "*"
            allowedHeaders: "*"
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true
```

è¿™é‡Œè¯´ä¸€ä¸‹ï¼Œåœ¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œå…ˆåŠ è½½ bootstrap.yml é…ç½®æ–‡ä»¶ï¼Œç„¶ååŠ è½½ application.yml æ¥ç€ä¼šåŠ è½½ application.yml ä¸­é…ç½®ç”Ÿæ•ˆçš„é…ç½®æ–‡ä»¶ã€‚

æˆ‘ä»¬ä¸»è¦çœ‹ application-dev-gateway.yml é…ç½®æ–‡ä»¶ï¼Œæˆ‘é…ç½®äº†ä¸‰ä¸ªåŠŸèƒ½ï¼š

- è·¨åŸŸ
- æœåŠ¡è¯·æ±‚è½¬å‘è§„åˆ™
- è‡ªå®šä¹‰å‚æ•°

é…ç½®è·¨åŸŸæ˜¯ä¸ºäº†å‰åç«¯è”è°ƒæ—¶å‡ºç°è·¨åŸŸé—®é¢˜ï¼›æœåŠ¡è¯·æ±‚è½¬å‘è§„åˆ™æ˜¯ä¸ºäº†åœ¨æœ¬åœ°å¼€å‘æ—¶ï¼Œè¯·æ±‚èƒ½è½¬å‘åˆ°æœ¬åœ°æœåŠ¡è€Œä¸æ˜¯çº¿ä¸Šï¼›è‡ªå®šå‚æ•°æ˜¯ä¸ºäº†æ’é™¤ä¸€äº›è·¯å¾„æ‹¦æˆªã€‚

å…¶å®åšå®Œè¿™äº›ï¼Œç½‘å…³å°±åŸºæœ¬å·®ä¸å¤šå¯ä»¥äº†ï¼Œä½†æ˜¯æˆ‘åœ¨è¿™é‡Œè¿˜åŠ äº†ä¸¤ä¸ªä¸ªåŠŸèƒ½å°±æ˜¯æå‰åšç™»å½•æ ¡éªŒå’Œç½‘å…³é™æµã€‚

## 9.1 è®¤è¯

è®¤è¯æµç¨‹å›¾å¦‚ä¸‹ï¼š

![](img/Snipaste_2022-11-10_08-43-30.png)

okï¼Œé‚£ä¹ˆæˆ‘ä»¬ç°åœ¨æ ¹æ®å›¾ï¼Œå…ˆæ¥ç¼–å†™ JWT å·¥å…·ç±»ã€‚

æ¨¡å—ï¼šbld-base-config

åŒ…ï¼šcn.j3code.bldbase.util

ä»£ç ï¼š

```java
@Slf4j
public class JwtUtil {

    /**
     * å¯†é’¥
     */
    private static final String SECRET = "å¯†é’¥";

    /**
     * è¿‡æœŸæ—¶é—´ (å•ä½ä¸ºç§’)
     * 2 * 24 * 60 * 60L
     **/
    private static final Long EXPIRATION = 2 * 24 * 60 * 60L;

    /**
     * ç”Ÿæˆç”¨æˆ·token,è®¾ç½®tokenè¶…æ—¶æ—¶é—´
     */
    public static String createToken(Map<String, Object> data) {
        //è¿‡æœŸæ—¶é—´
        Date expireDate = new Date(System.currentTimeMillis() + EXPIRATION * 1000);
        Map<String, Object> map = new HashMap<>();
        map.put("alg", "HS256");
        map.put("typ", "JWT");
        JWTCreator.Builder builder = JWT.create()
            // æ·»åŠ å¤´éƒ¨
            .withHeader(map);
        //å¯ä»¥å°†åŸºæœ¬ä¿¡æ¯æ”¾åˆ°claimsä¸­
        data.forEach((key, value) -> builder.withClaim(key, value.toString()));

        return builder
            //è¶…æ—¶è®¾ç½®,è®¾ç½®è¿‡æœŸçš„æ—¥æœŸ
            .withExpiresAt(expireDate)
            //ç­¾å‘æ—¶é—´
            .withIssuedAt(new Date())
            //SECRETåŠ å¯†
            .sign(Algorithm.HMAC256(SECRET));
    }

    /**
     * æ ¡éªŒtokenå¹¶è§£ætoken
     */
    public static Map<String, Object> verifyToken(String token) {
        Map<String, Object> data = new HashMap<>();
        try {
            JWTVerifier verifier = JWT.require(Algorithm.HMAC256(SECRET)).build();
            DecodedJWT jwt = verifier.verify(token);
            jwt.getClaims().forEach((key, value) -> data.put(key, value.asString()));
        } catch (TokenExpiredException e) {
            log.error("token è¿‡æœŸ, {}", e.getMessage());
            throw new BldException("token è¿‡æœŸï¼");
        } catch (Exception e) {
            log.error("token è§£ç å¼‚å¸¸:", e);
            throw new BldException("éæ³• tokenï¼");
        }
        return data;
    }


    public static void main(String[] args) {
        String token = JwtUtil.createToken(Map.of("name", "J3"));
        System.out.println(token);
        Map<String, Object> stringObjectMap = JwtUtil.verifyToken(token);
        System.out.println(stringObjectMap);
    }
}
```

JWTç›¸å…³çŸ¥è¯†ç‚¹å¯ä»¥çœ‹æˆ‘çš„åº•éƒ¨ç»™ä½ ä»¬æ‰¾çš„èµ„æ–™ä¸­é˜…è§ˆã€‚

å†å†™ä¸€ä¸ªçº¿ç¨‹éš”ç¦»å·¥å…·ï¼Œæ–¹ä¾¿ç¨‹åºä¸­å­˜æ”¾ç”¨æˆ·çš„ç™»å½•æ•°æ®ã€‚

æ¨¡å—ï¼šbld-base-config

åŒ…ï¼šcn.j3code.bldbase.util

ä»£ç ï¼š

```java
@Slf4j
public class SecurityUtil {

    private static ThreadLocal<Map<String, Object>> threadLocal = new ThreadLocal<>();

    public static Object getValue(String name) {
        return threadLocal.get().get(name);
    }

    public static String getString(String name) {
        return Objects.isNull(threadLocal.get().get(name)) ? "" : threadLocal.get().get(name).toString();
    }

    public static String getName() {
        return getString("name");
    }

    public static Long getUserId() {
        return getLongValue("id");
    }

    private static Long getLongValue(String id) {
        return Long.parseLong(threadLocal.get().get(id).toString());
    }

    public static void setMap(Map<String, Object> map) {
        threadLocal.set(map);
    }

    public static void remove() {
        threadLocal.remove();
    }

}
```

å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹ç¼–å†™ç½‘å…³è¿‡æ»¤å™¨äº†ã€‚

æ¨¡å—ï¼šbld-gateway

åŒ…ï¼šcn.j3code.bldgateway.filter

ä»£ç ï¼š

```java
@Slf4j
@Component
@ConfigurationProperties(prefix = "bld.gateway")
@Data
public class JwtTokenFilter implements GlobalFilter, Ordered {

    private ObjectMapper objectMapper;

    public JwtTokenFilter(ObjectMapper objectMapper) {
        this.objectMapper = objectMapper;
    }


    /**
     * è·³è¿‡ä¸éœ€è¦éªŒè¯çš„è·¯å¾„ï¼Œå¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®è¯¥è·¯å¾„
     */
    private Set<String> ignoreUrlSet = Set.of(
        "/user/login",
        "/user/register"
    );

    /**
     * è®¤è¯æ ‡è¯†
     */
    private String authorization = "Authorization";


    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        String url = exchange.getRequest().getURI().getPath();

        // å¿½ç•¥ url
        for (String ignoreUrl : ignoreUrlSet) {
            if (url.contains(ignoreUrl)) {
                return chain.filter(exchange);
            }
        }

        //è·å–token
        String token = exchange.getRequest().getHeaders().getFirst(authorization);
        ServerHttpResponse resp = exchange.getResponse();

        if (StringUtils.isBlank(token)) {
            //æ²¡æœ‰token
            return authErro(resp, "è¯·å…ˆè®¤è¯");
        }

        try {
            Map<String, Object> map = JwtUtil.verifyToken(token);
            ServerHttpRequest.Builder mutate = exchange.getRequest().mutate();
            mutate.header("name", URLEncoder.encode(Objects.isNull(map.get("name")) ? "" : map.get("name").toString()), "UTF-8");
            mutate.header("id", Objects.isNull(map.get("id")) ? "0" : map.get("id").toString());
            return chain.filter(exchange.mutate().request(mutate.build()).build());
        } catch (Exception e) {
            //é”™è¯¯å¤„ç†
            return authErro(resp, e.getMessage());
        }
    }

    private Mono<Void> authErro(ServerHttpResponse resp, String msg) {
        resp.setStatusCode(HttpStatus.UNAUTHORIZED);
        resp.getHeaders().add("Content-Type", "application/json;charset=UTF-8");

        String returnStr = "";
        try {
            returnStr = objectMapper.writeValueAsString(new FailInfo(500, msg));
        } catch (JsonProcessingException e) {
            log.error(e.getMessage(), e);
        }
        DataBuffer buffer = resp.bufferFactory().wrap(returnStr.getBytes(StandardCharsets.UTF_8));

        return resp.writeWith(Flux.just(buffer));
    }

    @Override
    public int getOrder() {
        return -100;
    }
}
```

## 9.2 é™æµ

æœ¬é¡¹ç›®æ‰€æœ‰è¯·æ±‚éƒ½æ˜¯é€šè¿‡ç½‘å…³è¿›è¡Œè½¬å‘ï¼Œæ‰€ä»¥åœ¨ç½‘å…³å¤„æ¥è¿›è¡Œä¸€ä¸ªé™æµå¤„ç†ã€‚

æ­¥éª¤ï¼š

1ã€ç¼–å†™é…ç½®

æ¨¡å—ï¼šld-base-config

é…ç½®ï¼šapplication-dev-gateway.yml

```yml
spring:
  cloud:
    # cn.baiqi.gateway ç½‘å…³
    gateway:
      globalcors:
        corsConfigurations:
          '[/**]':
            allowedOrigins: "*"
            allowedMethods: "*"
            allowedHeaders: "*"
      default-filters:
        - name: IpRequestRateLimiter
          args:
            key-resolver: "#{@ipKeyResolver}"
            redis-rate-limiter.replenishRate: 10 #å­—æ®µä¸ºä»¤ç‰Œæ¡¶æ¢å¤é€Ÿåº¦ï¼Œå³æ¯ç§’è®¿é—®ä¸ªæ•°
            redis-rate-limiter.burstCapacity: 40 #å­—æ®µä¸ºä»¤ç‰Œæ¡¶å¤§å°ï¼Œå³å³°å€¼æµé‡æ¥ä¸´æ—¶æœ€å¤§å¯è®¿é—®æ•°
      routes:
        - id: ld-lucky
          uri: http://127.0.0.1:7214/
          predicates:
            - Path=/ld-lucky/**
          filters:
            # 1è¡¨ç¤ºè¿‡æ»¤ä¸€ä¸ªè·¯å¾„
            - StripPrefix=1
#            - name: IpRequestRateLimiter #è¯·æ±‚æ•°é™æµ åå­—ä¸èƒ½éšä¾¿å†™
#              args:
#                key-resolver: "#{@ipKeyResolver}"
#                redis-rate-limiter.replenishRate: 1 #å­—æ®µä¸ºä»¤ç‰Œæ¡¶æ¢å¤é€Ÿåº¦ï¼Œå³æ¯ç§’è®¿é—®ä¸ªæ•°
#                redis-rate-limiter.burstCapacity: 1 #å­—æ®µä¸ºä»¤ç‰Œæ¡¶å¤§å°ï¼Œå³å³°å€¼æµé‡æ¥ä¸´æ—¶æœ€å¤§å¯è®¿é—®æ•°



# å¿½ç•¥ url æ‹¦æˆª
ld.global-filter:
  ignoreUrlSet:
    - /user/login
    - /user/register
    - /ld-druid/
  authorization: Authorization
```

2ã€ç¼–å†™å”¯ä¸€ key é…ç½®ï¼šipKeyResolver

æ¨¡å—ï¼šld-gateway

åŒ…ï¼šcn.j3code.gateway.resolver

```java
public class IpKeyResolver implements KeyResolver {

    @Override
    public Mono<String> resolve(ServerWebExchange exchange) {
        //return Mono.just(exchange.getRequest().getPath().value());
        return Mono.just(exchange.getRequest().getRemoteAddress().getHostName());
    }
}
```

åœ¨ä¸»ç±»ä¸­æ·»åŠ è¯¥ Bean

```java
@SpringBootApplication
public class GatewayApplication {

    public static void main(String[] args) {
        SpringApplication.run(GatewayApplication.class, args);
    }
    
    @Bean("ipKeyResolver")
    public IpKeyResolver ipKeyResolver(){
        return new IpKeyResolver();
    }

}
```

3ã€ç¼–å†™ç»Ÿä¸€çš„é™æµè¿”å›ç»“æœç±»

å¦‚æœè¯¥ç±»ä¸å†™ï¼Œåˆ™åªä¼šç»™å‰ç«¯è¿”å›ä¸€ä¸ª 429 è¿”å›ç ï¼Œå¯“æ„ä¸æ˜ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦é‡å†™ç½‘å…³é™æµè¿”å›ç»“æœï¼Œè¿›è¡Œç»Ÿä¸€çš„ç»“æœå¤„ç†

åœ¨é…ç½®æ–‡ä»¶ä¸­ä¸‹é¢å±æ€§é…ç½®çš„æ˜¯ RequestRateLimiter è¿™ç§é»˜è®¤å€¼ï¼Œé‚£ä¹ˆå°±æ˜¯é»˜è®¤èŒƒå›´ 429 çŠ¶æ€ç ã€‚

default-filters:

 -name: RequestRateLimiter

è€Œæœ¬æ¬¡æˆ‘ä»¬é…ç½®ä¸ºï¼šIpRequestRateLimiter

å®ç°ç±»ä¸ºï¼šIpRequestRateLimiterGatewayFilterFactory

åŒ…ï¼šcn.j3code.gateway.filter

```java
@Slf4j
@Component
public class IpRequestRateLimiterGatewayFilterFactory extends RequestRateLimiterGatewayFilterFactory {

    private final RateLimiter defaultRateLimiter;

    private final KeyResolver defaultKeyResolver;

    public IpRequestRateLimiterGatewayFilterFactory(RateLimiter defaultRateLimiter, KeyResolver defaultKeyResolver) {
        super(defaultRateLimiter, defaultKeyResolver);
        this.defaultRateLimiter = defaultRateLimiter;
        this.defaultKeyResolver = defaultKeyResolver;
    }

    @Override
    public GatewayFilter apply(Config config) {
        KeyResolver resolver = getOrDefault(config.getKeyResolver(), defaultKeyResolver);
        RateLimiter<Object> limiter = getOrDefault(config.getRateLimiter(), defaultRateLimiter);
        return (exchange, chain) -> resolver.resolve(exchange).flatMap(key -> {
            String routeId = config.getRouteId();
            if (routeId == null) {
                Route route = exchange.getAttribute(ServerWebExchangeUtils.GATEWAY_ROUTE_ATTR);
                routeId = route.getId();
            }
            String finalRouteId = routeId;
            return limiter.isAllowed(routeId, key).flatMap(response -> {
                for (Map.Entry<String, String> header : response.getHeaders().entrySet()) {
                    exchange.getResponse().getHeaders().add(header.getKey(), header.getValue());
                }
                if (response.isAllowed()) {
                    return chain.filter(exchange);
                }
                log.info("å·²é™æµ: {}", finalRouteId);
                ServerHttpResponse httpResponse = exchange.getResponse();
                //ä¿®æ”¹codeä¸º500
                httpResponse.setStatusCode(HttpStatus.INTERNAL_SERVER_ERROR);
                if (!httpResponse.getHeaders().containsKey("Content-Type")) {
                    httpResponse.getHeaders().add("Content-Type", "application/json");
                }
                //æ­¤å¤„æ— æ³•è§¦å‘å…¨å±€å¼‚å¸¸å¤„ç†ï¼Œæ‰‹åŠ¨è¿”å›
                var failInfo = FailInfo.builder().exception("æœåŠ¡ç¹å¿™ï¼Œç¨åé‡è¯•ï¼").build();
                DataBuffer buffer = httpResponse.bufferFactory().wrap(JSON.toJSONString(failInfo).getBytes(StandardCharsets.UTF_8));
                return httpResponse.writeWith(Mono.just(buffer));
            });
        });
    }


    private <T> T getOrDefault(T configValue, T defaultValue) {
        return (configValue != null) ? configValue : defaultValue;
    }
}
```

è¿™æ ·é…ç½®ï¼Œåœ¨è§¦å‘é™æµçš„æ—¶å€™å°±å¯ä»¥è¿”å›ç³»ç»Ÿç»Ÿä¸€çš„é”™è¯¯ç»“æœé›†ã€‚

åˆ°æ­¤ï¼Œæˆ‘ä»¬çš„ç½‘å…³åŠŸèƒ½å°±ç®—æ˜¯ç¼–å†™å®Œæˆã€‚

# åã€æŠ½å¥–ä¸šåŠ¡æ¨¡å—æ­å»º

ä¸‹é¢æˆ‘ä»¬æ¥æ­å»ºä¸€ä¸‹æŠ½å¥–ä¸šåŠ¡æ¨¡å—

æ¨¡å—åï¼šbld-service-ddd-lucky

pomï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <artifactId>bld-service</artifactId>
        <groupId>cn.j3code</groupId>
        <version>BLD.2022.10.25.RELEASE</version>
    </parent>

    <packaging>pom</packaging>
    <artifactId>bld-service-ddd-lucky</artifactId>

    <properties>
    </properties>

    <modules>
        <module>lucky-adapter</module>
        <module>lucky-app</module>
        <module>lucky-client</module>
        <module>lucky-domain</module>
        <module>lucky-infrastructure</module>
        <module>start</module>
    </modules>


    <dependencyManagement>
        <dependencies>
            <!--Project modules-->
            <dependency>
                <groupId>cn.j3code</groupId>
                <artifactId>lucky-adapter</artifactId>
                <version>${project.version}</version>
            </dependency>
            <dependency>
                <groupId>cn.j3code</groupId>
                <artifactId>lucky-app</artifactId>
                <version>${project.version}</version>
            </dependency>
            <dependency>
                <groupId>cn.j3code</groupId>
                <artifactId>lucky-client</artifactId>
                <version>${project.version}</version>
            </dependency>
            <dependency>
                <groupId>cn.j3code</groupId>
                <artifactId>lucky-domain</artifactId>
                <version>${project.version}</version>
            </dependency>
            <dependency>
                <groupId>cn.j3code</groupId>
                <artifactId>lucky-infrastructure</artifactId>
                <version>${project.version}</version>
            </dependency>
            <!--Project modules End-->

            <dependency>
                <groupId>com.alibaba.cola</groupId>
                <artifactId>cola-components-bom</artifactId>
                <version>${cola.components.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>

        </dependencies>
    </dependencyManagement>


    <dependencies>
    </dependencies>

</project>
```

è¯¥æ¨¡å—ä¸ºçˆ¶æ¨¡å—ï¼Œé‡Œé¢æœ‰å…­ä¸ªå­æ¨¡å—ï¼ˆä¸æ‡‚å¾—çœ‹ç¬¬å››èŠ‚ï¼‰ï¼š

- lucky-adapter
- lucky-app
- lucky-client
- lucky-domain
- lucky-infrastructure
- start

ä¸‹é¢è¦åˆ†åˆ«æŠŠè¿™å‡ ä¸ªæ¨¡å—åˆ›å»ºå‡ºæ¥äº†ã€‚

## 10.1 æŠ½å¥–ä¸šåŠ¡ COLA æ¶æ„æ¨¡å—æ­å»º

1ã€lucky-adapter æ¨¡å—

pom

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <artifactId>bld-service-ddd-lucky</artifactId>
        <groupId>cn.j3code</groupId>
        <version>BLD.2022.10.25.RELEASE</version>
    </parent>
    <packaging>jar</packaging>
    <artifactId>lucky-adapter</artifactId>


    <dependencies>

        <dependency>
            <groupId>cn.j3code</groupId>
            <artifactId>lucky-app</artifactId>
        </dependency>

    </dependencies>

</project>
```

2ã€lucky-app æ¨¡å—

pomï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <artifactId>bld-service-ddd-lucky</artifactId>
        <groupId>cn.j3code</groupId>
        <version>BLD.2022.10.25.RELEASE</version>
    </parent>
    <packaging>jar</packaging>
    <artifactId>lucky-app</artifactId>


    <dependencies>

        <dependency>
            <groupId>cn.j3code</groupId>
            <artifactId>lucky-domain</artifactId>
        </dependency>
        <dependency>
            <groupId>cn.j3code</groupId>
            <artifactId>lucky-client</artifactId>
        </dependency>

        <dependency>
            <groupId>cn.j3code</groupId>
            <artifactId>lucky-infrastructure</artifactId>
        </dependency>

        <dependency>
            <groupId>com.alibaba.cola</groupId>
            <artifactId>cola-component-catchlog-starter</artifactId>
        </dependency>
    </dependencies>

</project>
```

3ã€lucky-clientæ¨¡å—

pomï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <artifactId>bld-service-ddd-lucky</artifactId>
        <groupId>cn.j3code</groupId>
        <version>BLD.2022.10.25.RELEASE</version>
    </parent>
    <packaging>jar</packaging>
    <artifactId>lucky-client</artifactId>

    <dependencies>
        <dependency>
            <groupId>com.alibaba.cola</groupId>
            <artifactId>cola-component-dto</artifactId>
        </dependency>
    </dependencies>

</project>
```

4ã€lucky-domainæ¨¡å—

pomï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <artifactId>bld-service-ddd-lucky</artifactId>
        <groupId>cn.j3code</groupId>
        <version>BLD.2022.10.25.RELEASE</version>
    </parent>
    <packaging>jar</packaging>
    <artifactId>lucky-domain</artifactId>

    <dependencies>
        <dependency>
            <groupId>cn.j3code</groupId>
            <artifactId>lucky-client</artifactId>
        </dependency>

        <!-- COLA components -->
        <dependency>
            <groupId>com.alibaba.cola</groupId>
            <artifactId>cola-component-domain-starter</artifactId>
        </dependency>
        <dependency>
            <groupId>com.alibaba.cola</groupId>
            <artifactId>cola-component-exception</artifactId>
        </dependency>
        <!-- COLA components End-->
    </dependencies>


</project>
```

5ã€lucky-infrastructureæ¨¡å—

pomï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <artifactId>bld-service-ddd-lucky</artifactId>
        <groupId>cn.j3code</groupId>
        <version>BLD.2022.10.25.RELEASE</version>
    </parent>
    <packaging>jar</packaging>
    <artifactId>lucky-infrastructure</artifactId>


    <dependencies>
        <dependency>
            <groupId>cn.j3code</groupId>
            <artifactId>lucky-domain</artifactId>
        </dependency>
    </dependencies>

</project>
```

6ã€start æ¨¡å—

pomï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <artifactId>bld-service-ddd-lucky</artifactId>
        <groupId>cn.j3code</groupId>
        <version>BLD.2022.10.25.RELEASE</version>
    </parent>
    <packaging>jar</packaging>
    <artifactId>start</artifactId>


    <dependencies>
        <dependency>
            <groupId>cn.j3code</groupId>
            <artifactId>lucky-adapter</artifactId>
        </dependency>
        <dependency>
            <groupId>cn.j3code</groupId>
            <artifactId>lucky-app</artifactId>
        </dependency>
        <dependency>
            <groupId>cn.j3code</groupId>
            <artifactId>lucky-client</artifactId>
        </dependency>
        <dependency>
            <groupId>cn.j3code</groupId>
            <artifactId>lucky-domain</artifactId>
        </dependency>
        <dependency>
            <groupId>cn.j3code</groupId>
            <artifactId>lucky-infrastructure</artifactId>
        </dependency>
    </dependencies>


    <build>
        <plugins>
            <!-- Springbootæ‰“åŒ…æ’ä»¶ã€‚ä½¿ç”¨ mvn package è¿›è¡Œæ‰“åŒ…ã€‚ -->
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <version>2.5.3</version>
                <configuration>
                    <!-- mainæ–¹æ³•æ‰€åœ¨ç±»ã€‚ -->
                    <mainClass>cn.j3code.lucky.LuckyStartApplication</mainClass>
                </configuration>
                <executions>
                    <execution>
                        <goals>
                            <goal>repackage</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
        </plugins>
        <resources>
            <!--ç¼–è¯‘é…ç½®æ–‡ä»¶-->
            <resource>
                <directory>src/main/resources</directory>
                <includes>
                    <include>**/*.*</include>
                </includes>
            </resource>
        </resources>
    </build>

</project>
```

## 10.2 æŠ½å¥–ä¸šåŠ¡æ¨¡å—é…ç½®

ä» 10.1 æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œstart æ˜¯è¿™äº›æ¨¡å—ä¸­çš„å¯åŠ¨æ¨¡å—ï¼Œä¸»ç±»ä¹Ÿåœ¨å…¶ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ç›¸å…³é…ç½®åˆ™æ”¾åœ¨è¿™é‡Œã€‚

æ¨¡å—ï¼šstart

é…ç½®ï¼š

bootstrap.yml

```yaml
spring:
  application:
    name: bld-lucky

#é»˜è®¤ä½¿ç”¨7214ç«¯å£
server:
  port: 7214
```

application.yml

```yaml
spring:
  profiles:
    active: dev,mybatisplus,nacos
```

## 10.3 ç”¨æˆ·ç›¸å…³åŠŸèƒ½å¼€å‘

ç”¨æˆ·æ¨¡å—ä¸»è¦çš„ä¸šåŠ¡åŠŸèƒ½æœ‰ï¼š

- ç”¨æˆ·ç™»å½•
- ç”¨æˆ·æ³¨å†Œ
- ç”¨æˆ·ä¿®æ”¹ä¿¡æ¯
- ç”¨æˆ·æŸ¥è¯¢ä¸ªäººä¿¡æ¯
- ç®¡ç†å‘˜æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨

ç”¨æˆ·æ•°æ®çš„é™åˆ¶æœ‰ï¼š

- ç”¨æˆ·è´¦å·å”¯ä¸€
- å§“åä¸ä¸ºç©ºã€å¯†ç åŠ å¯†å­˜å‚¨

å¥½ï¼Œäº†è§£äº†ä¸Šé¢è¿™äº›ï¼Œæˆ‘ä»¬ç°åœ¨å¼€å§‹ç¼–ç ã€‚

1ã€ç¼–å†™å®ä½“

æ¨¡å—ï¼šlucky-infrastructure

åŒ…ï¼šcn.j3code.lucky.infrastructure.gateway.impl.database.dataobject

```java
@TableName(value ="bld_lucky_user")
@Data
public class UserDO implements Serializable {
    /**
     * 
     */
    @TableId(type = IdType.AUTO)
    private Long id;

    /**
     * å§“å
     */
    private String name;

    /**
     * ç”µè¯
     */
    private String phone;

    /**
     * å¯†ç ï¼ˆåŠ å¯†åçš„ï¼‰
     */
    private String password;

    private String username;

    /**
     * 
     */
    private LocalDateTime creatTime;

    /**
     * 
     */
    private String creator;

    /**
     * 
     */
    private LocalDateTime updateTime;

    /**
     * 
     */
    private String updater;

    @TableField(exist = false)
    private static final long serialVersionUID = 1L;
}
```

2ã€ç¼–å†™é¢†åŸŸå¯¹è±¡

æ¨¡å—ï¼šlucky-domain

åŒ…ï¼šcn.j3code.lucky.domain.user

```java
@Data
public class UserEntity {

    private Long id;

    /**
     * ç”¨æˆ·å
     */
    private UserName username;
    /**
     * å¯†ç 
     */
    private UserPassword password;

    /**
     * å§“å
     */
    private String name;

    /**
     * æ‰‹æœºå·
     */
    private String phone;
}
```

ç¼–å†™å¯¹åº”çš„å€¼å¯¹è±¡

```java
public class UserName {
    private final String name;

    public UserName(String name) {
        if (StringUtils.isBlank(name)) {
            throw new ValidationException("ç”¨æˆ·åä¸èƒ½ä¸ºç©º");
        }
        this.name = name;
    }

    public String getName() {
        return name;
    }
}
```

```java
public class UserPassword {

    /**
     * åŠ å¯†åçš„å¯†ç 
     */
    private final EncryptPassword encryptPassword;

    public UserPassword(String password) {
        if (StringUtils.isBlank(password)) {
            throw new ValidationException("å¯†ç ä¸èƒ½ä¸ºç©º");
        }

        // ç”Ÿæˆå¯†ç ç›å’ŒåŠ å¯†å¯†ç 
        this.encryptPassword = new EncryptPassword(generateEncryptPassword(password));
    }

    public UserPassword(EncryptPassword encryptPassword) {
        this.encryptPassword = encryptPassword;
    }
    /**
     * ç”ŸæˆåŠ å¯†å¯†ç 
     *
     * @return åŠ å¯†åçš„å¯†ç 
     */
    private String generateEncryptPassword(String password) {
        return DigestUtils.sha3_256Hex(password);
    }

    public String getEncryptPassword() {
        return encryptPassword.getEncryptPassword();
    }

    /**
     * æ ¡éªŒç”¨æˆ·è¾“å…¥çš„å¯†ç æ˜¯å¦æ­£ç¡®
     *
     * @param password å¯†ç 
     * @return true-å¯†ç æ­£ç¡®; false-å¯†ç é”™è¯¯
     */
    public boolean isCorrect(String password) {
        return encryptPassword.getEncryptPassword().equals(generateEncryptPassword(password));
    }

    /**
     * åŠ å¯†åçš„å¯†ç 
     */
    public static class EncryptPassword {

        private final String encryptPassword;

        public EncryptPassword(String encryptPassword) {
            this.encryptPassword = encryptPassword;
        }

        public String getEncryptPassword() {
            return encryptPassword;
        }
    }
}
```

3ã€ç¼–å†™è§†å›¾å¯¹è±¡

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.dto.data

```java
@Data
public class UserVO {

    private Long id;

    /**
     * å§“å
     */
    private String name;

    /**
     * æ‰‹æœºå·
     */
    private String phone;

    private String username;
}
```

4ã€ç¼–å†™ userController

æ¨¡å—ï¼šlucky-adapter

åŒ…ï¼šcn.j3code.lucky.adapter.web

```java
@Slf4j
@AllArgsConstructor
@ResponseResult  // æˆ‘ä»¬è‡ªå·±çš„ç»“æœè¿”å›å¤„ç†æ³¨è§£
@RequestMapping("/v1/user")
public class UserController {
}
```

### 10.3.1 ç¼–å†™ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½

åˆ†æç”¨æˆ·æ³¨å†Œéœ€è¦çš„æ­¥éª¤ï¼š

1. ç”¨æˆ·è¾“å…¥åŸºæœ¬ä¿¡æ¯ï¼ˆå§“åã€ç”µè¯ã€è´¦å·ã€å¯†ç ï¼‰
2. æ ¡éªŒç”¨æˆ·ä¿¡æ¯ï¼ˆå§“åï¼Œè´¦å·ï¼‰
3. ä¿å­˜ç”¨æˆ·ä¿¡æ¯

å¥½ï¼Œå…ˆæ¥ç¼–å†™æ¥å—ç”¨æˆ·æ³¨å†Œä¿¡æ¯çš„å¯¹è±¡

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.dto

```java
@Data
public class UserRegisterCmd extends Command {
    /**
     * å§“å
     */
    @NotNull(message = "å§“åä¸èƒ½ä¸ºç©º")
    private String name;

    @NotNull(message = "è´¦å·ä¸èƒ½ä¸ºç©º")
    private String username;

    /**
     * æ‰‹æœºå·
     */
    @NotNull(message = "æ‰‹æœºå·ä¸èƒ½ä¸ºç©º")
    private String phone;

    /**
     * å¯†ç 
     */
    @NotNull(message = "å¯†ç ä¸èƒ½ä¸ºç©º")
    private String password;

}
```

å†æ¥ç¼–å†™ UserController

```java
@Slf4j
@AllArgsConstructor
@ResponseResult
@RequestMapping("/v1/user")
public class UserController {

    @PostMapping("/register")
    public UserVO register(@Validated @RequestBody UserRegisterCmd cmd) {
        return null;
    }
}
```

é‚£ä¹ˆä¸‹é¢å°±è¦ç¼–å†™ service äº†

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.api

```java
public interface IUserService {

    /**
     * æ³¨å†Œç”¨æˆ·
     *
     * @param cmd ç”¨æˆ·æ³¨å†Œè¯·æ±‚
     * @return Response
     */
    UserVO register(UserRegisterCmd cmd);
}
```

service å®ç°ç±»ç¼–å†™

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.service

```java
@Slf4j
@Service
@AllArgsConstructor
public class UserServiceImpl implements IUserService {

    @Override
    public UserVO register(UserRegisterCmd cmd) {
        return null;
    }
}
```

ä¸‹é¢æ¥ç¼–å†™æ³¨å†ŒåŠŸèƒ½çš„æ‰§è¡Œå™¨

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.user.command

```java
@Component
@Slf4j
@AllArgsConstructor
public class UserRegisterCmdExe {

    public UserVO execute(UserRegisterCmd cmd) {
        // check ç”¨æˆ·åæ˜¯å¦é‡å¤
        if (1ã€æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦é‡å¤) {
            throw new BldBizException(ErrorCode.B_USER_USERNAME_REPEAT);
        }

        UserEntity userEntity = 2ã€ä¿å­˜;
        return 3ã€è½¬æ¢å¯¹è±¡;
    }

}
```

æ­¤æ—¶ï¼ŒUserServiceImpl # register æ–¹æ³•å°±æ˜¯å¦‚ä¸‹æ ·å­

```java
@Slf4j
@Service
@AllArgsConstructor
public class UserServiceImpl implements IUserService {
    
    private final UserRegisterCmdExe userRegisterCmdExe;

    @Override
    public UserVO register(UserRegisterCmd cmd) {
        return userRegisterCmdExe.execute(cmd);
    }
}
```

ç°åœ¨æˆ‘ä»¬æ¥è¡¥å…¨ UserRegisterCmdExe ç±»ä¸­çš„åŠŸèƒ½ã€‚

1. æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨
2. ä¿å­˜ç”¨æˆ·
3. å¯¹è±¡è½¬æ¢

ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªçš„åŠŸèƒ½å°±éœ€è¦å†™ä¸€ä¸ªé˜²è…å±‚æ¥å¤„ç†äº†ï¼Œå…·ä½“å¦‚ä¸‹ï¼š

æ¨¡å—ï¼šlucky-domain

åŒ…ï¼šcn.j3code.lucky.domain.gateway

```java
public interface UserGateway {

    /**
     * ä¿å­˜ç”¨æˆ·
     *
     * @param userEntity User Domain
     * @return ç”¨æˆ·å®ä½“
     */
    UserEntity save(UserEntity userEntity);

    /**
     * åˆ¤æ–­ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
     *
     * @param username ç”¨æˆ·å
     * @return true-å·²å­˜åœ¨
     */
    Boolean checkByUsername(Long id, String username);

}
```

å®ç°ç±»

æ¨¡å—ï¼šlucky-infrastructure

åŒ…ï¼šcn.j3code.lucky.infrastructure.gateway.impl

```java
@Slf4j
@AllArgsConstructor
@Component
public class UserGatewayImpl implements UserGateway {

    private final UserMapper userMapper;

    @Override
    public UserEntity save(UserEntity userEntity) {
        // æ–°å¢
        if (Objects.isNull(userEntity.getId())) {
            return addUser(userEntity);
        }

        // ä¿®æ”¹
        return modifyUser(userEntity);
    }

    private UserEntity modifyUser(UserEntity userEntity) {
        UserDO userDO = userMapper.selectById(userEntity.getId());

        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
        UserConvertor.toModifyUserDO(userEntity, userDO);

        int update = userMapper.updateById(userDO);
        if (update < 1) {
            throw new PersistenceException("æ›´æ–°ç”¨æˆ·å¼‚å¸¸");
        }

        return UserConvertor.toEntity(userDO);
    }

    private UserEntity addUser(UserEntity userEntity) {
        UserDO userDO = UserConvertor.toAddUserDO(userEntity);
        int insert = userMapper.insert(userDO);
        if (insert < 1) {
            throw new PersistenceException("ä¿å­˜ç”¨æˆ·å¼‚å¸¸");
        }
        return UserConvertor.toEntity(userDO);
    }

    @Override
    public Boolean checkByUsername(Long id, String username) {
        return userMapper.existByUsername(id, username);
    }
}
```

å† UserGatewayImpl ä¸­è·å–è°ƒç”¨æˆ‘ä»¬çš„ UserMapper ç±»å»æ“ä½œæ•°æ®åº“å®Œæˆå¯¹åº”çš„åŠŸèƒ½ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹ mapper å±‚ä»£ç ã€‚

æ¨¡å—ï¼šlucky-infrastructure

åŒ…ï¼šcn.j3code.lucky.infrastructure.gateway.impl.database.mapper

```java
public interface UserMapper extends BaseMapper<UserDO> {

    Boolean existByUsername(@Param("id") Long id, @Param("username") String username);

    Boolean existByUsername(@Param("id") Long id, @Param("username") String username);

}
```

mapper.xml æ–‡ä»¶

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.j3code.lucky.infrastructure.gateway.impl.database.mapper.UserMapper">

    <resultMap id="BaseResultMap" type="cn.j3code.lucky.infrastructure.gateway.impl.database.dataobject.UserDO">
        <id property="id" column="id" jdbcType="BIGINT"/>
        <result property="name" column="name" jdbcType="VARCHAR"/>
        <result property="phone" column="phone" jdbcType="VARCHAR"/>
        <result property="password" column="password" jdbcType="VARCHAR"/>
        <result property="creatTime" column="creat_time" jdbcType="TIMESTAMP"/>
        <result property="creator" column="creator" jdbcType="VARCHAR"/>
        <result property="updateTime" column="update_time" jdbcType="TIMESTAMP"/>
        <result property="updater" column="updater" jdbcType="VARCHAR"/>
    </resultMap>

    <select id="existByUsername" resultType="java.lang.Boolean">
        select count(*)
        from bld_lucky_user
        where username = #{username}
        <if test="id != null">
            and id != #{id}
        </if>
    </select>
    <select id="existByUsername" resultType="java.lang.Boolean">
        select count(*)
        from bld_lucky_user
        where username = #{username}
        <if test="id != null">
            and id != #{id}
        </if>
    </select>
</mapper>
```

æ¥ç€æ¥çœ‹çœ‹ç¬¬ä¸‰æ­¥ï¼Œå¯¹è±¡è½¬æ¢

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.user.assembler

```java
public class UserAssembler {
    public static UserVO toValueObject(UserEntity userEntity) {
        UserVO userVO = new UserVO();
        userVO.setId(userEntity.getId());
        userVO.setName(userEntity.getName());
        userVO.setPhone(userEntity.getPhone());
        userVO.setUsername(userEntity.getUsername().getName());
        return userVO;
    }
}
```

okï¼Œåˆ°æ­¤ï¼Œæˆ‘ä»¬å›å¤´çœ‹çœ‹ UserRegisterCmdExe å®Œå–„åçš„ä»£ç 

```java
@Component
@Slf4j
@AllArgsConstructor
public class UserRegisterCmdExe {

    private final UserGateway userGateway;

    public UserVO execute(UserRegisterCmd cmd) {
        // check ç”¨æˆ·åæ˜¯å¦é‡å¤
        if (userGateway.checkByUsername(null, cmd.getUsername())) {
            throw new BldBizException(ErrorCode.B_USER_USERNAME_REPEAT);
        }

        UserEntity userEntity = userGateway.save(UserAssembler.toEntity(cmd));
        return UserAssembler.toValueObject(userEntity);
    }

}
```

è‡³æ­¤ï¼Œæˆ‘ä»¬çš„ä¸€ä¸ªæ³¨å†ŒåŠŸèƒ½å°±å®Œæˆäº†ï¼Œä¸‹é¢æˆ‘æ¥ç”»ä¸€å¼ å›¾ï¼Œæ•´ä½“å†è¿‡ä¸€éæµç¨‹ã€‚

![](img/Snipaste_2022-11-11_09-56-21.png)

### 10.3.2 ç¼–å†™ç”¨æˆ·ç™»å½•åŠŸèƒ½

ç”¨æˆ·ç™»å½•æ­¥éª¤ï¼š

1. æ ¹æ®ç”¨æˆ·è´¦å·è·å–ç”¨æˆ·ä¿¡æ¯
2. æ ¹æ®ç”¨æˆ·ä¿¡æ¯æ ¡éªŒç”¨æˆ·å¯†ç æ˜¯å¦æ­£ç¡®
3. ç™»å½•æˆåŠŸåˆ™ç”Ÿæˆ JWT å­—ç¬¦ä¸²è¿”å›ç»™å‰ç«¯

å…ˆæ¥ç¼–å†™æ¥å—ç™»å½•ä¿¡æ¯å¯¹è±¡

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.dto.query

```java
@Data
public class UserLoginQuery extends Query {

    private String username;
    private String password;
}
```

ç¼–å†™ UserController ç™»å½•æ–¹æ³•

æ¨¡å—ï¼šlucky-adapter

åŒ…ï¼šcn.j3code.lucky.adapter.web

```java
@Slf4j
@AllArgsConstructor
@ResponseResult
@RequestMapping("/v1/user")
public class UserController {

    private final IUserService userService;
    
    @PostMapping("/login")
    public String login(@RequestBody UserLoginQuery query) {
        return userService.login(query);
    }
}
```

ç¼–å†™ IUserService æ¥å£

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.api

```java
public interface IUserService {
    /**
     * ç”¨æˆ·ç™»å½•
     *
     * @param query ç”¨æˆ·ç™»å½•è¯·æ±‚
     */
    String login(UserLoginQuery query);
}
```

ç¼–å†™ IUserService å®ç°ç±»

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.service

```java
@Slf4j
@Service
@AllArgsConstructor
public class UserServiceImpl implements IUserService {

    @Override
    public String login(UserLoginQuery query) {
        1ã€è°ƒç”¨ç™»å½•æ‰§è¡Œå™¨ï¼Œè¿”å›ç”¨æˆ·å®ä½“
        return 2ã€JWT å­—ç¬¦ä¸²;
    }
}
```

ç”¨æˆ·ç™»å½•ä¸šåŠ¡ä¸­æœ‰ä¸¤æ­¥éª¤ï¼š

1. è°ƒç”¨ç”¨æˆ·ç™»å½•æ‰§è¡Œå™¨
2. ç”ŸæˆJWTå­—ç¬¦ä¸²è¿”å›

å…ˆæ¥ç¼–å†™ç”¨æˆ·ç™»å½•æ‰§è¡Œå™¨

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.user.command.query

```java
@Component
@Slf4j
@AllArgsConstructor
public class UserLoginQueryExe {
    private final UserGateway userGateway;

    public UserEntity execute(UserLoginQuery query) {
        UserEntity userEntity = userGateway.findPasswordInfo(query.getUsername());
        if (Objects.isNull(userEntity)) {
            throw new BldBizException(ErrorCode.B_USER_PASSWORD_ERROR);
        }

        // æ ¡éªŒå¯†ç æ˜¯å¦æ­£ç¡®
        if (!userEntity.getPassword().isCorrect(query.getPassword())) {
            throw new BldBizException(ErrorCode.B_USER_PASSWORD_ERROR);
        }
        return userEntity;
    }
}
```

è¿™é‡Œï¼Œæˆ‘ä»¬è¦è°ƒç”¨ UserGateway æ¥å£ä¸­çš„æŸ¥è¯¢ç”¨æˆ·æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

æ¨¡å—ï¼šlucky-domain

åŒ…ï¼šcn.j3code.lucky.domain.gateway

```java
public interface UserGateway {
    /**
     * è·å–å¯†ç ä¿¡æ¯
     *
     * @param username ç”¨æˆ·å
     * @return å¯†ç 
     */
    UserEntity findPasswordInfo(String username);

}
```

ç¼–å†™ UserGateway æ¥å£å®ç°ç±» 

æ¨¡å—ï¼šlucky-infrastructure

åŒ…ï¼šcn.j3code.lucky.infrastructure.gateway.impl

```java
@Slf4j
@AllArgsConstructor
@Component
public class UserGatewayImpl implements UserGateway {

    private final UserMapper userMapper;

    @Override
    public UserEntity findPasswordInfo(String username) {
        UserDO userDO = userMapper.selectPassword(username);
        if (Objects.isNull(userDO) || Objects.isNull(userDO.getPassword())) {
            return null;
        }
        UserEntity userEntity = new UserEntity();
        userEntity.setPassword(new UserPassword(new UserPassword.EncryptPassword(userDO.getPassword())));
        userEntity.setName(userDO.getName());
        userEntity.setId(userDO.getId());
        return userEntity;
    }
}
```

ä¸‹é¢å†ç¼–å†™ UserMapper æ¥å£æ–¹æ³•

æ¨¡å—ï¼šlucky-infrastructure

åŒ…ï¼šcn.j3code.lucky.infrastructure.gateway.impl.database.mapper

```java
public interface UserMapper extends BaseMapper<UserDO> {

    UserDO selectPassword(@Param("username") String username);
}
```

mapper æ–‡ä»¶

```xml
<select id="selectPassword" resultType="cn.j3code.lucky.infrastructure.gateway.impl.database.dataobject.UserDO">
    select *
    from bld_lucky_user
    where username = #{username}
</select>
```

ç°åœ¨æˆ‘ä»¬æ‹‰å›åˆ° UserServiceImpl ç±»ï¼Œç”Ÿæˆ JWT å­—ç¬¦ä¸²æ–¹æ³•ã€‚

æ¨¡å—ï¼šbld-base-config

åŒ…ï¼šcn.j3code.bldbase.util

```java
@Slf4j
public class JwtUtil {

    /**
     * å¯†é’¥
     */
    private static final String SECRET = "j3code";

    /**
     * è¿‡æœŸæ—¶é—´ (å•ä½ä¸ºç§’)
     * 2 * 24 * 60 * 60L
     **/
    private static final Long EXPIRATION = 2 * 24 * 60 * 60L;

    /**
     * ç”Ÿæˆç”¨æˆ·token,è®¾ç½®tokenè¶…æ—¶æ—¶é—´
     */
    public static String createToken(Map<String, Object> data) {
        //è¿‡æœŸæ—¶é—´
        Date expireDate = new Date(System.currentTimeMillis() + EXPIRATION * 1000);
        Map<String, Object> map = new HashMap<>();
        map.put("alg", "HS256");
        map.put("typ", "JWT");
        JWTCreator.Builder builder = JWT.create()
                // æ·»åŠ å¤´éƒ¨
                .withHeader(map);
        //å¯ä»¥å°†åŸºæœ¬ä¿¡æ¯æ”¾åˆ°claimsä¸­
        data.forEach((key, value) -> builder.withClaim(key, value.toString()));

        return builder
                //è¶…æ—¶è®¾ç½®,è®¾ç½®è¿‡æœŸçš„æ—¥æœŸ
                .withExpiresAt(expireDate)
                //ç­¾å‘æ—¶é—´
                .withIssuedAt(new Date())
                //SECRETåŠ å¯†
                .sign(Algorithm.HMAC256(SECRET));
    }

    /**
     * æ ¡éªŒtokenå¹¶è§£ætoken
     */
    public static Map<String, Object> verifyToken(String token) {
        Map<String, Object> data = new HashMap<>();
        try {
            JWTVerifier verifier = JWT.require(Algorithm.HMAC256(SECRET)).build();
            DecodedJWT jwt = verifier.verify(token);
            jwt.getClaims().forEach((key, value) -> data.put(key, value.asString()));
        } catch (TokenExpiredException e) {
            log.error("token è¿‡æœŸ, {}", e.getMessage());
            throw new BldException("token è¿‡æœŸï¼");
        } catch (Exception e) {
            log.error("token è§£ç å¼‚å¸¸:", e);
            throw new BldException("éæ³• tokenï¼");
        }
        return data;
    }

    public static void main(String[] args) {
        String token = JwtUtil.createToken(Map.of("name", "J3"));
        System.out.println(token);
        Map<String, Object> stringObjectMap = JwtUtil.verifyToken(token);
        System.out.println(stringObjectMap);
    }
}
```

è‡³æ­¤å‘¢ï¼Œæˆ‘ä»¬çš„ç™»å½•æ–¹æ³•å°±ç®—å®Œæˆäº†ã€‚

### 10.3.3 ç¼–å†™è·å–ç”¨æˆ·ä¿¡æ¯åŠŸèƒ½

è·å–ç”¨æˆ·ä¿¡æ¯åŠŸèƒ½å¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªç®€å•çš„æŸ¥è¯¢åŠŸèƒ½ã€‚

æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯åˆ†ä¸¤ç§

1. å¸¦ id æŸ¥è¯¢
2. ä¸å¸¦ id æŸ¥å®ï¼Œåˆ™è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯

é‚£ä» controller å¼€å§‹ç¼–å†™ä»£ç 

æ¨¡å—ï¼šlucky-adapter

åŒ…ï¼šcn.j3code.lucky.adapter.web

```java
@Slf4j
@AllArgsConstructor
@ResponseResult
@RequestMapping("/v1/user")
public class UserController {

    private final IUserService userService;

    @GetMapping("/me")
    public UserVO me() {
        return userService.getUserInfo(SecurityUtil.getUserId());
    }
    
    @GetMapping("/one")
    public UserVO one(@RequestParam("id") Long id) {
        return userService.getUserInfo(id);
    }

}
```

ç¼–å†™ IUserService æ¥å£æ–¹æ³•

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.api

```java
public interface IUserService {
    /**
     * è·å–ç”¨æˆ·ä¿¡æ¯
     *
     * @param id ç”¨æˆ·ID
     * @return ç”¨æˆ·ä¿¡æ¯
     */
    UserVO getUserInfo(Long id);
}
```

ç¼–å†™ IUserService  å®ç°ç±»

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.service

```java
@Slf4j
@Service
@AllArgsConstructor
public class UserServiceImpl implements IUserService {

    private final UserListByParamQueryExe userListByParamQueryExe;

    @Override
    public UserVO getUserInfo(Long id) {
        return userListByParamQueryExe.execute(new UserListByParamQuery().setId(id)).getRecords().get(0);
    }

}
```

ç¼–å†™ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢æ‰§è¡Œå™¨

æ­¥éª¤ï¼š

1. æ„å»ºæŸ¥è¯¢æ¡ä»¶å¯¹è±¡
2. ç¼–å†™æŸ¥è¯¢æ‰§è¡Œæ–¹æ³•

å…ˆæ¥ç¼–å†™æŸ¥è¯¢æ¡ä»¶å¯¹è±¡

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.dto.query

```java
@Data
@Accessors(chain = true)
public class UserListByParamQuery extends PageQuery {

    private Long id;

    private String name;

    private String phone;
}
```

ç¼–å†™æ‰§è¡Œå™¨æ–¹æ³•

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.user.command.query

```java
@Component
@Slf4j
@AllArgsConstructor
public class UserListByParamQueryExe {
    private final UserGateway userGateway;

    public IPage<UserVO> execute(UserListByParamQuery query) {
        IPage<UserEntity> page = userGateway.findByParam(query);
        return page.convert(UserAssembler::toValueObject);
    }
}
```

æ‰§è¡Œå™¨çš„é€»è¾‘ä¸­åˆ†ä¸¤æ­¥ï¼š

1. è°ƒç”¨ UserGateway æ¥å£è·å–æ•°æ®
2. å°†å®ä½“æ•°æ®è½¬ä¸ºè§†å›¾æ•°æ®

å…ˆæ¥ç¼–å†™ UserGateway æ¥å£æ–¹æ³•

æ¨¡å—ï¼šlucky-domain

åŒ…ï¼šcn.j3code.lucky.domain.gateway

```java
public interface UserGateway {
    /**
     * æ ¹æ®æ¡ä»¶æŸ¥è¯¢
     *
     * @param query ç”¨æˆ·åç­‰
     * @return List ç”¨æˆ·å®ä½“
     */
    IPage<UserEntity> findByParam(UserListByParamQuery query);
}
```

ç¼–å†™ UserGateway æ¥å£å®ç°ç±»

æ¨¡å—ï¼šlucky-infrastructure

åŒ…ï¼šcn.j3code.lucky.infrastructure.gateway.impl

```java
@Slf4j
@AllArgsConstructor
@Component
public class UserGatewayImpl implements UserGateway {

    private final UserMapper userMapper;

    @Override
    public IPage<UserEntity> findByParam(UserListByParamQuery query) {
        IPage<UserDO> page = userMapper.findByParam(new Page<UserDO>(query.getPageIndex(), query.getPageSize()), query);
        return page.convert(UserConvertor::toEntity);
    }
}
```

ç¼–å†™ UserMapper æ¥å£æ–¹æ³•

æ¨¡å—ï¼šlucky-infrastructure

åŒ…ï¼šcn.j3code.lucky.infrastructure.gateway.impl.database.mapper

```java
public interface UserMapper extends BaseMapper<UserDO> {
    IPage<UserDO> findByParam(@Param("page") Page<UserDO> page, @Param("query") UserListByParamQuery query);
}
```

ç¼–å†™ mapper æ–‡ä»¶

```xml
<select id="findByParam"
        resultType="cn.j3code.lucky.infrastructure.gateway.impl.database.dataobject.UserDO">
    select * from bld_lucky_user
    <where>
        <if test="query.name != null and query.name != ''">
            and name like concat('%',#{query.name},'%')
        </if>
        <if test="query.phone != null and query.phone != ''">
            and phone = #{query.phone}
        </if>
        <if test="query.id != null ">
            and id = #{query.id}
        </if>
    </where>
</select>
```

okï¼Œé‚£æˆ‘æ¥å›åˆ° UserServiceImpl æ–¹æ³•ï¼Œç¼–å†™å¯¹è±¡è½¬æ¢æ–¹æ³•

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.user.assembler

```java
public class UserAssembler {
    public static UserVO toValueObject(UserEntity userEntity) {
        UserVO userVO = new UserVO();
        userVO.setId(userEntity.getId());
        userVO.setName(userEntity.getName());
        userVO.setPhone(userEntity.getPhone());
        userVO.setUsername(userEntity.getUsername().getName());
        return userVO;
    }
}
```

### 10.3.4 ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯åŠŸèƒ½

ç¼–å†™ç”¨æˆ·ä¿®æ”¹å­—æ®µå¯¹è±¡

æ¨¡å—ï¼šlucky-client

 åŒ…ï¼šcn.j3code.lucky.client.dto

```java
@Data
public class UserModifyCmd extends Command {

    @NotNull(message = "idä¸èƒ½ä¸ºç©º")
    private Long id;

    /**
     * å§“å
     */
    @NotNull(message = "å§“åä¸èƒ½ä¸ºç©º")
    private String name;

    @NotNull(message = "è´¦å·ä¸èƒ½ä¸ºç©º")
    private String username;

    /**
     * æ‰‹æœºå·
     */
    @NotNull(message = "æ‰‹æœºå·ä¸èƒ½ä¸ºç©º")
    private String phone;

    /**
     * å¯†ç 
     */
    //@NotNull(message = "å¯†ç ä¸èƒ½ä¸ºç©º")
    private String password;

}
```

ç¼–å†™ controller

æ¨¡å—ï¼šlucky-client

 åŒ…ï¼šcn.j3code.lucky.adapter.web

```java
@Slf4j
@AllArgsConstructor
@ResponseResult
@RequestMapping("/v1/user")
public class UserController {

    private final IUserService userService;

    @PostMapping("/update")
    public UserVO update(@Validated @RequestBody UserModifyCmd cmd) {
        cmd.setId(SecurityUtil.getUserId());
        return userService.modify(cmd);
    }
}
```

ç¼–å†™ IUserService æ¥å£æ–¹æ³•

æ¨¡å—ï¼šlucky-client

 åŒ…ï¼šcn.j3code.lucky.client.api

```java
public interface IUserService {
    /**
     * ç”¨æˆ·ä¿¡æ¯ä¿®æ”¹
     *
     * @param cmd ç”¨æˆ·ä¿¡æ¯ä¿®æ”¹è¯·æ±‚
     * @return Response
     */
    UserVO modify(UserModifyCmd cmd);
}
```

å®ç°ç±»ç¼–å†™

æ¨¡å—ï¼šlucky-app

 åŒ…ï¼šcn.j3code.lucky.app.service

```java
@Slf4j
@Service
@AllArgsConstructor
public class UserServiceImpl implements IUserService {
    
    private final UserModifyCmdExe userModifyCmdExe;

    @Override
    public UserVO modify(UserModifyCmd cmd) {
        return userModifyCmdExe.execute(cmd);
    }
}
```

ç¼–å†™ä¿®æ”¹æ‰§è¡Œå™¨

æ¨¡å—ï¼šlucky-app

 åŒ…ï¼šcn.j3code.lucky.app.user.command

```java
@Component
@Slf4j
@AllArgsConstructor
public class UserModifyCmdExe {

    private final UserGateway userGateway;
    public UserVO execute(UserModifyCmd cmd) {
        // check ç”¨æˆ·åæ˜¯å¦é‡å¤
        if (userGateway.checkByUsername(cmd.getId(), cmd.getUsername())) {
            throw new BldBizException(ErrorCode.B_USER_USERNAME_REPEAT);
        }

        UserEntity userEntity = userGateway.save(UserAssembler.toEntity(cmd));
        return UserAssembler.toValueObject(userEntity);
    }
}
```

è¿™é‡Œçš„ä¿®æ”¹æ–¹æ³•ä¹Ÿæ˜¯è°ƒç”¨çš„ save æ–¹æ³•ï¼Œå› ä¸ºåœ¨æ³¨å†Œçš„æ—¶å€™æˆ‘ä»¬å¯¹ä¼ å…¥çš„å¯¹è±¡ä¸­çš„ id è¿›è¡Œäº†åˆ¤æ–­ï¼Œå¦‚æœ id æœ‰å€¼åˆ™ä¸ºä¿®æ”¹ï¼Œåä¹‹åˆ™ä¸ºä¿å­˜ã€‚

è‡³æ­¤æˆ‘ä»¬çš„ä¸€ä¸ªç”¨æˆ·æ¨¡å—å°±ç®—æ˜¯ç¼–å†™å®Œæˆäº†

## 10.4 å¥–å“ç›¸å…³åŠŸèƒ½å¼€å‘

å¥–å“è¯´ç™½äº†å°±æ˜¯ä¸€ä¸ªå•†å“ï¼Œåœ¨æŠ½å¥–è¿‡ç¨‹ä¸­ï¼Œå¦‚æœç”¨æˆ·ä¸­å¥–äº†é‚£ä¹ˆå°±éœ€è¦ç»™ä»–ä»¬å‘æ”¾å¯¹åº”å¥–é¡¹çš„å¥–å“ã€‚ä¾‹å¦‚ï¼šä¸€ç­‰å¥–è‹¹æœç”µè„‘ï¼Œé‚£è¿™ä¸ªè‹¹æœç”µè„‘å°±æ˜¯æŠ½å¥–çš„å¥–å“ï¼Œä¸€ç­‰å¥–å°±æ˜¯å¥–é¡¹ã€‚

ä¸‹é¢æˆ‘ä»¬æ¥å¼€å‘å¥–å“åŠŸèƒ½ã€‚

å…ˆæ¥åˆ†æå¥–å“æœ‰å“ªäº›åŠŸèƒ½ï¼š

1. æ·»åŠ å¥–å“
2. ä¿®æ”¹å¥–å“
3. è·å–å¥–å“åˆ—è¡¨

å¥–å“æ•°æ®é™åˆ¶æœ‰ï¼š

1. å¥–å“åº“å­˜æ•°é‡å¿…é¡»å¤§äºç­‰äº 1

ä¸‹é¢æˆ‘ä»¬æ¥å¼€å§‹ç¼–ç ã€‚

1ã€å¥–å“å®ä½“

æ¨¡å—ï¼šlucky-infrastructure

åŒ…ï¼šcn.j3code.lucky.infrastructure.gateway.impl.database.dataobject

```java
@TableName(value ="bld_lucky_prize")
@Data
public class PrizeDO implements Serializable {
    /**
     * 
     */
    @TableId(type = IdType.AUTO)
    private Long id;

    /**
     * å¥–å“åç§°
     */
    private String prizeName;

    /**
     * å¥–å“åº“å­˜
     */
    private Long inventory;

    /**
     * 
     */
    private LocalDateTime creatTime;

    /**
     * 
     */
    private String creator;

    /**
     * 
     */
    private LocalDateTime updateTime;

    /**
     * 
     */
    private String updater;

    @TableField(exist = false)
    private static final long serialVersionUID = 1L;
}
```

2ã€ç¼–å†™é¢†åŸŸå®ä½“

æ¨¡å—ï¼šlucky-domain

åŒ…ï¼šcn.j3code.lucky.domain.prize

```java
@Data
public class PrizeEntity {

    private Long id;

    /**
     * å¥–å“åç§°
     */
    private String prizeName;

    /**
     * å¥–å“åº“å­˜
     */
    private PrizeInventory inventory;

    /**
     *
     */
    private LocalDateTime updateTime;

    /**
     *
     */
    private String updater;
}
```

3ã€ç¼–å†™å€¼å¯¹è±¡

æ¨¡å—ï¼šlucky-domain

åŒ…ï¼šcn.j3code.lucky.domain.prize

```java
public class PrizeInventory {

    /**
     * å¥–å“åº“å­˜
     */
    private Long inventory;

    public PrizeInventory(Long inventory) {
        if (Objects.isNull(inventory) || inventory < 1) {
            throw new ValidationException("åº“å­˜ä¸èƒ½å°äº 1");
        }
        this.inventory = inventory;
    }

    public Long getInventory() {
        return inventory;
    }
}
```

4ã€ç¼–å†™è§†å›¾å¯¹è±¡

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.dto.data

```java
@Data
public class PrizeVO {

    private Long id;

    /**
     * å¥–å“åç§°
     */
    private String prizeName;

    /**
     * å¥–å“åº“å­˜
     */
    private Long inventory;

    /**
     *
     */
    private LocalDateTime updateTime;

    /**
     *
     */
    private String updater;

}
```

### 10.4.1 ç¼–å†™å¥–å“åŠŸèƒ½

æœ‰äº†ä¸ŠèŠ‚ç”¨æˆ·åŠŸèƒ½å¼€å‘æµç¨‹ï¼Œè¿™æ¬¡æˆ‘ä»¬å°±ä¸åˆ†é‚£ä¹ˆç»†äº†ï¼Œç›´æ¥ä¸€ä¸ªæ­¥éª¤æŠŠå¤šä¸ªåŠŸèƒ½å†™å‡ºæ¥ã€‚

1ã€ç¼–å†™ IPrizeService ä¸šåŠ¡æ¥å£åŠŸèƒ½

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.api

```java
public interface IPrizeService {

    IPage<PrizeVO> list(PrizeListByParamQuery query);

    PrizeVO one(Long id);

    PrizeVO add(PrizeAddCmd cmd);

    PrizeVO update(PrizeModifyCmd cmd);
}
```

2ã€ç¼–å†™ cmd åŠ query å¯¹è±¡

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.dto.query

```java
@Data
@Accessors(chain = true)
public class PrizeListByParamQuery extends PageQuery {

    private Long id;
    private String name;
}
```

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.dto

```java
@Data
public class PrizeAddCmd  extends Command {

    /**
     * å¥–å“åç§°
     */
    @NotNull(message = "å¥–å“åç§°ä¸èƒ½ä¸ºç©º")
    private String prizeName;

    /**
     * å¥–å“åº“å­˜
     */
    @NotNull(message = "å¥–å“åº“å­˜ä¸èƒ½ä¸ºç©º")
    private Long inventory;

}
```

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.dto

```java
@Data
public class PrizeModifyCmd  extends Command {

    @NotNull(message = "idä¸èƒ½ä¸ºç©º")
    private Long id;

    /**
     * å¥–å“åç§°
     */
    @NotNull(message = "å¥–å“åç§°ä¸èƒ½ä¸ºç©º")
    private String prizeName;

    /**
     * å¥–å“åº“å­˜
     */
    @NotNull(message = "å¥–å“åº“å­˜ä¸èƒ½ä¸ºç©º")
    private Long inventory;

}
```

3ã€ç¼–å†™ PrizeController åŠŸèƒ½

æ¨¡å—ï¼šlucky-adapter

åŒ…ï¼šcn.j3code.lucky.adapter.web

```java
@Slf4j
@AllArgsConstructor
@ResponseResult
@RequestMapping("/v1/prize")
public class PrizeController {

    private final IPrizeService prizeService;

    @PostMapping("/add")
    public PrizeVO add(@Validated @RequestBody PrizeAddCmd cmd) {
        return prizeService.add(cmd);
    }

    @PostMapping("/update")
    public PrizeVO update(@Validated @RequestBody PrizeModifyCmd cmd) {
        return prizeService.update(cmd);
    }

    @GetMapping("/one")
    public PrizeVO one(@RequestParam("id") Long id) {
        return prizeService.one(id);
    }

    @PostMapping("/list")
    public IPage<PrizeVO> list(@RequestBody PrizeListByParamQuery query) {
        return prizeService.list(query);
    }

}
```

4ã€ç¼–å†™ IPrizeService ä¸šåŠ¡æ¥å£å®ç°ç±»

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.service

```java
@Slf4j
@Service
@AllArgsConstructor
public class PrizeServiceImpl implements IPrizeService {

    private final PrizeAddCmdExe prizeAddCmdExe;
    private final PrizeModifyCmdExe prizeModifyCmdExe;
    private final PrizeListByParamQueryExe prizeListByParamQueryExe;

    @Override
    public IPage<PrizeVO> list(PrizeListByParamQuery query) {
        return prizeListByParamQueryExe.execute(query);
    }

    @Override
    public PrizeVO one(Long id) {
        return prizeListByParamQueryExe.execute(new PrizeListByParamQuery().setId(id)).getRecords().get(0);
    }

    @Override
    public PrizeVO add(PrizeAddCmd cmd) {
        return prizeAddCmdExe.execute(cmd);
    }

    @Override
    public PrizeVO update(PrizeModifyCmd cmd) {
        return prizeModifyCmdExe.execute(cmd);
    }
}
```

5ã€ç¼–å†™å¯¹åº”çš„æ‰§è¡Œå™¨

æŸ¥è¯¢æ‰§è¡Œå™¨

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.prize.command.query

```java
@Component
@Slf4j
@AllArgsConstructor
public class PrizeListByParamQueryExe {
    private final PrizeGateway prizeGateway;

    public IPage<PrizeVO> execute(PrizeListByParamQuery query) {
        if (Objects.nonNull(query.getId())) {
            return new Page<PrizeVO>()
                    .setTotal(1)
                    .setRecords(List.of(PrizeAssembler.toValueObject(prizeGateway.one(query.getId()))));
        }
        IPage<PrizeEntity> page = prizeGateway.list(query);
        return page.convert(PrizeAssembler::toValueObject);
    }
}
```

å¯¹è±¡è½¬åŒ–

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.prize.assembler

```java
public class PrizeAssembler {
    public static PrizeEntity toEntity(PrizeAddCmd cmd) {
        PrizeEntity prizeEntity = new PrizeEntity();
        prizeEntity.setPrizeName(cmd.getPrizeName());
        prizeEntity.setInventory(new PrizeInventory(cmd.getInventory()));
        return prizeEntity;
    }

    public static PrizeEntity toEntity(PrizeModifyCmd cmd) {
        PrizeEntity prizeEntity = new PrizeEntity();
        prizeEntity.setId(cmd.getId());
        prizeEntity.setPrizeName(cmd.getPrizeName());
        prizeEntity.setInventory(new PrizeInventory(cmd.getInventory()));
        return prizeEntity;
    }

    public static PrizeVO toValueObject(PrizeEntity prizeEntity) {
        PrizeVO prizeVO = new PrizeVO();
        prizeVO.setId(prizeEntity.getId());
        prizeVO.setPrizeName(prizeEntity.getPrizeName());
        prizeVO.setInventory(prizeEntity.getInventory().getInventory());
        prizeVO.setUpdater(prizeEntity.getUpdater());
        prizeVO.setUpdateTime(prizeEntity.getUpdateTime());
        return prizeVO;
    }
}
```

æ·»åŠ æ‰§è¡Œå™¨

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.prize.command

```java
@Component
@Slf4j
@AllArgsConstructor
public class PrizeAddCmdExe {

    private final PrizeGateway prizeGateway;

    public PrizeVO execute(PrizeAddCmd cmd){
        PrizeEntity prizeEntity = prizeGateway.save(PrizeAssembler.toEntity(cmd));
        return PrizeAssembler.toValueObject(prizeEntity);
    }
}
```

ä¿®æ”¹æ‰§è¡Œå™¨

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.prize.command

```java
@Component
@Slf4j
@AllArgsConstructor
public class PrizeModifyCmdExe {
    private final PrizeGateway prizeGateway;
    public PrizeVO execute(PrizeModifyCmd cmd){
        PrizeEntity prizeEntity = prizeGateway.save(PrizeAssembler.toEntity(cmd));
        return PrizeAssembler.toValueObject(prizeEntity);
    }
}
```

6ã€ç¼–å†™ PrizeGateway æ¥å£

æ¨¡å—ï¼šlucky-domain

åŒ…ï¼šcn.j3code.lucky.domain.gateway

```java
public interface PrizeGateway {

    PrizeEntity save(PrizeEntity entity);

    PrizeEntity one(Long id);

    IPage<PrizeEntity> list(PrizeListByParamQuery query);

    int updateInventory(Long prizeId, Integer number);
}
```

7ã€ç¼–å†™ PrizeGateway æ¥å£å®ç°ç±»

æ¨¡å—ï¼šlucky-infrastructure

åŒ…ï¼šcn.j3code.lucky.infrastructure.gateway.impl

```java
@Slf4j
@AllArgsConstructor
@Component
public class PrizeGatewayImpl implements PrizeGateway {

    private final PrizeMapper prizeMapper;

    @Override
    public PrizeEntity save(PrizeEntity entity) {
        // æ–°å¢
        if (Objects.isNull(entity.getId())) {
            return add(entity);
        }

        // ä¿®æ”¹
        return modify(entity);
    }

    private PrizeEntity modify(PrizeEntity entity) {
        PrizeDO prizeDO = PrizeConvertor.toUpdateDO(entity);
        int update = prizeMapper.updateById(prizeDO);
        if (update < 1) {
            throw new PersistenceException("æ›´æ–°æ•°æ®å¼‚å¸¸");
        }
        return PrizeConvertor.toEntity(prizeDO);
    }

    private PrizeEntity add(PrizeEntity entity) {
        PrizeDO prizeDO = PrizeConvertor.toAddDO(entity);
        int insert = prizeMapper.insert(prizeDO);
        if (insert < 1) {
            throw new PersistenceException("æ‹†å…¥æ•°æ®å¼‚å¸¸");
        }
        return PrizeConvertor.toEntity(prizeDO);
    }

    @Override
    public PrizeEntity one(Long id) {
        PrizeDO prizeDO = prizeMapper.selectById(id);
        if (Objects.isNull(prizeDO)) {
            throw new BldBizException(ErrorCode.DATA_UNDEFINED);
        }
        return PrizeConvertor.toEntity(prizeDO);
    }

    @Override
    public IPage<PrizeEntity> list(PrizeListByParamQuery query) {
        IPage<PrizeDO> page = prizeMapper.list(new Page<>(query.getPageIndex(), query.getPageSize()), query);
        return page.convert(PrizeConvertor::toEntity);
    }

    @Override
    public int updateInventory(Long prizeId, Integer number) {
        return prizeMapper.updateInventory(prizeId, number);
    }
}
```

å¯¹è±¡è½¬æ¢ç±»

æ¨¡å—ï¼šlucky-domain

åŒ…ï¼šcn.j3code.lucky.infrastructure.convertor

```java
public class PrizeConvertor {

    public static PrizeDO toUpdateDO(PrizeEntity entity) {
        PrizeDO prizeDO = new PrizeDO();
        prizeDO.setId(entity.getId());
        prizeDO.setPrizeName(entity.getPrizeName());
        prizeDO.setInventory(entity.getInventory().getInventory());
        prizeDO.setUpdateTime(LocalDateTime.now());
        prizeDO.setUpdater(SecurityUtil.getName());
        return prizeDO;
    }

    public static PrizeDO toAddDO(PrizeEntity entity) {
        PrizeDO prizeDO = new PrizeDO();
        prizeDO.setPrizeName(entity.getPrizeName());
        prizeDO.setInventory(entity.getInventory().getInventory());
        prizeDO.setCreatTime(LocalDateTime.now());
        prizeDO.setCreator(SecurityUtil.getName());
        prizeDO.setUpdateTime(LocalDateTime.now());
        prizeDO.setUpdater(SecurityUtil.getName());

        return prizeDO;
    }

    public static PrizeEntity toEntity(PrizeDO prizeDO) {
        PrizeEntity prizeEntity = new PrizeEntity();
        prizeEntity.setId(prizeDO.getId());
        prizeEntity.setPrizeName(prizeDO.getPrizeName());
        prizeEntity.setInventory(new PrizeInventory(prizeDO.getInventory()));
        prizeEntity.setUpdater(prizeDO.getUpdater());
        prizeEntity.setUpdateTime(prizeDO.getUpdateTime());
        return prizeEntity;
    }
}
```

8ã€ç¼–å†™ PrizeMapper æ¥å£åŠmapperæ–‡ä»¶

æ¨¡å—ï¼šlucky-infrastructure

åŒ…ï¼šcn.j3code.lucky.infrastructure.gateway.impl.database.mapper

```java
public interface PrizeMapper extends BaseMapper<PrizeDO> {


    IPage<PrizeDO> list(@Param("page") Page<PrizeDO> page, @Param("query") PrizeListByParamQuery query);

    int updateInventory(@Param("prizeId") Long prizeId, @Param("number") Integer number);
}
```

```xml
<update id="updateInventory">
    update bld_lucky_prize
    set inventory = inventory + #{number}
    where id = #{prizeId}
      and inventory > 0
</update>
<select id="list" resultType="cn.j3code.lucky.infrastructure.gateway.impl.database.dataobject.PrizeDO">
    select * from bld_lucky_prize
    <where>
        <if test="query.name != null and query.name != ''">
            and prize_name like concat('%',#{query.name},'%')
        </if>
        <if test="query.id != null ">
            and id = #{query.id}
        </if>
    </where>
    order by update_time desc
</select>
```

## 10.5 å¥–é¡¹ç›¸å…³åŠŸèƒ½å¼€å‘

å¥–é¡¹å’Œå¥–å“åŠŸèƒ½ç±»ä¼¼ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹çœ‹æœ‰å•¥å¥–é¡¹ç›¸å…³å®ä½“ã€‚

1ã€å¥–é¡¹å®ä½“

æ¨¡å—ï¼šlucky-infrastructure

åŒ…ï¼šcn.j3code.lucky.infrastructure.gateway.impl.database.dataobject

```java
@TableName(value ="bld_lucky_award")
@Data
public class AwardDO implements Serializable {
    /**
     * 
     */
    @TableId(type = IdType.AUTO)
    private Long id;


    private String awardName;

    /**
     * æ´»åŠ¨id
     */
    private Long activityId;

    /**
     * å¥–å“id
     */
    private Long prizeId;

    @TableField(exist = false)
    private String prizeName;

    /**
     * æ•°é‡
     */
    private Integer number;

    /**
     * æ¦‚ç‡
     */
    private Double probability;

    /**
     * 
     */
    private LocalDateTime creatTime;

    /**
     * 
     */
    private String creator;

    /**
     * 
     */
    private LocalDateTime updateTime;

    /**
     * 
     */
    private String updater;

    @TableField(exist = false)
    private static final long serialVersionUID = 1L;
}
```

2ã€å¥–é¡¹é¢†åŸŸå®ä½“

æ¨¡å—ï¼šlucky-domain

åŒ…ï¼šcn.j3code.lucky.domain.award

```java
@Data
public class AwardEntity {
    private Long id;

    /**
     * å¥–é¡¹åç§°
     */
    private String awardName;

    /**
     * æ´»åŠ¨id
     */
    private Long activityId;

    /**
     * å¥–å“id
     */
    private Long prizeId;

    private String prizeName;


    /**
     * æ•°é‡
     */
    private AwardMaxNumber number;

    /**
     * æ¦‚ç‡
     */
    private Double probability;


    /**
     *
     */
    private LocalDateTime updateTime;

    /**
     *
     */
    private String updater;
}
```

3ã€å¥–é¡¹å€¼å¯¹è±¡

æ¨¡å—ï¼šlucky-domain

åŒ…ï¼šcn.j3code.lucky.domain.award

```java
@Getter
public class AwardMaxNumber {
    private Integer number;

    public AwardMaxNumber(Integer number) {
        if (number != -1 && number < 0){
            throw new ValidationException("å¥–å“æ•°é‡å¿…é¡»å¤§äºç­‰äº 0 æˆ–è€…ä¸é™ï¼ˆ-1ï¼‰ï¼");
        }
        this.number = number;
    }

    public Boolean isEffective(){
        if (number > 0 || number == -1){
            return Boolean.TRUE;
        }
        return Boolean.FALSE;
    }

    public Boolean isPrize(){
        if (number == -1){
            return Boolean.FALSE;
        }
        return Boolean.TRUE;
    }
}
```

4ã€ç¼–å†™è§†å›¾å¯¹è±¡

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.dto.data

```java
@Data
public class AwardVO {

    private Long id;

    /**
     * å¥–é¡¹åç§°
     */
    private String awardName;

    /**
     * æ´»åŠ¨id
     */
    private Long activityId;

    /**
     * å¥–å“id
     */
    private Long prizeId;

    private String prizeName;

    private Boolean isPrize;

    /**
     * æ•°é‡
     */
    private Integer number;

    /**
     * æ¦‚ç‡
     */
    private Double probability;


    /**
     *
     */
    private LocalDateTime updateTime;

    /**
     *
     */
    private String updater;

}
```

ä¸‹é¢å°±æ˜¯åŠŸèƒ½å®ç°äº†ã€‚

### 10.5.1 ç¼–å†™å¥–é¡¹åŠŸèƒ½

1ã€ç¼–å†™ IAwardService ä¸šåŠ¡æ¥å£åŠŸèƒ½

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.api

```java
public interface IAwardService {

    IPage<AwardVO> list(AwardListByParamQuery query);

    AwardVO one(Long id);

    AwardVO add(AwardAddCmd cmd);

    AwardVO update(AwardModifyCmd cmd);

}
```

2ã€ç¼–å†™ cmd åŠ query å¯¹è±¡

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.dto.query

```java
@Data
@Accessors(chain = true)
public class AwardListByParamQuery  extends PageQuery {

    private Long id;

    /**
     * å¥–é¡¹åç§°
     */
    private String awardName;

    /**
     * æ´»åŠ¨id
     */
    private Long activityId;

    /**
     * å¥–å“id
     */
    private Long prizeId;

}
```

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.dto

```java
@Data
public class AwardAddCmd  extends Command {

    /**
     * æ´»åŠ¨id
     */
    //@NotNull(message = "æ´»åŠ¨idä¸èƒ½ä¸ºç©º")
    private Long activityId;

    /**
     * å¥–å“id
     */
    @NotNull(message = "å¥–å“idä¸èƒ½ä¸ºç©º")
    private Long prizeId;

    /**
     * å¥–é¡¹åç§°
     */
    @NotNull(message = "å¥–é¡¹åç§°ä¸èƒ½ä¸ºç©º")
    private String awardName;

    /**
     * æ•°é‡
     */
    @NotNull(message = "æ•°é‡ä¸èƒ½ä¸ºç©º")
    private Integer number;

    /**
     * æ¦‚ç‡
     */
    @NotNull(message = "æ¦‚ç‡ä¸èƒ½ä¸ºç©º")
    private Double probability;

}
```

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.dto

```java
@Data
public class AwardModifyCmd  extends Command {
    @NotNull(message = "idä¸èƒ½ä¸ºç©º")
    private Long id;

    /**
     * æ´»åŠ¨id
     */
    @NotNull(message = "æ´»åŠ¨idä¸èƒ½ä¸ºç©º")
    private Long activityId;

    /**
     * å¥–å“id
     */
    @NotNull(message = "å¥–å“idä¸èƒ½ä¸ºç©º")
    private Long prizeId;

    /**
     * å¥–é¡¹åç§°
     */
    @NotNull(message = "å¥–é¡¹åç§°ä¸èƒ½ä¸ºç©º")
    private String awardName;

    /**
     * æ•°é‡
     */
    @NotNull(message = "æ•°é‡ä¸èƒ½ä¸ºç©º")
    private Integer number;

    /**
     * æ¦‚ç‡
     */
    @NotNull(message = "æ¦‚ç‡ä¸èƒ½ä¸ºç©º")
    private Double probability;
}
```

3ã€ç¼–å†™ AwardController 

æ¨¡å—ï¼šlucky-adapter

åŒ…ï¼šcn.j3code.lucky.adapter.web

```java
@Slf4j
@AllArgsConstructor
@ResponseResult
@RequestMapping("/admin/v1/award")
public class AwardController {

    private final IAwardService AwardService;

    @PostMapping("/add")
    public AwardVO add(@Validated @RequestBody AwardAddCmd cmd) {
        return AwardService.add(cmd);
    }

    @PostMapping("/update")
    public AwardVO update(@Validated @RequestBody AwardModifyCmd cmd) {
        return AwardService.update(cmd);
    }

    @GetMapping("/one")
    public AwardVO one(@RequestParam("id") Long id) {
        return AwardService.one(id);
    }

    @PostMapping("/list")
    public IPage<AwardVO> list(@RequestBody AwardListByParamQuery query) {
        return AwardService.list(query);
    }

}
```

4ã€ç¼–å†™ IAwardService ä¸šåŠ¡æ¥å£å®ç°ç±»

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.service

```java
@Slf4j
@Service
@AllArgsConstructor
public class AwardServiceImpl implements IAwardService {

    private final AwardListByParamQueryExe awardListByParamQueryExe;
    private final AwardAddCmdExe awardAddCmdExe;
    private final AwardModifyCmdExe awardModifyCmdExe;

    @Override
    public IPage<AwardVO> list(AwardListByParamQuery query) {
        return awardListByParamQueryExe.execute(query);
    }

    @Override
    public AwardVO one(Long id) {
        return awardListByParamQueryExe.execute(new AwardListByParamQuery().setId(id)).getRecords().get(0);
    }

    @Override
    public AwardVO add(AwardAddCmd cmd) {
        return awardAddCmdExe.execute(cmd);
    }

    @Override
    public AwardVO update(AwardModifyCmd cmd) {
        return awardModifyCmdExe.execute(cmd);
    }
}
```

å¯¹è±¡è½¬åŒ–

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.award.assembler

```java
public class AwardAssembler {
    public static AwardVO toVauelObject(AwardEntity entity) {
        AwardVO awardVO = new AwardVO();
        awardVO.setId(entity.getId());
        awardVO.setAwardName(entity.getAwardName());
        awardVO.setActivityId(entity.getActivityId());
        awardVO.setPrizeId(entity.getPrizeId());
        awardVO.setIsPrize(entity.getNumber().isPrize());
        awardVO.setPrizeName(entity.getPrizeName());
        awardVO.setNumber(entity.getNumber().getNumber());
        awardVO.setProbability(entity.getProbability());
        awardVO.setUpdateTime(entity.getUpdateTime());
        awardVO.setUpdater(entity.getUpdater());

        return awardVO;
    }

    public static AwardEntity toEntity(AwardAddCmd cmd) {
        AwardEntity awardEntity = new AwardEntity();
        awardEntity.setAwardName(cmd.getAwardName());
        awardEntity.setActivityId(cmd.getActivityId());
        awardEntity.setPrizeId(cmd.getPrizeId());
        awardEntity.setNumber(new AwardMaxNumber(cmd.getNumber()));
        awardEntity.setProbability(cmd.getProbability());

        return awardEntity;
    }

    public static AwardEntity toEntity(AwardModifyCmd cmd) {
        AwardEntity awardEntity = new AwardEntity();
        awardEntity.setId(cmd.getId());
        awardEntity.setAwardName(cmd.getAwardName());
        awardEntity.setActivityId(cmd.getActivityId());
        awardEntity.setPrizeId(cmd.getPrizeId());
        awardEntity.setNumber(new AwardMaxNumber(cmd.getNumber()));
        awardEntity.setProbability(cmd.getProbability());

        return awardEntity;
    }

    public static AwardVO toDrawRecordVauelObject(AwardEntity awardEntity) {
        AwardVO awardVO = new AwardVO();
        awardVO.setId(awardEntity.getId());
        awardVO.setAwardName(awardEntity.getAwardName());
        awardVO.setPrizeName(awardEntity.getPrizeName());

        return awardVO;
    }
}
```

5ã€ç¼–å†™å¯¹åº”çš„æ‰§è¡Œå™¨

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.award.command.query

```java
@Component
@Slf4j
@AllArgsConstructor
public class AwardListByParamQueryExe {
    private final AwardGateway awardGateway;

    public IPage<AwardVO> execute(AwardListByParamQuery query) {
        if (Objects.nonNull(query.getId())) {
            return new Page<AwardVO>()
                    .setTotal(1)
                    .setRecords(List.of(AwardAssembler.toVauelObject(awardGateway.getById(query.getId()))));
        }
        IPage<AwardEntity> page = awardGateway.list(query);
        return page.convert(AwardAssembler::toVauelObject);
    }

}
```

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.award.command

```java
@Component
@Slf4j
@AllArgsConstructor
public class AwardAddCmdExe {
    private final AwardGateway awardGateway;
    private final PrizeGateway prizeGateway;

    public AwardVO execute(AwardAddCmd cmd) {
        AwardEntity awardEntity = AwardAssembler.toEntity(cmd);

        // å¥–é¡¹ä¸æ˜¯ è°¢è°¢å‚ä¸ ä¹‹ç±»çš„å°±è¦å»æ‰£é™¤å¥–å“åº“å­˜
        if (awardEntity.getNumber().isPrize()){
            int update = prizeGateway.updateInventory(cmd.getPrizeId(), cmd.getNumber() * -1);
            if (update < 1) {
                throw new BldBizException(ErrorCode.ACTIVITY_ADD_ERROR_PRIZE_INVENTORY);
            }
        }
        AwardEntity save = awardGateway.save(awardEntity);
        return AwardAssembler.toVauelObject(save);
    }

    public List<AwardVO> execute(List<AwardAddCmd> cmds) {
        List<AwardVO> data = new ArrayList<>();
        cmds.forEach(item -> data.add(execute(item)));
        return data;
    }
}
```

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.award.command

```java
@Component
@Slf4j
@AllArgsConstructor
public class AwardModifyCmdExe {
    private final AwardGateway awardGateway;
    public AwardVO execute(AwardModifyCmd cmd){
        AwardEntity save = awardGateway.save(AwardAssembler.toEntity(cmd));
        return AwardAssembler.toVauelObject(save);
    }
    public List<AwardVO> execute(List<AwardModifyCmd> cmds){
        List<AwardVO> data = new ArrayList<>();
        cmds.forEach(item -> data.add(execute(item)));
        return data;
    }
}
```

6ã€ç¼–å†™ AwardGateway æ¥å£

æ¨¡å—ï¼šlucky-domain

åŒ…ï¼šcn.j3code.lucky.domain.gateway

```java
public interface AwardGateway {

    AwardEntity save(AwardEntity entity);

    AwardEntity getById(Long id);

    IPage<AwardEntity> list(AwardListByParamQuery query);

    int updateAwardInventory(Long id, Integer number, int value);
}
```

7ã€ç¼–å†™ AwardGateway æ¥å£å®ç°ç±»

æ¨¡å—ï¼šlucky-infrastructure

åŒ…ï¼šcn.j3code.lucky.infrastructure.gateway.impl

```java
@Slf4j
@AllArgsConstructor
@Component
public class AwardGatewayImpl implements AwardGateway {
    private final AwardMapper awardMapper;

    @Override
    public AwardEntity save(AwardEntity entity) {
        // æ–°å¢
        if (Objects.isNull(entity.getId())) {
            return add(entity);
        }

        // ä¿®æ”¹
        return modify(entity);
    }

    private AwardEntity modify(AwardEntity entity) {
        AwardDO awardDO = AwardConvertor.toUpdateDO(entity);
        int update = awardMapper.updateById(awardDO);
        if (update < 1) {
            throw new PersistenceException("æ›´æ–°æ•°æ®å¼‚å¸¸");
        }
        return AwardConvertor.toEntity(awardDO);
    }

    private AwardEntity add(AwardEntity entity) {
        AwardDO awardDO = AwardConvertor.toAddDO(entity);
        int insert = awardMapper.insert(awardDO);
        if (insert < 1) {
            throw new PersistenceException("æ’å…¥æ•°æ®å¼‚å¸¸");
        }
        return AwardConvertor.toEntity(awardDO);
    }

    @Override
    public AwardEntity getById(Long id) {
        List<AwardEntity> list = list(new AwardListByParamQuery().setId(id)).getRecords();
        if (CollectionUtils.isEmpty(list)) {
            throw new BldBizException(ErrorCode.DATA_UNDEFINED);
        }
        return list.get(0);
    }

    @Override
    public IPage<AwardEntity> list(AwardListByParamQuery query) {
        IPage<AwardDO> pate = awardMapper.list(new Page<>(query.getPageIndex(), query.getPageSize()), query);
        return pate.convert(AwardConvertor::toEntity);
    }

    @Override
    public int updateAwardInventory(Long id, Integer number, int value) {
        return awardMapper.updateAwardInventory(id, number, value);
    }
}
```

å¯¹è±¡è½¬æ¢ç±»

æ¨¡å—ï¼šlucky-domain

åŒ…ï¼šcn.j3code.lucky.infrastructure.convertor

```java
public class AwardConvertor {
    public static AwardDO toUpdateDO(AwardEntity entity) {
        AwardDO awardDO = new AwardDO();
        awardDO.setId(entity.getId());
        awardDO.setAwardName(entity.getAwardName());
        awardDO.setActivityId(entity.getActivityId());
        awardDO.setPrizeId(entity.getPrizeId());
        awardDO.setNumber(entity.getNumber().getNumber());
        awardDO.setProbability(entity.getProbability());
        awardDO.setUpdateTime(LocalDateTime.now());
        awardDO.setUpdater(SecurityUtil.getName());

        return awardDO;
    }

    public static AwardEntity toEntity(AwardDO awardDO) {
        AwardEntity awardEntity = new AwardEntity();
        awardEntity.setId(awardDO.getId());
        awardEntity.setAwardName(awardDO.getAwardName());
        awardEntity.setActivityId(awardDO.getActivityId());
        awardEntity.setPrizeId(awardDO.getPrizeId());
        awardEntity.setPrizeName(awardDO.getPrizeName());
        awardEntity.setNumber(new AwardMaxNumber(awardDO.getNumber()));
        awardEntity.setProbability(awardDO.getProbability());
        awardEntity.setUpdateTime(awardDO.getUpdateTime());
        awardEntity.setUpdater(awardDO.getUpdater());

        return awardEntity;
    }

    public static AwardDO toAddDO(AwardEntity entity) {
        AwardDO awardDO = new AwardDO();
        awardDO.setId(entity.getId());
        awardDO.setId(entity.getId());
        awardDO.setAwardName(entity.getAwardName());
        awardDO.setActivityId(entity.getActivityId());
        awardDO.setPrizeId(entity.getPrizeId());
        awardDO.setNumber(entity.getNumber().getNumber());
        awardDO.setProbability(entity.getProbability());
        awardDO.setCreatTime(LocalDateTime.now());
        awardDO.setUpdater(SecurityUtil.getName());
        awardDO.setUpdateTime(LocalDateTime.now());
        awardDO.setUpdater(SecurityUtil.getName());

        return awardDO;
    }
}
```

8ã€ç¼–å†™ awardMapper æ¥å£åŠ mapper æ–‡ä»¶

æ¨¡å—ï¼šlucky-infrastructure

åŒ…ï¼šcn.j3code.lucky.infrastructure.gateway.impl.database.mapper

```java
public interface AwardMapper extends BaseMapper<AwardDO> {


    IPage<AwardDO> list(@Param("page") Page<AwardDO> page, @Param("query") AwardListByParamQuery query);

    int updateAwardInventory(@Param("id") Long id, @Param("number") Integer number, @Param("value") int value);
}
```

```xml
<update id="updateAwardInventory">
    update bld_lucky_award
    set number = number + #{value}
    where id = #{id}
      and number = #{number}
      and number > 0
</update>

<select id="list" resultType="cn.j3code.lucky.infrastructure.gateway.impl.database.dataobject.AwardDO">
    SELECT
    a.*,
    a.number as number,
    b.prize_name FROM bld_lucky_award a
    LEFT JOIN bld_lucky_prize b ON a.prize_id = b.id
    <where>
        <if test="query.awardName != null and query.awardName != ''">
            and a.award_name like concat('%',#{query.awardName},'%')
        </if>
        <if test="query.activityId != null ">
            and a.activity_id = #{query.activityId}
        </if>
        <if test="query.prizeId != null ">
            and a.prize_id = #{query.prizeId}
        </if>
        <if test="query.id != null ">
            and a.id = #{query.id}
        </if>

    </where>
    order by a.update_time desc
</select>
```

## 10.6 æ´»åŠ¨è§„åˆ™ç›¸å…³åŠŸèƒ½å¼€å‘

æ´»åŠ¨è§„åˆ™æ˜¯ä¸ºäº†æ§åˆ¶ç”¨æˆ·å‚ä¸æŠ½å¥–çš„æ¬¡æ•°ï¼Œå¦‚æœè¿™ä¸ªä¸åŠ ä»¥é™åˆ¶ï¼Œé‚£å°±ç›¸å½“äºç™½é€å¥–å“äº†ã€‚

å…ˆæ¥åˆ†ææœ‰å“ªäº›åŠŸèƒ½ï¼š

1. æ·»åŠ è§„åˆ™
2. ä¿®æ”¹è§„åˆ™
3. æŸ¥è¯¢è§„åˆ™

å…ˆæ¥ç¼–å†™ç›¸å…³å®ä½“

1ã€è§„åˆ™å®ä½“

æ¨¡å—ï¼šlucky-infrastructure

åŒ…ï¼šcn.j3code.lucky.infrastructure.gateway.impl.database.dataobject

```java
@TableName(value ="bld_lucky_activity_rules")
@Data
public class ActivityRulesDO implements Serializable {
    /**
     * 
     */
    @TableId(type = IdType.AUTO)
    private Long id;

    /**
     * æ´»åŠ¨id
     */
    private Long activityId;

    /**
     * æ´»åŠ¨å¯å‚ä¸æ¬¡æ•°
     */
    private Integer activityJoinNumber;

    /**
     * æ´»åŠ¨æœ€å¤§ä¸­å¥–æ¬¡æ•°
     */
    private Integer maxWinningNumber;

    /**
     * 
     */
    private LocalDateTime creatTime;

    /**
     * 
     */
    private String creator;

    /**
     * 
     */
    private LocalDateTime updateTime;

    /**
     * 
     */
    private String updater;

    @TableField(exist = false)
    private static final long serialVersionUID = 1L;
}
```

2ã€è§„åˆ™é¢†åŸŸå¯¹è±¡

æ¨¡å—ï¼šlucky-domain

åŒ…ï¼šcn.j3code.lucky.domain.activityrule

```java
@Data
public class ActivityRulesEntity {

    private Long id;

    /**
     * æ´»åŠ¨id
     */
    private Long activityId;

    /**
     * æ´»åŠ¨å¯å‚ä¸æ¬¡æ•°
     */
    private MaxNumber activityJoinNumber;

    /**
     * æ´»åŠ¨æœ€å¤§ä¸­å¥–æ¬¡æ•°
     */
    private MaxNumber maxWinningNumber;

    /**
     *
     */
    private LocalDateTime updateTime;

    /**
     *
     */
    private String updater;


}
```

3ã€å€¼å¯¹è±¡

æ¨¡å—ï¼šlucky-domain

åŒ…ï¼šcn.j3code.lucky.domain.activityrule

```java
@Getter
public class MaxNumber {

    private Integer number;

    public MaxNumber(Integer number) {
        if (number < 1){
            throw new ValidationException("æœ€å¤§æ¬¡æ•°å¿…é¡»å¤§äºç­‰äº 1 ï¼");
        }
        this.number = number;
    }
}
```

4ã€ç¼–å†™è§†å›¾å¯¹è±¡

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.dto.data

```java
@Data
public class ActivityRulesVO {

    private Long id;

    /**
     * æ´»åŠ¨id
     */
    private Long activityId;

    /**
     * æ´»åŠ¨å¯å‚ä¸æ¬¡æ•°
     */
    private Integer activityJoinNumber;

    /**
     * æ´»åŠ¨æœ€å¤§ä¸­å¥–æ¬¡æ•°
     */
    private Integer maxWinningNumber;

    /**
     *
     */
    private LocalDateTime updateTime;

    /**
     *
     */
    private String updater;

}
```

ä¸‹é¢å¼€å§‹å®ç°åŠŸèƒ½ã€‚

### 10.6.1 ç¼–å†™è§„åˆ™åŠŸèƒ½

1ã€ç¼–å†™ IActivityRulesService ä¸šåŠ¡æ¥å£

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.api

```java
public interface IActivityRulesService {


    ActivityRulesVO one(ActivityRulesListByParamQuery query);

    ActivityRulesVO add(ActivityRulesAddCmd cmd);

    ActivityRulesVO update(ActivityRulesModifyCmd cmd);
}
```

2ã€ç¼–å†™ cmd å’Œ query

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.dto.query

```java
@Data
@Accessors(chain = true)
public class ActivityRulesListByParamQuery  extends Query {

    private Long id;
    /**
     * æ´»åŠ¨id
     */
    private Long activityId;
}
```

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.dto

```java
@Data
@Accessors(chain = true)
public class ActivityRulesAddCmd   extends Command {

    /**
     * æ´»åŠ¨id
     */
    //@NotNull(message = "æ´»åŠ¨idä¸èƒ½ä¸ºç©º")
    private Long activityId;

    /**
     * æ´»åŠ¨å¯å‚ä¸æ¬¡æ•°
     */
    @NotNull(message = "æ´»åŠ¨å¯å‚ä¸æ¬¡æ•°ä¸èƒ½ä¸ºç©º")
    private Integer activityJoinNumber;

    /**
     * æ´»åŠ¨æœ€å¤§ä¸­å¥–æ¬¡æ•°
     */
    @NotNull(message = "æ´»åŠ¨æœ€å¤§ä¸­å¥–æ¬¡æ•°ä¸èƒ½ä¸ºç©º")
    private Integer maxWinningNumber;

}
```

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.dto

```java
@Data
public class ActivityRulesModifyCmd extends Command {
    @NotNull(message = "idä¸èƒ½ä¸ºç©º")
    private Long id;

    /**
     * æ´»åŠ¨id
     */
    @NotNull(message = "æ´»åŠ¨idä¸èƒ½ä¸ºç©º")
    private Long activityId;

    /**
     * æ´»åŠ¨å¯å‚ä¸æ¬¡æ•°
     */
    @NotNull(message = "æ´»åŠ¨å¯å‚ä¸æ¬¡æ•°ä¸èƒ½ä¸ºç©º")
    private Integer activityJoinNumber;

    /**
     * æ´»åŠ¨æœ€å¤§ä¸­å¥–æ¬¡æ•°
     */
    @NotNull(message = "æ´»åŠ¨æœ€å¤§ä¸­å¥–æ¬¡æ•°ä¸èƒ½ä¸ºç©º")
    private Integer maxWinningNumber;
}
```

3ã€ç¼–å†™ IActivityRulesService ä¸šåŠ¡æ¥å£å®ç°ç±»

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.service

```java
@Slf4j
@Service
@AllArgsConstructor
public class ActivityRulesServiceImpl implements IActivityRulesService {

    private final ActivityRulesListByParamQueryExe activityRulesListByParamQueryExe;
    private final ActivityRulesAddCmdExe activityRulesAddCmdExe;
    private final ActivityRulesModifyCmdExe activityRulesModifyCmdExe;

    @Override
    public ActivityRulesVO one(ActivityRulesListByParamQuery query) {
        return activityRulesListByParamQueryExe.execute(query).get(0);
    }

    @Override
    public ActivityRulesVO add(ActivityRulesAddCmd cmd) {
        return activityRulesAddCmdExe.execute(cmd);
    }

    @Override
    public ActivityRulesVO update(ActivityRulesModifyCmd cmd) {
        return activityRulesModifyCmdExe.execute(cmd);
    }
}
```

å¯¹è±¡è½¬åŒ–

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.activityrule.assembler

```java
public class ActivityRulesAssembler {
    public static ActivityRulesVO toValueObject(ActivityRulesEntity entity) {
        ActivityRulesVO activityRulesVO = new ActivityRulesVO();
        activityRulesVO.setId(entity.getId());
        activityRulesVO.setActivityId(entity.getActivityId());
        activityRulesVO.setActivityJoinNumber(entity.getActivityJoinNumber().getNumber());
        activityRulesVO.setMaxWinningNumber(entity.getMaxWinningNumber().getNumber());
        activityRulesVO.setUpdateTime(entity.getUpdateTime());
        activityRulesVO.setUpdater(SecurityUtil.getName());

        return activityRulesVO;
    }

    public static ActivityRulesEntity toEntity(ActivityRulesModifyCmd cmd) {
        ActivityRulesEntity activityRulesEntity = new ActivityRulesEntity();
        activityRulesEntity.setId(cmd.getId());
        activityRulesEntity.setActivityId(cmd.getActivityId());
        activityRulesEntity.setActivityJoinNumber(new MaxNumber(cmd.getActivityJoinNumber()));
        activityRulesEntity.setMaxWinningNumber(new MaxNumber(cmd.getMaxWinningNumber()));
        activityRulesEntity.setUpdateTime(LocalDateTime.now());
        activityRulesEntity.setUpdater(SecurityUtil.getName());

        return activityRulesEntity;
    }

    public static ActivityRulesEntity toEntity(ActivityRulesAddCmd cmd) {
        ActivityRulesEntity activityRulesEntity = new ActivityRulesEntity();
        activityRulesEntity.setActivityId(cmd.getActivityId());
        activityRulesEntity.setActivityJoinNumber(new MaxNumber(cmd.getActivityJoinNumber()));
        activityRulesEntity.setMaxWinningNumber(new MaxNumber(cmd.getMaxWinningNumber()));
        activityRulesEntity.setUpdateTime(LocalDateTime.now());
        activityRulesEntity.setUpdater(SecurityUtil.getName());

        return activityRulesEntity;
    }
}
```

4ã€ç¼–å†™å¯¹åº”çš„æ‰§è¡Œå™¨

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.activityrule.command.query

```java
@Component
@Slf4j
@AllArgsConstructor
public class ActivityRulesListByParamQueryExe {

    private final ActivityRulesGateway activityRulesGateway;


    public List<ActivityRulesVO> execute(ActivityRulesListByParamQuery query) {
        if (Objects.nonNull(query.getId())) {
            return List.of(
                    ActivityRulesAssembler
                            .toValueObject(activityRulesGateway.getById(query.getId())));
        }
        return List.of(
                ActivityRulesAssembler
                        .toValueObject(activityRulesGateway.getByActivityId(query.getActivityId())));
    }

}
```

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.activityrule.command

```java
@Component
@Slf4j
@AllArgsConstructor
public class ActivityRulesAddCmdExe {
    private final ActivityRulesGateway activityRulesGateway;

    public ActivityRulesVO execute(ActivityRulesAddCmd cmd){
        ActivityRulesEntity entity = activityRulesGateway.save(ActivityRulesAssembler.toEntity(cmd));
        return ActivityRulesAssembler.toValueObject(entity);
    }
}
```

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.activityrule.command

```java
@Component
@Slf4j
@AllArgsConstructor
public class ActivityRulesModifyCmdExe {
    private final ActivityRulesGateway activityRulesGateway;

    public ActivityRulesVO execute(ActivityRulesModifyCmd cmd){
        ActivityRulesEntity entity = activityRulesGateway.save(ActivityRulesAssembler.toEntity(cmd));
        return ActivityRulesAssembler.toValueObject(entity);
    }
}
```

5ã€ç¼–å†™ ActivityRulesGateway æ¥å£

æ¨¡å—ï¼šlucky-domain

åŒ…ï¼šcn.j3code.lucky.domain.gateway

```java
public interface ActivityRulesGateway {

    ActivityRulesEntity save(ActivityRulesEntity entity);

    ActivityRulesEntity getById(Long id);

    ActivityRulesEntity getByActivityId(Long activityId);

}
```

6ã€ç¼–å†™ ActivityRulesGateway æ¥å£å®ç°ç±»

æ¨¡å—ï¼šlucky-domain

åŒ…ï¼šcn.j3code.lucky.infrastructure.gateway.impl

```java
@Slf4j
@AllArgsConstructor
@Component
public class ActivityRulesGatewayImpl implements ActivityRulesGateway {

    private final ActivityRulesMapper activityRulesMapper;

    @Override
    public ActivityRulesEntity save(ActivityRulesEntity entity) {
        // æ–°å¢
        if (Objects.isNull(entity.getId())) {
            return add(entity);
        }

        // ä¿®æ”¹
        return modify(entity);
    }

    private ActivityRulesEntity modify(ActivityRulesEntity entity) {
        ActivityRulesDO activityRulesDO = ActivityRulesConvertor.toUpdateDO(entity);
        int update = activityRulesMapper.updateById(activityRulesDO);
        if (update < 1) {
            throw new PersistenceException("æ›´æ–°æ•°æ®å¼‚å¸¸");
        }
        return ActivityRulesConvertor.toEntity(activityRulesDO);
    }

    private ActivityRulesEntity add(ActivityRulesEntity entity) {
        ActivityRulesDO activityRulesDO = ActivityRulesConvertor.toAddDO(entity);
        int insert = activityRulesMapper.insert(activityRulesDO);
        if (insert < 1) {
            throw new PersistenceException("æ’å…¥æ•°æ®å¼‚å¸¸");
        }
        return ActivityRulesConvertor.toEntity(activityRulesDO);
    }

    @Override
    public ActivityRulesEntity getById(Long id) {
        ActivityRulesDO activityRulesDO = activityRulesMapper.selectById(id);
        if (Objects.isNull(activityRulesDO)) {
            throw new BldBizException(ErrorCode.DATA_UNDEFINED);
        }
        return ActivityRulesConvertor.toEntity(activityRulesDO);
    }

    @Override
    public ActivityRulesEntity getByActivityId(Long activityId) {
        ActivityRulesDO activityRulesDO = activityRulesMapper.selectByActivityId(activityId);
        if (Objects.isNull(activityRulesDO)) {
            throw new BldBizException(ErrorCode.DATA_UNDEFINED);
        }
        return ActivityRulesConvertor.toEntity(activityRulesDO);
    }
}
```

å¯¹è±¡è½¬æ¢ç±»

æ¨¡å—ï¼šlucky-domain

åŒ…ï¼šcn.j3code.lucky.infrastructure.convertor

```java
public class ActivityRulesConvertor {
    public static ActivityRulesDO toUpdateDO(ActivityRulesEntity entity) {
        ActivityRulesDO activityRulesDO = new ActivityRulesDO();
        activityRulesDO.setId(entity.getId());
        activityRulesDO.setActivityId(entity.getActivityId());
        activityRulesDO.setActivityJoinNumber(entity.getActivityJoinNumber().getNumber());
        activityRulesDO.setMaxWinningNumber(entity.getMaxWinningNumber().getNumber());
        activityRulesDO.setUpdateTime(LocalDateTime.now());
        activityRulesDO.setUpdater(SecurityUtil.getName());

        return activityRulesDO;
    }

    public static ActivityRulesEntity toEntity(ActivityRulesDO activityRulesDO) {
        ActivityRulesEntity activityRulesEntity = new ActivityRulesEntity();
        activityRulesEntity.setId(activityRulesDO.getId());
        activityRulesEntity.setActivityId(activityRulesDO.getActivityId());
        activityRulesEntity.setActivityJoinNumber(new MaxNumber(activityRulesDO.getActivityJoinNumber()));
        activityRulesEntity.setMaxWinningNumber(new MaxNumber(activityRulesDO.getMaxWinningNumber()));
        activityRulesEntity.setUpdateTime(LocalDateTime.now());
        activityRulesEntity.setUpdater(SecurityUtil.getName());

        return activityRulesEntity;
    }

    public static ActivityRulesDO toAddDO(ActivityRulesEntity entity) {
        ActivityRulesDO activityRulesDO = new ActivityRulesDO();
        activityRulesDO.setActivityId(entity.getActivityId());
        activityRulesDO.setActivityJoinNumber(entity.getActivityJoinNumber().getNumber());
        activityRulesDO.setMaxWinningNumber(entity.getMaxWinningNumber().getNumber());
        activityRulesDO.setCreatTime(LocalDateTime.now());
        activityRulesDO.setCreator(SecurityUtil.getName());
        activityRulesDO.setUpdateTime(LocalDateTime.now());
        activityRulesDO.setUpdater(SecurityUtil.getName());

        return activityRulesDO;
    }
}
```

7ã€ç¼–å†™ ActivityRulesMapper æ¥å£åŠ mapper æ–‡ä»¶

æ¨¡å—ï¼šlucky-infrastructure

åŒ…ï¼šcn.j3code.lucky.infrastructure.gateway.impl.database.mapper

```java
public interface ActivityRulesMapper extends BaseMapper<ActivityRulesDO> {

    ActivityRulesDO selectByActivityId(@Param("activityId") Long activityId);
}
```

```xml
<select id="selectByActivityId"
        resultType="cn.j3code.lucky.infrastructure.gateway.impl.database.dataobject.ActivityRulesDO">
    select *
    from bld_lucky_activity_rules
    where activity_id = #{activityId}
</select>
```

## 10.7 æ´»åŠ¨ç›¸å…³åŠŸèƒ½å¼€å‘

æ´»åŠ¨æ˜¯è¿™ä¸ªé¡¹ç›®ä¸­è¾ƒä¸ºå¤æ‚çš„ä¸€å—äº†ï¼Œå®ƒçš„åŠŸèƒ½ä¸å¤šä½†å´æ¯”è¾ƒç¹çï¼Œå…·ä½“åŠŸèƒ½å¦‚ä¸‹ï¼š

1. æ´»åŠ¨åˆ›å»º
2. æ´»åŠ¨ä¿®æ”¹
3. æ´»åŠ¨è¯¦æƒ…
4. æŠ½å¥–

ä¸‹é¢å¼€å§‹ç¼–å†™å®ä½“

1ã€ç¼–å†™æ´»åŠ¨å®ä½“

æ¨¡å—ï¼šlucky-infrastructure

åŒ…ï¼šcn.j3code.lucky.infrastructure.gateway.impl.database.dataobject

```java
@TableName(value ="bld_lucky_activity")
@Data
public class ActivityDO implements Serializable {
    /**
     * 
     */
    @TableId(type = IdType.AUTO)
    private Long id;

    /**
     * æ´»åŠ¨åç§°
     */
    private String activityName;

    /**
     * ç®€ä»‹
     */
    private String introduce;

    /**
     * æ´»åŠ¨å¼€å§‹æ—¶é—´
     */
    private LocalDateTime startTime;

    /**
     * æ´»åŠ¨ç»“æŸæ—¶é—´
     */
    private LocalDateTime endTime;

    /**
     * 
     */
    private LocalDateTime creatTime;

    /**
     * 
     */
    private String creator;

    /**
     * 
     */
    private LocalDateTime updateTime;

    /**
     * 
     */
    private String updater;

    @TableField(exist = false)
    private static final long serialVersionUID = 1L;
}
```

2ã€ç¼–å†™æ´»åŠ¨é¢†åŸŸ

æ¨¡å—ï¼šlucky-domain

åŒ…ï¼šcn.j3code.lucky.domain.activity

```java
@Data
public class ActivityEntity {
    private Long id;

    /**
     * æ´»åŠ¨åç§°
     */
    private String activityName;

    /**
     * ç®€ä»‹
     */
    private String introduce;

    /**
     * æ´»åŠ¨æ—¶é—´
     */
    private ActivityTime activityTime;

    /**
     *
     */
    private LocalDateTime updateTime;

    /**
     *
     */
    private String updater;

    public ActivityStatusEnum getStatus() {
        LocalDateTime now = LocalDateTime.now();

        if (activityTime.getStartTime().isAfter(now)) {
            return ActivityStatusEnum.NOT_START;
        }
        if (activityTime.getStartTime().isBefore(now) && activityTime.getEndTime().isAfter(now)) {
            return ActivityStatusEnum.START;
        }
        return ActivityStatusEnum.END;
    }
}
```

3ã€ç¼–å†™å€¼å¯¹è±¡

æ¨¡å—ï¼šlucky-domain

åŒ…ï¼šcn.j3code.lucky.domain.activity

```java
@Getter
public enum ActivityStatusEnum {

    NOT_START(1,"æœªå¼€å§‹"),


    START(2,"è¿›è¡Œä¸­"),

    END(3,"å·²è¿‡æœŸ"),

    ;
    private Integer value;
    private String description;

    ActivityStatusEnum(Integer value, String description) {
        this.value = value;
        this.description = description;
    }
}
```

æ¨¡å—ï¼šlucky-domain

åŒ…ï¼šcn.j3code.lucky.domain.activity

```java
@Getter
public class ActivityTime {

    /**
     * æ´»åŠ¨å¼€å§‹æ—¶é—´
     */
    private LocalDateTime startTime;

    /**
     * æ´»åŠ¨ç»“æŸæ—¶é—´
     */
    private LocalDateTime endTime;

    public ActivityTime(LocalDateTime startTime, LocalDateTime endTime) {

        if (Objects.isNull(startTime) || Objects.isNull(endTime)) {
            throw new ValidationException("æ´»åŠ¨æ—¶é—´ä¸ä¸ºç©ºï¼");
        }

        if (startTime.isAfter(endTime)) {
            throw new ValidationException("æ—¶é—´èŒƒå›´é”™è¯¯ï¼");
        }

        this.startTime = startTime;
        this.endTime = endTime;
    }
}
```

4ã€ç¼–å†™è§†å›¾å¯¹è±¡

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.dto.data

```java
@Data
public class ActivityVO {
    private Long id;

    /**
     * æ´»åŠ¨åç§°
     */
    private String activityName;

    /**
     * ç®€ä»‹
     */
    private String introduce;

    private Integer state;

    /**
     * æ´»åŠ¨æ—¶é—´
     */
    private LocalDateTime startTime;

    /**
     * æ´»åŠ¨æ—¶é—´
     */
    private LocalDateTime endTime;

    /**
     *
     */
    private LocalDateTime updateTime;

    /**
     *
     */
    private String updater;
}
```

### 10.7.1 ç¼–å†™æ´»åŠ¨åŠŸèƒ½

1ã€ç¼–å†™ IActivityService ä¸šåŠ¡æ¥å£

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.api

```java
public interface IActivityService {
    IPage<ActivityVO> list(ActivityListByParamQuery query);
}
```

2ã€ç¼–å†™ cmd åŠ query

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.dto.query

```java
@Data
@Accessors(chain = true)
public class ActivityListByParamQuery extends PageQuery {

    private Long id;

    /**
     * æ´»åŠ¨åç§°
     */
    private String activityName;

    /**
     * æ´»åŠ¨æ—¶é—´
     */
    private LocalDateTime startTime;

    /**
     * æ´»åŠ¨æ—¶é—´
     */
    private LocalDateTime endTime;
}
```

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.dto

```java
@Data
public class ActivityAddCmd   extends Command {


    /**
     * æ´»åŠ¨åç§°
     */
    @NotNull(message = "æ´»åŠ¨åç§°ä¸èƒ½ä¸ºç©º")
    private String activityName;

    /**
     * ç®€ä»‹
     */
    @NotNull(message = "ç®€ä»‹ä¸èƒ½ä¸ºç©º")
    private String introduce;

    /**
     * æ´»åŠ¨æ—¶é—´
     */
    @NotNull(message = "æ´»åŠ¨æ—¶é—´ä¸èƒ½ä¸ºç©º")
    @JsonFormat(pattern="yyyy-MM-dd HH:mm:ss")
    private LocalDateTime startTime;

    /**
     * æ´»åŠ¨æ—¶é—´
     */
    @NotNull(message = "æ´»åŠ¨æ—¶é—´ä¸èƒ½ä¸ºç©º")
    @JsonFormat(pattern="yyyy-MM-dd HH:mm:ss")
    private LocalDateTime endTime;
}
```

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.dto

```java
@Data
public class ActivityModifyCmd   extends Command {
    @NotNull(message = "æ´»åŠ¨idä¸èƒ½ä¸ºç©º")
    private Long id;

    /**
     * æ´»åŠ¨åç§°
     */
    @NotNull(message = "æ´»åŠ¨åç§°ä¸èƒ½ä¸ºç©º")
    private String activityName;

    /**
     * ç®€ä»‹
     */
    @NotNull(message = "ç®€ä»‹ä¸èƒ½ä¸ºç©º")
    private String introduce;

    /**
     * æ´»åŠ¨æ—¶é—´
     */
    @NotNull(message = "æ´»åŠ¨æ—¶é—´ä¸èƒ½ä¸ºç©º")
    @JsonFormat(pattern="yyyy-MM-dd HH:mm:ss")
    private LocalDateTime startTime;

    /**
     * æ´»åŠ¨æ—¶é—´
     */
    @NotNull(message = "æ´»åŠ¨æ—¶é—´ä¸èƒ½ä¸ºç©º")
    @JsonFormat(pattern="yyyy-MM-dd HH:mm:ss")
    private LocalDateTime endTime;
}
```

3ã€ç¼–å†™ IActivityService ä¸šåŠ¡æ¥å£å®ç°ç±»

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.service

```java
@Slf4j
@Service
@AllArgsConstructor
public class ActivityServiceImpl implements IActivityService {

    private final ActivityListByParamQueryExe activityListByParamQueryExe;

    @Override
    public IPage<ActivityVO> list(ActivityListByParamQuery query) {
        return activityListByParamQueryExe.execute(query);
    }
}
```

4ã€ç¼–å†™ç›¸å…³æ‰§è¡Œå™¨

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.activity.command.query

```java
@Component
@Slf4j
@AllArgsConstructor
public class ActivityListByParamQueryExe {

    private final ActivityGateway activityGateway;

    public IPage<ActivityVO> execute(ActivityListByParamQuery query) {
        if (Objects.nonNull(query.getId())) {
            return new Page<ActivityVO>()
                .setTotal(1)
                .setRecords(List.of(ActivityAssembler.toValueObject(activityGateway.getById(query.getId()))));
        }
        IPage<ActivityEntity> page = activityGateway.list(query);
        return page.convert(ActivityAssembler::toValueObject);
    }

}
```

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.activity.command

```java
@Component
@Slf4j
@AllArgsConstructor
public class ActivityAddCmdExe {
    private final ActivityGateway activityGateway;

    public ActivityVO execute(ActivityAddCmd cmd){
        ActivityEntity entity = activityGateway.save(ActivityAssembler.toEntity(cmd));
        return ActivityAssembler.toValueObject(entity);
    }
}
```

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.activity.command

```java
@Component
@Slf4j
@AllArgsConstructor
public class ActivityModifyCmdExe {
    private final ActivityGateway activityGateway;

    public ActivityVO execute(ActivityModifyCmd cmd){
        ActivityEntity entity = activityGateway.save(ActivityAssembler.toEntity(cmd));
        return ActivityAssembler.toValueObject(entity);
    }
}
```

å¯¹è±¡è½¬æ¢

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.activity.assembler

```java
public interface ActivityAssembler {
    static ActivityVO toValueObject(ActivityEntity entity) {
        ActivityVO activityVO = new ActivityVO();
        activityVO.setId(entity.getId());
        activityVO.setActivityName(entity.getActivityName());
        activityVO.setIntroduce(entity.getIntroduce());
        activityVO.setStartTime(entity.getActivityTime().getStartTime());
        activityVO.setState(entity.getStatus().getValue());
        activityVO.setEndTime(entity.getActivityTime().getEndTime());
        activityVO.setUpdateTime(entity.getUpdateTime());
        activityVO.setUpdater(entity.getUpdater());

        return activityVO;
    }

    static ActivityEntity toEntity(ActivityModifyCmd cmd) {
        ActivityEntity activityEntity = new ActivityEntity();
        activityEntity.setId(cmd.getId());
        activityEntity.setActivityName(cmd.getActivityName());
        activityEntity.setIntroduce(cmd.getIntroduce());
        activityEntity.setActivityTime(new ActivityTime(cmd.getStartTime(),cmd.getEndTime()));
        activityEntity.setUpdateTime(LocalDateTime.now());
        activityEntity.setUpdater(SecurityUtil.getName());

        return activityEntity;
    }

    static ActivityEntity toEntity(ActivityAddCmd cmd) {
        ActivityEntity activityEntity = new ActivityEntity();
        activityEntity.setActivityName(cmd.getActivityName());
        activityEntity.setIntroduce(cmd.getIntroduce());
        activityEntity.setActivityTime(new ActivityTime(cmd.getStartTime(),cmd.getEndTime()));
        activityEntity.setUpdateTime(LocalDateTime.now());
        activityEntity.setUpdater(SecurityUtil.getName());

        return activityEntity;
    }

    static DrawResults toDrawResult(AwardEntity awardEntity) {
        DrawResults drawResults = new DrawResults();
        drawResults.setId(awardEntity.getId());
        drawResults.setPrizeName(awardEntity.getPrizeName());
        drawResults.setNumber(1L);
        drawResults.setAwardName(awardEntity.getAwardName());

        return drawResults;
    }
}
```

5ã€ç¼–å†™ ActivityGateway æ¥å£

æ¨¡å—ï¼šlucky-domain

åŒ…ï¼šcn.j3code.lucky.domain.gateway

```java
public interface ActivityGateway {
    ActivityEntity save(ActivityEntity entity);
    
    IPage<ActivityEntity> list(ActivityListByParamQuery query);
}
```

5ã€ç¼–å†™ ActivityGateway æ¥å£å®ç°ç±»

æ¨¡å—ï¼šlucky-infrastructure

åŒ…ï¼šcn.j3code.lucky.infrastructure.gateway.impl

```java
@Slf4j
@AllArgsConstructor
@Component
public class ActivityGatewayImpl implements ActivityGateway {
    private final ActivityMapper activityMapper;
    
    @Override
    public ActivityEntity save(ActivityEntity entity) {
        // æ–°å¢
        if (Objects.isNull(entity.getId())) {
            return add(entity);
        }

        // ä¿®æ”¹
        return modify(entity);
    }

    private ActivityEntity modify(ActivityEntity entity) {
        ActivityDO activityDO = ActivityConvertor.toUpdateDO(entity);
        int update = activityMapper.updateById(activityDO);
        if (update < 1) {
            throw new PersistenceException("æ›´æ–°æ•°æ®å¼‚å¸¸");
        }
        return ActivityConvertor.toEntity(activityDO);
    }

    private ActivityEntity add(ActivityEntity entity) {
        ActivityDO activityDO = ActivityConvertor.toAddDO(entity);
        int insert = activityMapper.insert(activityDO);
        if (insert < 1) {
            throw new PersistenceException("æ’å…¥æ•°æ®å¼‚å¸¸");
        }
        return ActivityConvertor.toEntity(activityDO);
    }
    
    @Override
    public IPage<ActivityEntity> list(ActivityListByParamQuery query) {
        IPage<ActivityDO> page = activityMapper.list(new Page<>(query.getPageIndex(), query.getPageSize()), query);
        return page.convert(ActivityConvertor::toEntity);
    }
}
```

å¯¹è±¡è½¬æ¢

æ¨¡å—ï¼šlucky-infrastructure

åŒ…ï¼šcn.j3code.lucky.infrastructure.convertor

```java
public class ActivityConvertor {
    public static ActivityDO toUpdateDO(ActivityEntity entity) {
        ActivityDO activityDO = new ActivityDO();
        activityDO.setId(entity.getId());
        activityDO.setActivityName(entity.getActivityName());
        activityDO.setIntroduce(entity.getIntroduce());
        activityDO.setStartTime(entity.getActivityTime().getStartTime());
        activityDO.setEndTime(entity.getActivityTime().getEndTime());
        activityDO.setUpdateTime(LocalDateTime.now());
        activityDO.setUpdater(SecurityUtil.getName());

        return activityDO;
    }

    public static ActivityEntity toEntity(ActivityDO activityDO) {
        ActivityEntity activityEntity = new ActivityEntity();
        activityEntity.setId(activityDO.getId());
        activityEntity.setActivityName(activityDO.getActivityName());
        activityEntity.setIntroduce(activityDO.getIntroduce());
        activityEntity.setActivityTime(new ActivityTime(activityDO.getStartTime(), activityDO.getEndTime()));
        activityEntity.setUpdateTime(activityDO.getUpdateTime());
        activityEntity.setUpdater(activityDO.getUpdater());

        return activityEntity;
    }

    public static ActivityDO toAddDO(ActivityEntity entity) {
        ActivityDO activityDO = new ActivityDO();
        activityDO.setActivityName(entity.getActivityName());
        activityDO.setIntroduce(entity.getIntroduce());
        activityDO.setStartTime(entity.getActivityTime().getStartTime());
        activityDO.setEndTime(entity.getActivityTime().getEndTime());
        activityDO.setCreatTime(LocalDateTime.now());
        activityDO.setCreator(SecurityUtil.getName());
        activityDO.setUpdateTime(LocalDateTime.now());
        activityDO.setUpdater(SecurityUtil.getName());

        return activityDO;
    }
}
```

6ã€ç¼–å†™ ActivityMapper æ¥å£åŠ mapper æ–‡ä»¶

æ¨¡å—ï¼šlucky-infrastructure

åŒ…ï¼šcn.j3code.lucky.infrastructure.gateway.impl.database.mapper

```java
public interface ActivityMapper extends BaseMapper<ActivityDO> {

    IPage<ActivityDO> list(@Param("page") Page<ActivityDO> page, @Param("query") ActivityListByParamQuery query);
}
```

```xml
<select id="list" resultType="cn.j3code.lucky.infrastructure.gateway.impl.database.dataobject.ActivityDO">
    select * from bld_lucky_activity a
    <where>
        <if test="query.activityName != null and query.activityName != ''">
            and a.activity_name like concat('%',#{query.activityName},'%')
        </if>
        <if test="query.startTime != null">
            and a.start_time &gt;= #{query.startTime}
        </if>
        <if test="query.endTime != null">
            and a.end_time &lt;= #{query.endTime}
        </if>
    </where>
    order by a.update_time desc
</select>
```

## 10.8 æ´»åŠ¨é…ç½®åŠŸèƒ½

æ´»åŠ¨é…ç½®åŒ…æ‹¬ï¼šæ´»åŠ¨ä¿¡æ¯ã€æ´»åŠ¨è§„åˆ™ä¿¡æ¯ã€æ´»åŠ¨å¥–å“ä¿¡æ¯ï¼Œä¸»è¦åŠŸèƒ½å°±ä¸¤ä¸ªï¼š

1. æ·»åŠ 
2. ä¿®æ”¹

ä¸‹é¢æ¥ç¼–å†™æ´»åŠ¨é…ç½®ç›¸å…³å®ä½“

1ã€æ´»åŠ¨é…ç½®è§†å›¾å®ä½“

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.dto.data

```java
@Data
public class ActivityConfigVO {

    private ActivityVO activityVO;

    private ActivityRulesVO activityRulesVO;

    private List<AwardVO> awardVOList;
}
```

2ã€æ´»åŠ¨é…ç½® cmd å®ä½“

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.dto

```java
@Data
public class ActivityConfigAddCmd extends Command {
    private ActivityAddCmd activityAddCmd;
    private ActivityRulesAddCmd activityRulesAddCmd;
    private List<AwardAddCmd> awardAddCmdList;
}
```

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.dto

```java
@Data
public class ActivityConfigModifyCmd extends Command {
    private ActivityModifyCmd activityModifyCmd;
    private ActivityRulesModifyCmd activityRulesModifyCmd;
    private List<AwardModifyCmd> awardModifyCmdList;
}
```

3ã€ç¼–å†™ ActivityController 

æ¨¡å—ï¼šlucky-adapter

åŒ…ï¼šcn.j3code.lucky.adapter.web

```java
@Slf4j
@AllArgsConstructor
@ResponseResult
@RequestMapping("/v1/activity")
public class ActivityController {

    private final IActivityService activityService;
    private final IActivityConfigService activityConfigService;

    @PostMapping("/add")
    public ActivityConfigVO add(@Validated @RequestBody ActivityConfigAddCmd cmd) {
        return activityConfigService.add(cmd);
    }

    @PostMapping("/update")
    public ActivityConfigVO update(@Validated @RequestBody ActivityConfigModifyCmd cmd) {
        return activityConfigService.update(cmd);
    }

    @GetMapping("/one")
    public ActivityConfigVO one(@RequestParam("activityId") Long activityId) {
        return activityConfigService.one(activityId);
    }

    @PostMapping("/list")
    public IPage<ActivityVO> list(@Validated @RequestBody ActivityListByParamQuery query) {
        return activityService.list(query);
    }

}
```

4ã€ç¼–å†™ IActivityConfigService ä¸šåŠ¡æ¥å£

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.api

```java
public interface IActivityConfigService {

    ActivityConfigVO one(Long activityId);

    ActivityConfigVO add(ActivityConfigAddCmd cmd);

    ActivityConfigVO update(ActivityConfigModifyCmd cmd);
}
```

4ã€ç¼–å†™ IActivityConfigService ä¸šåŠ¡æ¥å£å®ç°ç±»

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.service

```java
@Slf4j
@Service
@AllArgsConstructor
public class ActivityConfigServiceImpl implements IActivityConfigService {

    private final ActivityListByParamQueryExe activityListByParamQueryExe;
    private final ActivityRulesListByParamQueryExe activityRulesListByParamQueryExe;
    private final AwardListByParamQueryExe awardListByParamQueryExe;

    private final ActivityAddCmdExe activityAddCmdExe;
    private final ActivityRulesAddCmdExe activityRulesAddCmdExe;
    private final AwardAddCmdExe awardAddCmdExe;

    private final ActivityModifyCmdExe activityModifyCmdExe;
    private final ActivityRulesModifyCmdExe activityRulesModifyCmdExe;
    private final AwardModifyCmdExe awardModifyCmdExe;

    @Override
    public ActivityConfigVO one(Long activityId) {
        ActivityConfigVO activityConfigVO = new ActivityConfigVO();
        activityConfigVO.setActivityVO(activityListByParamQueryExe.execute(new ActivityListByParamQuery().setId(activityId)).getRecords().get(0));
        activityConfigVO.setActivityRulesVO(activityRulesListByParamQueryExe.execute(new ActivityRulesListByParamQuery().setActivityId(activityId)).get(0));
        activityConfigVO.setAwardVOList(awardListByParamQueryExe.execute(new AwardListByParamQuery().setActivityId(activityId)).getRecords());
        return activityConfigVO;
    }

    @Transactional
    @Override
    public ActivityConfigVO add(ActivityConfigAddCmd cmd) {
        ActivityConfigVO activityConfigVO = new ActivityConfigVO();

        activityConfigVO.setActivityVO(activityAddCmdExe.execute(cmd.getActivityAddCmd()));
        cmd.getActivityRulesAddCmd().setActivityId(activityConfigVO.getActivityVO().getId());

        activityConfigVO.setActivityRulesVO(activityRulesAddCmdExe.execute(cmd.getActivityRulesAddCmd()));
        cmd.getAwardAddCmdList().forEach(item -> item.setActivityId(activityConfigVO.getActivityVO().getId()));

        activityConfigVO.setAwardVOList(awardAddCmdExe.execute(cmd.getAwardAddCmdList()));
        return activityConfigVO;
    }

    @Transactional
    @Override
    public ActivityConfigVO update(ActivityConfigModifyCmd cmd) {
        ActivityConfigVO activityConfigVO = new ActivityConfigVO();
        activityConfigVO.setActivityVO(activityModifyCmdExe.execute(cmd.getActivityModifyCmd()));
        activityConfigVO.setActivityRulesVO(activityRulesModifyCmdExe.execute(cmd.getActivityRulesModifyCmd()));
        activityConfigVO.setAwardVOList(awardModifyCmdExe.execute(cmd.getAwardModifyCmdList()));
        return activityConfigVO;
    }
}
```

## 10.9 æŠ½å¥–è®°å½•ç›¸å…³åŠŸèƒ½å¼€å‘

æŠ½å¥–è®°å½•åŠŸèƒ½æœ‰ï¼š

1. æ·»åŠ 
2. æŸ¥è¯¢

1ã€ç¼–å†™ IDrawRecordService æ¥å£

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.api

```java
public interface IDrawRecordService {

    IPage<DrawRecordVO> list(DrawRecordListByParamQuery query);

    DrawRecordVO add(DrawRecordAddCmd cmd);
}
```

2ã€ç¼–å†™ cmd åŠ query

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.dto.query

```java
@Data
@Accessors(chain = true)
public class DrawRecordListByParamQuery extends PageQuery {

    private Long activityId;

    private Long activityName;

    /**
     * ç”¨æˆ·id
     */
    private Long userId;

    /**
     * æŠ½å¥–ç»“æœ
     */
    private Integer results;

    /**
     *
     */
    private LocalDate startTime;

    private LocalDate endTime;
}
```

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.dto

```java
@Data
public class DrawRecordAddCmd  extends Command {
    /**
     * æ´»åŠ¨id
     */
    private Long activityId;

    /**
     * æŠ½å¥–ç»“æœ(0:æœªä¸­å¥–ï¼Œ1:ä¸­å¥–)
     */
    private Integer results;

    private Long awardId;
}
```

3ã€ç¼–å†™ DrawRecordController

æ¨¡å—ï¼šlucky-adapter

åŒ…ï¼šcn.j3code.lucky.adapter.web

```java
@Slf4j
@AllArgsConstructor
@ResponseResult
@RequestMapping("/v1/drawRecord")
public class DrawRecordController {

    private final IDrawRecordService drawRecordService;

    @PostMapping("/list")
    public IPage<DrawRecordVO> list(@RequestBody DrawRecordListByParamQuery query) {
        query.setUserId(SecurityUtil.getUserId());
        return drawRecordService.list(query);
    }

}
```

4ã€ç¼–å†™ IDrawRecordService æ¥å£å®ç°ç±»

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.service

```java
@Slf4j
@Service
@AllArgsConstructor
public class DrawRecordServiceImpl implements IDrawRecordService {

    private final DrawRecordAddCmdExe drawRecordAddCmdExe;
    private final DrawRecordListByParamQueryExe drawRecordListByParamQueryExe;

    @Override
    public IPage<DrawRecordVO> list(DrawRecordListByParamQuery query) {
        return drawRecordListByParamQueryExe.execute(query);
    }

    @Override
    public DrawRecordVO add(DrawRecordAddCmd cmd) {
        return drawRecordAddCmdExe.execute(cmd);
    }
}
```

5ã€ç¼–å†™ç›¸å…³æ‰§è¡Œå™¨

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.drawrecord.command.query

```java
@Component
@Slf4j
@AllArgsConstructor
public class DrawRecordListByParamQueryExe {

    private final DrawRecordGateway drawRecordGateway;
    private final AwardGateway awardGateway;

    public IPage<DrawRecordVO> execute(DrawRecordListByParamQuery query){
        IPage<DrawRecordEntity> list = drawRecordGateway.list(query);
        list.getRecords().forEach(item -> item.setAwardEntity(awardGateway.getById(item.getAwardId())));
        return list.convert(DrawRecordAssembler::toValueObject);
    }


}
```

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.drawrecord.command

```java
@Component
@Slf4j
@AllArgsConstructor
public class DrawRecordAddCmdExe {

    private final DrawRecordGateway drawRecordGateway;

    public DrawRecordVO execute(DrawRecordAddCmd cmd) {
        DrawRecordEntity entity = drawRecordGateway.save(DrawRecordAssembler.toEntity(cmd));
        return DrawRecordAssembler.toValueObject(entity);
    }
}
```

6ã€ç¼–å†™ DrawRecordGateway æ¥å£

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.domain.gateway

```java
public interface DrawRecordGateway {

    IPage<DrawRecordEntity> list(DrawRecordListByParamQuery query);

    DrawRecordEntity save(DrawRecordEntity entity);

    void update(DrawRecordEntity toEntity);
}
```

7ã€ç¼–å†™ DrawRecordGateway æ¥å£å®ç°ç±»

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.domain.gateway

```java
@Slf4j
@AllArgsConstructor
@Component
public class DrawRecordGatewayImpl implements DrawRecordGateway {

    private final DrawRecordMapper drawRecordMapper;
    private final AwardMapper awardMapper;

    @Override
    public IPage<DrawRecordEntity> list(DrawRecordListByParamQuery query) {
        IPage<DrawRecordDO> iPage = drawRecordMapper.list(new Page<DrawRecordDO>(query.getPageIndex(), query.getPageSize()), query);
        return iPage.convert(DrawRecordConvertor::toEntity);
    }

    @Override
    public DrawRecordEntity save(DrawRecordEntity entity) {
        DrawRecordDO drawRecordDO = DrawRecordConvertor.toAddDO(entity);
        int insert = drawRecordMapper.insert(drawRecordDO);
        if (insert < 1) {
            throw new PersistenceException("æ‹†å…¥æ•°æ®å¼‚å¸¸");
        }
        return DrawRecordConvertor.toEntity(drawRecordDO);
    }

    @Override
    public void update(DrawRecordEntity entity) {
        DrawRecordDO drawRecordDO = DrawRecordConvertor.toUpdateDO(entity);
        int update = drawRecordMapper.updateById(drawRecordDO);
        if (update < 1) {
            throw new PersistenceException("æ›´æ–°æ•°æ®å¼‚å¸¸");
        }
    }
}
```

å¯¹è±¡è½¬æ¢

æ¨¡å—ï¼šlucky-infrastructure

åŒ…ï¼šcn.j3code.lucky.infrastructure.convertor

```java
public class DrawRecordConvertor {
    public static DrawRecordEntity toEntity(DrawRecordDO drawRecordDO) {
        DrawRecordEntity drawRecordEntity = new DrawRecordEntity();
        drawRecordEntity.setId(drawRecordDO.getId());
        drawRecordEntity.setActivityId(drawRecordDO.getActivityId());
        drawRecordEntity.setActivityName(drawRecordDO.getActivityName());
        drawRecordEntity.setUserId(drawRecordDO.getUserId());
        drawRecordEntity.setResults(drawRecordDO.getResults());
        drawRecordEntity.setAcceptPrize(drawRecordDO.getAcceptPrize());
        drawRecordEntity.setAwardId(drawRecordDO.getAwardId());
        drawRecordEntity.setUpdateTime(drawRecordDO.getUpdateTime());
        drawRecordEntity.setUpdater(drawRecordDO.getUpdater());

        return drawRecordEntity;
    }

    public static DrawRecordDO toAddDO(DrawRecordEntity entity) {
        DrawRecordDO drawRecordDO = new DrawRecordDO();
        drawRecordDO.setActivityId(entity.getActivityId());
        drawRecordDO.setUserId(entity.getUserId());
        drawRecordDO.setResults(entity.getResults());
        drawRecordDO.setAwardId(entity.getAwardId());
        drawRecordDO.setCreatTime(LocalDateTime.now());
        drawRecordDO.setCreator(SecurityUtil.getName());
        drawRecordDO.setUpdateTime(LocalDateTime.now());
        drawRecordDO.setUpdater(SecurityUtil.getName());

        return drawRecordDO;
    }

    public static DrawRecordDO toUpdateDO(DrawRecordEntity entity) {
        DrawRecordDO drawRecordDO = new DrawRecordDO();
        drawRecordDO.setId(entity.getId());
        drawRecordDO.setActivityId(entity.getActivityId());
        drawRecordDO.setUserId(entity.getUserId());
        drawRecordDO.setResults(entity.getResults());
        drawRecordDO.setAcceptPrize(entity.getAcceptPrize());
        drawRecordDO.setAwardId(entity.getAwardId());
        drawRecordDO.setUpdateTime(LocalDateTime.now());
        drawRecordDO.setUpdater(SecurityUtil.getName());

        return drawRecordDO;
    }
}
```

8ã€ç¼–å†™ DrawRecordMapper æ¥å£åŠ mapper æ–‡ä»¶

æ¨¡å—ï¼šlucky-infrastructure

åŒ…ï¼šcn.j3code.lucky.infrastructure.gateway.impl.database.mapper

```java
public interface DrawRecordMapper extends BaseMapper<DrawRecordDO> {

    IPage<DrawRecordDO> list(@Param("page") Page<DrawRecordDO> page, @Param("query") DrawRecordListByParamQuery query);

}
```

```xml
<select id="list"
        resultType="cn.j3code.lucky.infrastructure.gateway.impl.database.dataobject.DrawRecordDO">
    select
    a.*,
    a.is_accept_prize as accept_prize,
    b.activity_name
    from bld_lucky_draw_record a
    left join bld_lucky_activity b on a.activity_id = b.id
    <where>
        <if test="query.activityId != null">
            and a.activity_id = #{query.activityId}
        </if>
        <if test="query.activityName != null">
            and b.activity_name = #{query.activityName}
        </if>
        <if test="query.userId != null">
            and a.user_id = #{query.userId}
        </if>
        <if test="query.results != null">
            and a.results = #{query.results}
        </if>
    </where>
    order by a.results desc , a.update_time desc
</select>
```

## 10.10 æŠ½å¥–åŠŸèƒ½å¼€å‘

å…ˆæ¥ç®€å•çš„åˆ†æä¸€ä¸‹æŠ½å¥–éœ€è¦çš„æ­¥éª¤ï¼š

```
1ã€è·å–æ´»åŠ¨ä¿¡æ¯
2ã€æ´»åŠ¨å‰çš„æ ¡éªŒ
    1ã€æ´»åŠ¨æ—¶é—´
    2ã€æ´»åŠ¨è§„åˆ™
3ã€å¼€å§‹æŠ½å¥–
    1ã€æŠ½å¥–å‰çš„å‡†å¤‡ã€å‰”é™¤åº“å­˜æŠ½å…‰çš„å¥–å“
    2ã€æ•´åˆå¥–å“æ¦‚ç‡è¿›è¡ŒæŠ½å¥–
4ã€æŠ½å¥–æˆåŠŸåº“å­˜åŠè®°å½•å¤„ç†
	1ã€æ‰£å‡å¥–é¡¹ä¸­çš„å¥–å“æ•°é‡
	2ã€è®°å½•ç”¨æˆ·çš„æŠ½å¥–è®°å½•ï¼ˆä¸­å¥–ã€æœªä¸­å¥–ï¼‰
```

å¤§è‡´æµç¨‹

![](img/Snipaste_2022-11-16_14-18-24.png)

ä¸‹é¢å¼€å§‹ç¼–ç ï¼š

æ¨¡å—ï¼šlucky-adapter

åŒ…ï¼šcn.j3code.lucky.adapter.web

1ã€ç¼–å†™ ActivityController ç±»ä¸­çš„æŠ½å¥–æ–¹æ³•

```java
@Slf4j
@AllArgsConstructor
@ResponseResult
@RequestMapping("/v1/activity")
public class ActivityController {

    private final IActivityService activityService;

    @GetMapping("/draw")
    public DrawResults draw(@RequestParam("activityId") Long activityId){
        return activityService.draw(activityId);
    }
}
```

2ã€ç¼–å†™ IActivityService æ¥å£åŠå®ç°ç±»

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.api

```java
public interface IActivityService {

    DrawResults draw(Long activityId);
}
```

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.service

```java
@Slf4j
@Service
@AllArgsConstructor
public class ActivityServiceImpl implements IActivityService {

    private final ActivityListByParamQueryExe activityListByParamQueryExe;
    private final DrawExe drawExe;

    @Override
    public DrawResults draw(Long activityId) {
        log.info("ç”¨æˆ·ï¼š{}ï¼Œæ´»åŠ¨ï¼š{}ï¼Œå¼€å§‹æŠ½å¥–...", SecurityUtil.getUserId(), activityId);
        DrawResults draw = drawExe.draw(activityId);
        log.info("ç”¨æˆ·ï¼š{}ï¼Œæ´»åŠ¨ï¼š{}ï¼ŒæŠ½å¥–ç»“æœï¼š{}", SecurityUtil.getUserId(), activityId, JSON.toJSONString(draw));
        return draw;
    }
}
```

3ã€ç¼–å†™æŠ½å¥–æ‰§è¡Œå™¨

- DrawExeBaseï¼šæŠ½å¥–æ‰§è¡Œå™¨æ¨¡æ¿
- DrawExeï¼šå…·ä½“æŠ½å¥–æ‰§è¡Œå™¨

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.activity.command

```java
public abstract class DrawExeBase {

    public DrawResults draw(Long activityId) {
        // æ´»åŠ¨å‡†å¤‡
        List<AwardEntity> awardEntityList = drawPrepare(activityId);

        // å¼€å§‹æŠ½å¥–
        AwardEntity awardEntity = doDraw(awardEntityList);

        try {
            // æ‰£å‡åº“å­˜ï¼Œæ˜¯å¥–å“æ‰ä¼šå»æ‰£å‡åº“å­˜ï¼Œåƒè°¢è°¢å‚ä¸ä¹‹ç±»çš„ä¸ä¼šå»æ‰£å‡
            if (awardEntity.getNumber().isPrize()){
                updateAwardInventory(awardEntity.getId(), awardEntity.getNumber().getNumber(), -1);
            }

            // æ’å…¥è®°å½•
            insertAcceptRecord(List.of(awardEntity), null);
        } catch (Exception e) {
            //throw new BldBizException(ErrorCode.ACTIVITY_NOT_STAET);
            // å¤±è´¥ï¼Œç»™ä¸€ä¸ªæœªä¸­å¥–çš„å¥–é¡¹å‡ºå»
            awardEntity = insertAcceptRecord(awardEntityList, 0);
        }

        return ActivityAssembler.toDrawResult(awardEntity);
    }

    protected abstract AwardEntity insertAcceptRecord(List<AwardEntity> awardEntityList, Integer results);

    protected abstract void updateAwardInventory(Long id, Integer number, int value);

    protected abstract AwardEntity doDraw(List<AwardEntity> awardEntityList);

    protected abstract List<AwardEntity> drawPrepare(Long activityId);
}
```

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.activity.command

```java
@Component
@Slf4j
@AllArgsConstructor
public class DrawExe extends DrawExeBase {

    private final ActivityGateway activityGateway;
    private final ActivityRulesGateway activityRulesGateway;
    private final DrawRecordGateway drawRecordGateway;
    private final AwardGateway awardGateway;


    @Override
    protected AwardEntity insertAcceptRecord(List<AwardEntity> awardEntityList, Integer results) {
        AwardEntity insertEntity = null;
        if (Objects.isNull(results)) {
            // æŠ½å¥–æˆåŠŸï¼Œresults ä»å¥–é¡¹ä¸­è·å–
            insertEntity = awardEntityList.get(0);
            results = insertEntity.getNumber().isPrize() ? 1 : 0;
            drawRecordGateway.save(DrawRecordAssembler.toEntity(insertEntity, results));
            return insertEntity;
        }
        // æŠ½å¥–å¤±è´¥ï¼Œç›´æ¥è·å–è°¢è°¢å‚ä¸ä¹‹ç±»çš„å¥–é¡¹
        insertEntity = awardEntityList.stream()
                .filter(item -> !item.getNumber().isPrize()).collect(Collectors.toList()).get(0);

        drawRecordGateway.save(DrawRecordAssembler.toEntity(insertEntity, results));
        return insertEntity;
    }

    @Override
    protected void updateAwardInventory(Long id, Integer number, int value) {
        int update = awardGateway.updateAwardInventory(id, number, value);
        if (update < 1) {
            throw new BldBizException(ErrorCode.DRAW_ERROR);
        }
    }

    @Override
    protected AwardEntity doDraw(List<AwardEntity> awardEntityList) {

        // å‰”é™¤å¥–å“åº“å­˜ä¸º 0 çš„å¥–é¡¹
        List<AwardEntity> effectiveAwardList = awardEntityList.stream()
                .filter(item -> item.getNumber().isEffective()).collect(Collectors.toList());

        if (effectiveAwardList.size() == 1) {
            return effectiveAwardList.get(0);
        }

        List<WeightRandom.WeightObj<AwardEntity>> weightList = new ArrayList<>();
        effectiveAwardList.forEach(item -> weightList.add(new WeightRandom.WeightObj<>(item, item.getProbability())));
        //åˆ›å»ºå¸¦æœ‰æƒé‡çš„éšæœºç”Ÿæˆå™¨
        WeightRandom<AwardEntity> wr = RandomUtil.weightRandom(weightList);

        return wr.next();
    }

    @Override
    protected List<AwardEntity> drawPrepare(Long activityId) {
        // æ ¡éªŒæ´»åŠ¨æ—¶é—´
        ActivityEntity activityEntity = activityGateway.getById(activityId);

        if (!ActivityStatusEnum.START.equals(activityEntity.getStatus())) {
            throw new BldBizException(ErrorCode.ACTIVITY_NOT_STAET);
        }

        // æ ¡éªŒæ´»åŠ¨è§„åˆ™
        ActivityRulesEntity activityRules = activityRulesGateway.getByActivityId(activityId);

        final var query = new DrawRecordListByParamQuery();
        query.setActivityId(activityId);
        query.setPageSize(100);
        query.setUserId(SecurityUtil.getUserId());
        final var recordEntityList = drawRecordGateway.list(query).getRecords();

        if (activityRules.getActivityJoinNumber().getNumber() <= recordEntityList.size()) {
            throw new BldBizException(ErrorCode.ACTIVITY_NOT_JOIN);
        }

        long winningNumber = recordEntityList.stream().filter(item -> item.getResults() == 1).count();
        if (activityRules.getMaxWinningNumber().getNumber() <= winningNumber) {
            throw new BldBizException(ErrorCode.ACTIVITY_MAX_WINNING_NOT_JOIN);
        }

        // è¿”å›æ´»åŠ¨å¥–å“
        final var awardQuery = new AwardListByParamQuery();
        awardQuery.setActivityId(activityId);
        awardQuery.setPageSize(100);
        return awardGateway.list(awardQuery).getRecords();
    }
}
```

## 10.11 ç”¨æˆ·é¢†å¥–ç›¸å…³åŠŸèƒ½å¼€å‘

ç”¨æˆ·æŠ½å¥–è¿‡ç¨‹ä¸­ï¼Œå¦‚æœä¸­å¥–äº†åˆ™éœ€è¦å¡«å†™ç›¸å…³ä¿¡æ¯è¿›è¡Œé¢†å–å¥–å“ã€‚

é¢†å–æµç¨‹ï¼š

1. ç”¨æˆ·å¡«å†™ç›¸å…³ä¿¡æ¯å¹¶æäº¤
2. è¿è¥äººå‘˜åå°å®¡æ ¸é€šè¿‡
3. ç”¨æˆ·æ”¶è´§åç‚¹å‡»å®Œæˆé¢†å¥–ï¼Œåˆ™æ•´ä¸ªæµç¨‹æ‰§è¡Œå®Œæ¯•

å¯¹åº”çš„åŠŸèƒ½æœ‰ï¼š

1ã€æ·»åŠ 

2ã€ä¿®æ”¹

3ã€æŸ¥è¯¢

æ¥ä¸‹æ¥å°±å¼€å§‹ç¼–ç å§ï¼

1ã€ç¼–å†™è§†å›¾å®ä½“

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.dto.data

```java
@Data
public class AcceptRecordVO {
    private Long id;

    /**
     * æŠ½å¥–è®°å½•id
     */
    private Long drawRecordId;

    /**
     * åœ°å€
     */
    private String address;

    /**
     * ç”µè¯
     */
    private String phone;

    /**
     * çŠ¶æ€
     */
    private Integer state;


    /**
     *
     */
    private LocalDateTime updateTime;

    /**
     *
     */
    private String updater;
}
```

2ã€ç¼–å†™å®ä½“

æ¨¡å—ï¼šlucky-infrastructure

åŒ…ï¼šcn.j3code.lucky.infrastructure.gateway.impl.database.dataobject

```java
@TableName(value ="bld_lucky_accept_record")
@Data
public class AcceptRecordDO implements Serializable {
    /**
     * 
     */
    @TableId(type = IdType.AUTO)
    private Long id;

    /**
     * æŠ½å¥–è®°å½•id
     */
    private Long drawRecordId;

    /**
     * åœ°å€
     */
    private String address;

    /**
     * ç”µè¯
     */
    private String phone;

    /**
     * çŠ¶æ€
     */
    private Integer state;

    /**
     * 
     */
    private LocalDateTime creatTime;

    /**
     * 
     */
    private String creator;

    /**
     * 
     */
    private LocalDateTime updateTime;

    /**
     * 
     */
    private String updater;

    @TableField(exist = false)
    private static final long serialVersionUID = 1L;
}
```

3ã€ç¼–å†™é¢†åŸŸå¯¹è±¡

æ¨¡å—ï¼šlucky-domain

åŒ…ï¼šcn.j3code.lucky.domain.acceptrecord

```java
@Data
public class AcceptRecordEntity {
    /**
     *
     */
    private Long id;

    /**
     * æŠ½å¥–è®°å½•id
     */
    private Long drawRecordId;

    /**
     * åœ°å€
     */
    private String address;

    /**
     * ç”µè¯
     */
    private String phone;

    /**
     * çŠ¶æ€
     */
    private AcceptRecordState state;


    /**
     *
     */
    private LocalDateTime updateTime;

    /**
     *
     */
    private String updater;
}
```

ç¼–å†™å€¼å¯¹è±¡

æ¨¡å—ï¼šlucky-domain

åŒ…ï¼šcn.j3code.lucky.domain.acceptrecord

```java
@Getter
public enum AcceptRecordEnum {
    NTO_START(1,"å¾…ç¡®è®¤"),

    START(2,"è¿›è¡Œä¸­"),

    END(3,"ç»“æŸ"),

    ;


    private Integer value;
    private String description;

    AcceptRecordEnum(Integer value, String description) {
        this.value = value;
        this.description = description;
    }
}
```

```java
public class AcceptRecordState {

    private AcceptRecordEnum state;

    public AcceptRecordState(Integer state) {
        
        for (AcceptRecordEnum acceptRecordEnum : AcceptRecordEnum.values()) {
            if (acceptRecordEnum.getValue().equals(state)) {
                this.state = acceptRecordEnum;
            }
        }
        if (Objects.isNull(this.state)) {
            throw new ValidationException("çŠ¶æ€ä¸èƒ½ä¸ºç©ºæˆ–æ— æ•ˆï¼");
        }
    }

    public Integer getState() {
        return state.getValue();
    }

}
```

### 10.11.1 ç¼–å†™é¢†å¥–åŠŸèƒ½

1ã€ç¼–å†™ IAcceptRecordService æ¥å£

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.api

```java
public interface IAcceptRecordService {

    IPage<AcceptRecordVO> list(AcceptRecordListByParamQuery query);

    AcceptRecordVO add(AcceptRecordAddCmd cmd);

    AcceptRecordVO update(AcceptRecordModifyCmd cmd);

}
```

2ã€ç¼–å†™ cmd åŠ query

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.dto

```java
@Data
public class AcceptRecordAddCmd extends Command {
    /**
     * æŠ½å¥–è®°å½•id
     */
    private Long drawRecordId;

    /**
     * åœ°å€
     */
    private String address;

    /**
     * ç”µè¯
     */
    private String phone;
}
```

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.dto

```java
@Data
public class AcceptRecordModifyCmd extends Command {

    private Long id;

    private Integer state;

}
```

æ¨¡å—ï¼šlucky-client

åŒ…ï¼šcn.j3code.lucky.client.dto.query

```java
@Data
@Accessors(chain = true)
public class AcceptRecordListByParamQuery extends PageQuery {

    private Long activityId;

    private Long drawRecordId;

    private Long userId;

    private Integer state;

}
```

3ã€ç¼–å†™ AcceptRecordController

æ¨¡å—ï¼šlucky-adapter

åŒ…ï¼šcn.j3code.lucky.adapter.web

```java
@Slf4j
@AllArgsConstructor
@ResponseResult
@RequestMapping("/v1/acceptRecord")
public class AcceptRecordController {

    private final IAcceptRecordService acceptRecordService;

    @PostMapping("/list")
    public IPage<AcceptRecordVO> list(@RequestBody AcceptRecordListByParamQuery query){
        query.setUserId(SecurityUtil.getUserId());
        return acceptRecordService.list(query);
    }

    @GetMapping("/one")
    public AcceptRecordVO one(@RequestParam("drawRecordId") Long drawRecordId){
        return acceptRecordService
                .list(new AcceptRecordListByParamQuery().setUserId(SecurityUtil.getUserId()).setDrawRecordId(drawRecordId))
                .getRecords().get(0)
                ;
    }

    @PostMapping("/add")
    public AcceptRecordVO add(@RequestBody AcceptRecordAddCmd cmd){
        return acceptRecordService.add(cmd);
    }


    @PostMapping("/update")
    public AcceptRecordVO update(@RequestBody AcceptRecordModifyCmd cmd){
        return acceptRecordService.update(cmd);
    }

}
```

4ã€ç¼–å†™ IAcceptRecordService æ¥å£å®ç°ç±»

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.service

```java
@Slf4j
@Service
@AllArgsConstructor
public class AcceptRecordServiceImpl implements IAcceptRecordService {

    private final AcceptRecordListByParamQueryExe acceptRecordListByParamQueryExe;
    private final AcceptRecordAddCmdExe acceptRecordAddCmdExe;
    private final AcceptRecordModifyCmdExe acceptRecordModifyCmdExe;

    private final DrawRecordModifyCmdExe drawRecordModifyCmdExe;


    @Override
    public IPage<AcceptRecordVO> list(AcceptRecordListByParamQuery query) {
        return acceptRecordListByParamQueryExe.execute(query);
    }

    @Transactional
    @Override
    public AcceptRecordVO add(AcceptRecordAddCmd cmd) {
        AcceptRecordVO acceptRecordVO = acceptRecordAddCmdExe.execute(cmd);
        drawRecordModifyCmdExe.execute(new DrawRecordModifyCmd().setAcceptPrize(true).setId(acceptRecordVO.getDrawRecordId()));
        return acceptRecordVO;
    }

    @Override
    public AcceptRecordVO update(AcceptRecordModifyCmd cmd) {
        return acceptRecordModifyCmdExe.execute(cmd);
    }
}
```

5ã€ç¼–å†™ç›¸å…³æ‰§è¡Œå™¨

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.acceptrecord.command.query

```java
@Component
@Slf4j
@AllArgsConstructor
public class AcceptRecordListByParamQueryExe {
    private final AcceptRecordGateway acceptRecordGateway;

    public IPage<AcceptRecordVO> execute(AcceptRecordListByParamQuery query) {
        IPage<AcceptRecordEntity> page = acceptRecordGateway.list(query);
        return page.convert(AcceptRecordAssembler::toValueObject);
    }
}
```

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.acceptrecord.command

```java
@Component
@Slf4j
@AllArgsConstructor
public class AcceptRecordAddCmdExe {

    private final AcceptRecordGateway acceptRecordGateway;

    public AcceptRecordVO execute(AcceptRecordAddCmd cmd) {
        AcceptRecordEntity entity = acceptRecordGateway.save(AcceptRecordAssembler.toEntity(cmd));
        return AcceptRecordAssembler.toValueObject(entity);
    }
}
```

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.app.acceptrecord.command

```java
@Component
@Slf4j
@AllArgsConstructor
public class AcceptRecordModifyCmdExe {
    private final AcceptRecordGateway acceptRecordGateway;

    public AcceptRecordVO execute(AcceptRecordModifyCmd cmd) {
        AcceptRecordEntity entity = acceptRecordGateway.save(AcceptRecordAssembler.toEntity(cmd));
        return AcceptRecordAssembler.toValueObject(entity);
    }
}
```

6ã€ç¼–å†™ AcceptRecordGateway æ¥å£

æ¨¡å—ï¼šlucky-app

åŒ…ï¼šcn.j3code.lucky.domain.gateway

```java
public interface AcceptRecordGateway {


    AcceptRecordEntity save(AcceptRecordEntity entity);

    IPage<AcceptRecordEntity> list(AcceptRecordListByParamQuery query);
}
```

7ã€ç¼–å†™ AcceptRecordGateway æ¥å£å®ç°ç±»

æ¨¡å—ï¼šlucky-infrastructure

åŒ…ï¼šcn.j3code.lucky.infrastructure.gateway.impl

```java
@Slf4j
@AllArgsConstructor
@Component
public class AcceptRecordGatewayImpl implements AcceptRecordGateway {

    private final AcceptRecordMapper acceptRecordMapper;


    @Override
    public AcceptRecordEntity save(AcceptRecordEntity entity) {
        // æ–°å¢
        if (Objects.isNull(entity.getId())) {
            return add(entity);
        }

        // ä¿®æ”¹
        return modify(entity);
    }

    private AcceptRecordEntity modify(AcceptRecordEntity entity) {
        AcceptRecordDO acceptRecordDO = AcceptRecordConvertor.toModifyDO(entity);
        int update = acceptRecordMapper.updateById(acceptRecordDO);
        if (update < 1) {
            throw new PersistenceException("æ›´æ–°æ•°æ®å¼‚å¸¸");
        }
        return AcceptRecordConvertor.toEntity(acceptRecordDO);
    }

    private AcceptRecordEntity add(AcceptRecordEntity entity) {
        AcceptRecordDO acceptRecordDO = AcceptRecordConvertor.toAddDO(entity);
        int insert = acceptRecordMapper.insert(acceptRecordDO);
        if (insert < 1) {
            throw new PersistenceException("æ’å…¥æ•°æ®å¼‚å¸¸");
        }
        return AcceptRecordConvertor.toEntity(acceptRecordDO);
    }

    @Override
    public IPage<AcceptRecordEntity> list(AcceptRecordListByParamQuery query) {
        IPage<AcceptRecordDO> page = acceptRecordMapper.list(new Page<AcceptRecordDO>(query.getPageIndex(), query.getPageSize()), query);
        return page.convert(AcceptRecordConvertor::toEntity);
    }
}
```

8ã€ç¼–å†™ AcceptRecordMapper æ¥å£åŠ mapper æ–‡ä»¶

æ¨¡å—ï¼šlucky-infrastructure

åŒ…ï¼šcn.j3code.lucky.infrastructure.gateway.impl.database.mapper

```java
public interface AcceptRecordMapper extends BaseMapper<AcceptRecordDO> {

    IPage<AcceptRecordDO> list(@Param("acceptRecordDOPage") Page<AcceptRecordDO> acceptRecordDOPage, @Param("query") AcceptRecordListByParamQuery query);

}
```

```xml
<select id="list"
        resultType="cn.j3code.lucky.infrastructure.gateway.impl.database.dataobject.AcceptRecordDO">
    SELECT
    a.*
    FROM bld_lucky_accept_record a
    LEFT JOIN bld_lucky_draw_record b on b.id = a.draw_record_id
    <where>
        <if test="query.activityId">
            and b.activity_id = #{query.activityId}
        </if>
        <if test="query.userId">
            and b.user_id = #{query.userId}
        </if>
        <if test="query.state">
            and a.state = #{query.state}
        </if>
    </where>
    order by a.update_time desc
</select>
```

# æ¥å£æ–‡æ¡£

é“¾æ¥: https://www.apifox.cn/apidoc/shared-ac95096a-8e44-4bdf-8eea-c3272100e317  

è®¿é—®å¯†ç : 3bce4zx7

# å‰ç«¯

```txt
vue-cli@2.9.6

node.jsï¼Œç‰ˆæœ¬ï¼š10-14

1ã€npm install vue-cli@2.9.6
2ã€npm config set chromedriver_cdnurl https://npm.taobao.org/mirrors/chromedriver
3ã€vue init webpack
4ã€npm install
5ã€npm run dev

npm install axios --save
npm install --save vue-cookies

import VueCookie from 'vue-cookie'
Vue.use(VueCookie) // æŒ‚åœ¨åœ¨å…¨å±€äº†
```

é¡µé¢æ¨¡æ¿

```vue
<template>
  <div class="app-container">
    <!--æ ‡ç­¾-->
  </div>
</template>

<script>
// import request from '@/utils/request'
export default {
  data() {
    return {
      // æ•°æ®ä¸­å¿ƒ
    }
  },
  // ç»„ä»¶
  computed: {

  },
  // é¡µé¢æ¸²æŸ“æˆåŠŸåè·å–æ•°æ®
  created() {

  },
  // è‡ªå®šä¹‰æ–¹æ³•
  methods: {

  }
}
</script>

<style scoped>

</style>
```

# èµ„æ–™æ‰©å±•

> [ä¸€æ–‡å½»åº•ææ‡‚åŠ å¯†ã€æ•°å­—ç­¾åå’Œæ•°å­—è¯ä¹¦ï¼](https://segmentfault.com/a/1190000024523772)
>
> JWT
>
> https://jwt.io/
>
> https://github.com/auth0/java-jwt
>
> [SpringBoot å¿«é€Ÿé›†æˆ JWT å®ç°ç”¨æˆ·ç™»å½•è®¤è¯](https://blog.csdn.net/CSDN2497242041/article/details/115605626)
>
> [åˆ«å†ä½¿ç”¨ JWT ä½œä¸º Session ç³»ç»Ÿï¼é—®é¢˜é‡é‡ä¸”å¾ˆå±é™©](https://mp.weixin.qq.com/s/jYZdJV85nw0WePA3Z32kdA)
>
> [Base64è§£å¯†](https://www.sojson.com/base64.html)
>
> jasypt
>
> [Springbootä¹‹Jasypté…ç½®æ–‡ä»¶åŠ å¯†/è§£å¯†](https://huaweicloud.csdn.net/63356631d3efff3090b5596f.html)
>
> [Springbooté…ç½®æ–‡ä»¶åŠ å¯†è§£å¯†-Jasypt](https://blog.csdn.net/HLH_2021/article/details/119854365)
>
> DDD
>
> [é¢†åŸŸé©±åŠ¨è®¾è®¡åœ¨äº’è”ç½‘ä¸šåŠ¡å¼€å‘ä¸­çš„å®è·µ](https://tech.meituan.com/2017/12/22/ddd-in-practice.html)
>
> https://github.com/bellmit/smart-lottery/blob/main/README.md
>
> COLA
>
> [COLAæ¶æ„](https://github.com/alibaba/COLA)
>
> [COLA 4.0ï¼šåº”ç”¨æ¶æ„çš„æœ€ä½³å®è·µ](https://blog.csdn.net/significantfrank/article/details/110934799)
>
> gateway
>
> [å®æˆ˜ Spring Cloud Gateway ä¹‹é™æµç¯‡](https://www.aneasystone.com/archives/2020/08/spring-cloud-gateway-current-limiting.html)
>
> [springcloud-gatewayå…¨å±€è¿‡æ»¤ã€é™æµä¸ç†”æ–­](https://blog.csdn.net/yorao4565/article/details/113865739)
>
> [banner å›¾æ¡ˆç”Ÿæˆç½‘ç«™](http://network-science.de/ascii/)
>
> redis
>
> [ç¼–ç æŠ€å·§â€”â€”Luaè„šæœ¬çš„åº”ç”¨åŠåº“å­˜æ‰£å‡åœºæ™¯åº”ç”¨](https://blog.csdn.net/minghao0508/article/details/123972780)
>
> [Rediså®ç°åˆ†å¸ƒå¼é”çš„å…­ç§æ–¹å¼ã€‚æœ€ä½³å®è·µï¼šåŸå­æ€§è·å–é”+LUAè„šæœ¬é‡Šæ”¾é”](https://blog.csdn.net/weixin_43989347/article/details/125315482)
>
> æŠ½å¥–ç³»ç»Ÿæµç¨‹å›¾
>
> åŠŸèƒ½è‰å›¾ï¼šhttps://gitmind.cn/app/docs/fp323h28
>
> ç³»ç»Ÿæ¶æ„å›¾ï¼šhttps://gitmind.cn/app/docs/fvjpmtrn
>
> åˆ†å¸ƒå¼é”ï¼šhttps://gitmind.cn/app/docs/fl372k6g











# æŠ½å¥–æµç¨‹æµ‹è¯•ï¼Œç®€å•åˆ†å¸ƒå¼é”å®ç°ï¼Œ









# æµ‹è¯•æ–°ä¹°æ‘„åƒå¤´ï¼Œæ¨æµæ˜¯å¦å¡é¡¿



JDK11ã€SpringBoot2.5ã€SpringCloudã€Redisã€RocketMQã€MySQLã€Nacosã€Hutoolã€lombokã€mapstructã€jasyptã€jwtã€COLA



åº”å±Šç”Ÿã€1å¹´ç¤¾æ‹›éƒ½æ˜¯æ²¡é—®é¢˜

ï¼ˆå¥–å“ã€å¥–é¡¹ï¼‰åº“å­˜ä¸€è‡´çš„æ–¹æ¡ˆå®ç°

Redis + Lua å®ç°æ‰£å‡åº“å­˜

RocketMQé›†ç¾¤ä½¿ç”¨

åˆ†å¸ƒå¼é”æ§åˆ¶å®šæ—¶ä»»åŠ¡çš„æ‰§è¡Œ

ç½‘å…³ç»Ÿä¸€é™æµçš„æ–¹æ¡ˆå®ç°

JWT + ç½‘å…³ç»Ÿä¸€è®¤è¯

Figenè°ƒç”¨ + è´Ÿè½½å‡è¡¡





RocketMQå‘é€æ¶ˆæ¯æ˜¯ï¼Œä¿è¯ä½ çš„æ¶ˆæ¯èƒ½å¤Ÿé€è¾¾MQï¼Œä¸ä¿è¯åªæœ‰ä¸€æ¡



66













